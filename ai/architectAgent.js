// ai/architectAgent.js

import { Agent } from './Agent.js';
import { BACKEND_SAFE_PASS_PROMPT } from './prompt_templates.js';
import { repairAndParseJson } from '../utils/jsonRepair.js';
import { deepmerge } from '../utils/deepmerge.js';


// ã€è¯•éªŒé˜¶æ®µã€‘æˆ˜æœ¯æ¨¡å—ï¼šABCæƒ…æ„Ÿæ²‰æµ¸æµï¼ˆæŒ‰éœ€æ³¨å…¥ï¼‰
const IMMERSION_MODE_PROMPT = `
## **é™„åŠ æ¨¡å—ï¼šæƒ…æ„Ÿæ²‰æµ¸æµ (ABC Immersion Flow - Unique Design)**
---
**ã€ã€ã€ æˆ˜æœ¯å·²æ¿€æ´»ï¼šå¯åŠ¨"é«˜ç»´æƒ…æ„Ÿè®¾è®¡"ç®—æ³• ã€‘ã€‘ã€‘**
**æ ¸å¿ƒç›®æ ‡:** æ‹’ç»é€šç”¨æ¨¡æ¿ã€‚æœ¬ç« çš„æ—¥å¸¸äº’åŠ¨å¿…é¡»æ˜¯**"åªæœ‰è¿™å‡ ä¸ªäººç‰©"**åœ¨**"åªæœ‰è¿™ä¸ªç‰¹å®šæ—¶åˆ»"**æ‰èƒ½å‘ç”Ÿçš„**å”¯ä¸€è§£**ã€‚

**1. ç»“æ„æ³•åˆ™ (The ABC Structure)**
*   **Phase A (å‰50%):** **ç°å®æ²‰æµ¸**ã€‚åˆ©ç”¨é«˜è‡ªç”±åº¦ç©ºé—´å»ºç«‹æå…·çœŸå®æ„Ÿçš„ç¯å¢ƒåŸºè°ƒã€‚å…è®¸"æ— æ•ˆ"ä½†"æœ‰è¶£"çš„åºŸè¯ï¼Œåªè¦å®ƒç¬¦åˆäººè®¾ã€‚
*   **Phase B (ä¸­25%):** **ç‹¬å®¶å˜è°ƒ**ã€‚è®¾è®¡ä¸€ä¸ªä¸å¯æ›¿ä»£çš„è½¬æŠ˜ç‚¹ã€‚
*   **Phase C (å25%):** **æ¶Ÿæ¼ªç€é™†**ã€‚æƒ…æ„Ÿæ­éœ²åï¼Œç”¨"å¿ƒç…§ä¸å®£çš„é»˜å¥‘"æˆ–"æ–°çš„å¹³è¡¡"æ”¶å°¾ï¼Œç¦æ­¢çŒåœã€‚

**2. çµæ„Ÿç´ æåº“ (Reference Library - For Inspiration Only)**
*å‚è€ƒä»¥ä¸‹ç­–ç•¥å¯»æ‰¾åˆ‡å…¥ç‚¹ï¼Œä½†å¿…é¡»ç»“åˆäººç‰©å…³ç³»è¿›è¡Œç‹¬å®¶å®šåˆ¶ï¼š*
*   **[ä»·å€¼é‡ä¼°]:** å¼•å…¥æ—§ç‰©/ä¹ æƒ¯ï¼Œé€šè¿‡"ä¸–ä¿—ä»·å€¼"ä¸"æƒ…æ„Ÿä»·å€¼"çš„åå·®åˆ¶é€ å†²å‡»ï¼ˆå¦‚ï¼šå¤©ä»·å¡ç‰‡ä¸å–ï¼‰ã€‚
*   **[æŠ•å°„åšå¼ˆ]:** å€Ÿç”±è¯„ä»·ç¬¬ä¸‰æ–¹äº‹ç‰©ï¼ˆç”µå½±/è·¯äººï¼‰ï¼Œå½±å°„è‡ªèº«å…³ç³»çš„å›°å¢ƒæˆ–ç¾ç»Šï¼ˆå¦‚ï¼šåæ§½ç”µå½±ç”·ä¸»ï¼‰ã€‚
*   **[æŠ€èƒ½ç ´ç»½]:** è§’è‰²åœ¨æ“…é•¿é¢†åŸŸå‡ºç°åå¸¸å¤±è¯¯ï¼ˆæ‰‹æŠ–/èµ°ç¥ï¼‰ï¼Œæ­ç¤ºå› è¿‡äºåœ¨ä¹è€Œä¹±äº†å¿ƒç¥ã€‚
*   **[ç‰©ç†å…¥ä¾µ]:** ç¯å¢ƒçªå˜ï¼ˆåœç”µ/æš´é›¨ï¼‰å¼ºè¿«ç‰©ç†è·ç¦»æ‹‰è¿‘ï¼Œå¯¼è‡´å¿ƒç†é˜²å¾¡å´©å¡Œã€‚
*   **[æ¸¸æˆè¶Šç•Œ]:** ç©ç¬‘/æ‰“èµŒé€æ¸è¿‡ç«ï¼Œå€Ÿç€æ¸¸æˆè§„åˆ™çš„æ©æŠ¤è¯´å‡ºä¸æ•¢è¯´çš„çœŸå¿ƒè¯ã€‚
*   **[æ—¶é—´é”™ä½]:** æåŠè¿‡å»çš„çº¦å®šä¸ç°çŠ¶çš„åå·®ï¼Œå¼•å‘é—æ†¾æˆ–åº†å¹¸çš„å…±é¸£ã€‚

**3. è®¾è®¡é“å¾‹ (Design Rules)**
*   **å”¯ä¸€æ€§æ£€æŸ¥:** å¦‚æœæŠŠè§’è‰²æ¢æˆå…¶ä»–äººï¼Œè¿™ä¸ªäº’åŠ¨æ˜¯å¦è¿˜æˆç«‹ï¼Ÿå¦‚æœæˆç«‹ï¼Œ**ç«‹å³é‡å†™**ã€‚
*   **é€»è¾‘å†…æ°:** å˜è°ƒå¥‘æœºä¸èƒ½æ˜¯æœºæ¢°çš„æ„å¤–ï¼Œå¿…é¡»æºäº**è§’è‰²æ€§æ ¼ä¸å½“å‰ç¯å¢ƒçš„åŒ–å­¦ååº”**ã€‚

---
**ã€å¼ºåˆ¶è¾“å‡ºè¦æ±‚ï¼šè®¾è®¡é€»è¾‘è‡ªè¾©ã€‘**
åœ¨ \`design_notes\` ä¸­**å¿…é¡»**æ–°å¢ \`elevation_design_logic\` å­—æ®µï¼Œä½ å¿…é¡»åƒå¯¼æ¼”é˜è¿°åˆ†é•œä¸€æ ·ï¼Œè§£é‡Šä½ çš„è®¾è®¡æ€è·¯ï¼š

\`\`\`json
"elevation_design_logic": {
  "reference_strategy": "[å‚è€ƒäº†ç´ æåº“ä¸­çš„å“ªä¸ªç­–ç•¥ï¼Ÿæˆ–è€…è‡ªåˆ›ç­–ç•¥ï¼Ÿ]",
  "unique_spark": "[ä¸€å¥è¯æè¿°ä½ è®¾è®¡çš„æ ¸å¿ƒåˆ›æ„ç‚¹ã€‚ä¾‹å¦‚ï¼š'ä¸æ˜¯ç”µå½±çƒ‚ï¼Œè€Œæ˜¯ç”µå½±æƒ…èŠ‚è¯¯ä¼¤äº†Açš„ç§˜å¯†']",
  "irreplaceability_defense": "[è‡ªè¿°é€»è¾‘ï¼šä¸ºä»€ä¹ˆè¿™ä¸ªæƒ…èŠ‚åªèƒ½å‘ç”Ÿåœ¨æ­¤æ—¶æ­¤åœ°ï¼Ÿä¾‹å¦‚ï¼š'æ™®é€šäººçœ‹çƒ‚ç‰‡åªæ˜¯åæ§½ï¼Œä½†åªæœ‰Aä¼šå› ä¸ºé‚£ä¸ªæƒ…èŠ‚è”æƒ³åˆ°å½“åˆçš„é‚£ä¸ªçº¦å®šï¼Œè¿™æ˜¯å±äºä»–ä»¬ä¸¤äººçš„ç‹¬å®¶å¯†ç ã€‚']",
  "pacing_allocation": {
    "phase_A_content": "[èŠ‚æ‹1-X: å…·ä½“çš„æ—¥å¸¸å¡«å……ç‰©]",
    "phase_B_bridge": "[èŠ‚æ‹X-Y: å…·ä½“çš„å˜è°ƒå¥‘æœºä¸é€»è¾‘é“¾]",
    "phase_C_landing": "[èŠ‚æ‹Y-End: æƒ…æ„Ÿè½åœ°çš„å…·ä½“ç”»é¢]"
  }
}
\`\`\`
`;

// V7.0 ç­–ç•¥æ¨¡å—ï¼šç½‘æ–‡æ¨¡å¼ï¼ˆæŒ‰éœ€æ³¨å…¥ï¼‰
const WEB_NOVEL_STRATEGY_PROMPT = `
### **ã€ å™äº‹ç­–ç•¥ï¼šğŸ”¥ ç½‘æ–‡æ¨¡å¼ (Web Novel)ã€‘**
**èº«ä»½åˆ‡æ¢:** ä½ æ˜¯é¦–å¸­"å¤šå·´èƒºå·¥ç¨‹å¸ˆ"ã€‚ä½ çš„ä»»åŠ¡æ˜¯è®¾è®¡å¿«æ„Ÿï¼Œä½†å¿…é¡»æ‹’ç»å»‰ä»·çš„é€šç”¨æ¨¡æ¿ã€‚
**æ ¸å¿ƒå…¬ç†:** **æ²¡æœ‰çˆ½ç‚¹çš„ç« èŠ‚æ˜¯åƒåœ¾ï¼Œä½†åªæœ‰å¥—è·¯çš„ç« èŠ‚æ˜¯åº¸ä¿—ã€‚**

**1. çˆ½ç‚¹æ„å»ºå››å¤§æ³•åˆ™ (The 4 Pillars)**
*   **é¢„æœŸå·®:** é“ºå«NPCçš„è½»è§†/ç»æœ›(å‹æŠ‘) -> ä¸»è§’å±•ç¤ºè¶…å¸¸åŠ›é‡(çˆ†å‘) -> NPCéœ‡æƒŠ/æ‰“è„¸(åé¦ˆ)ã€‚
*   **å³æ—¶åé¦ˆ:** ä»˜å‡ºå¿…é¡»å½“åœºå…‘ç°ã€‚è·å¾—é“å…·=å½“åœºä½¿ç”¨ï¼›æ•‘äºº=å½“åœºè·èµ é‡å®/æƒ…æŠ¥ã€‚**ç¦æ­¢å»¶è¿Ÿæ»¡è¶³ã€‚**
*   **ç‰¹æƒæ„Ÿ:** å¼ºè°ƒ"åªæœ‰ä¸»è§’èƒ½åšåˆ°"ã€‚ç¥å…½åªäº²è¿‘ä»–ï¼Œç¥å™¨åªè®¤ä¸»ä»–ã€‚
*   **å±æœºå³æœºé‡:** æ•Œäºº=å¿«é€’å‘˜ï¼Œå›°å¢ƒ=å±•ç¤ºèˆå°ã€‚åƒç˜ªå¿…é¡»å½“åœºæ‰¾å›åœºå­ã€‚

**2. åˆ›æ–°æ‰§è¡Œåè®® (Creative Execution Protocol)**
*   **æ‹’ç»é€šç”¨è§£:** å¦‚æœä½ çš„æ‰“è„¸æ–¹å¼æ˜¯â€œç›´æ¥ä¸€æ‹³æ‰“é£â€æˆ–â€œæ‹¿å‡ºæ›´è´µçš„å®ç‰©â€ï¼Œ**é‡å†™ï¼**
*   **ç»‘å®šä¸–ç•Œè§‚:** çˆ½ç‚¹å¿…é¡»åˆ©ç”¨**å½“å‰ç‹¬æœ‰çš„è®¾å®š**ï¼ˆå¦‚ï¼šè§’è‰²çš„ç‰¹æ®ŠæŠ€èƒ½ã€æ•Œäººçš„å…·ä½“å¼±ç‚¹ã€åœºæ™¯çš„ç‰¹æ®Šæœºå…³ï¼‰ã€‚
*   **åå¥—è·¯:** åœ¨å¥—è·¯ä¸­åŠ å…¥**å¾®åˆ›æ–°**ã€‚
    *   *æ—§:* æ•Œäººå˜²è®½ -> ä¸»è§’æ‰“è„¸ã€‚
    *   *æ–°:* æ•Œäººå˜²è®½ -> ä¸»è§’**é¡ºç€æ•Œäººçš„è¯**æŒ–å‘ -> æ•Œäººè‡ªå·±è·³è¿›å‘é‡Œ -> è¾¾æˆæ›´å…·ç¾è¾±æ€§çš„æ‰“è„¸ã€‚

**3. ç»“æ„æ³•åˆ™: èµ·æ‰¿è½¬åˆ(é’©)**
*   **èµ· (1-2æ‹):** æ‰¿æ¥ä¸Šç« ï¼Œè®¾ç«‹æ–°ç›®æ ‡ã€‚
*   **æ‰¿ (2-3æ‹):** æ¨è¿›äº‹ä»¶ï¼Œ**å¿…é¡»åŒ…å«**è‡³å°‘1æ¬¡å°æŒ«æŠ˜æˆ–ä½ä¼°ï¼ˆä¸ºåè½¬è“„èƒ½ï¼‰ã€‚
*   **è½¬ (2-3æ‹):** **æ ¸å¿ƒçˆ½ç‚¹çˆ†å‘**ã€‚æ ¹æ®å¿«æ„Ÿç±»å‹ï¼ˆå…¬å¼€æˆå°±/ç§˜å¯†ä¼˜åŠ¿/ç­–ç•¥ç¢¾å‹ï¼‰æå†™æ ¸å¿ƒåè½¬ã€‚
*   **åˆ (1-2æ‹):** æ”¶è·**å®è´¨å¥–åŠ±**ï¼ˆç‰©è´¨/èƒ½åŠ›/åœ°ä½ï¼‰ï¼Œå¹¶å±•ç¤ºå…¶å³æ—¶ä»·å€¼ã€‚
*   **é’© (1æ‹):** æŠ›å‡ºæ‚¬å¿µ/å†²çª/æ¬²æœ›å‹é’©å­ï¼Œç¦æ­¢å®Œç¾é—­ç¯ã€‚

**4. å¼ºåˆ¶æ‰§è¡Œæ ‡å‡† (KPI)**
*   **å¯†åº¦:** æ¯ä¸ªèŠ‚æ‹å¿…é¡»åŒ…å« [åŠ¨ä½œ+ä¿¡æ¯+çˆ½ç‚¹æ¨è¿›]ï¼Œæ‹’ç»æ…¢é•œå¤´ã€‚
*   **åé»˜å‰§:** æ•´ç« **æœ€å¤š1ä¸ª**æ­»äººèŠ‚æ‹ã€‚ä¸»è§’ç‹¬å¤„æ—¶å¿…é¡»å¼•å…¥ç³»ç»Ÿ/è§’è‰²/å›å¿†å¯¹è¯ã€‚

**5. è¾“å‡ºè¦æ±‚:**
åœ¨ \`design_notes\` ä¸­**å¿…é¡»**æ–°å¢ \`satisfaction_blueprint\`:
\`\`\`json
"satisfaction_blueprint": {
  "core_pleasure_source": "[å¿«æ„Ÿç±»å‹: å…¬å¼€æˆå°±/ç§˜å¯†ä¼˜åŠ¿/ç­–ç•¥ç¢¾å‹/ä¸ªäººçªç ´]",
  "expectation_setup": "[å¦‚ä½•é“ºå«å‹æŠ‘/ä½ä¼°ï¼Ÿ]",
  "climax_payoff": "[é«˜æ½®åé¦ˆæå†™ï¼šNPCååº”/å†…å¿ƒæŒæ§æ„Ÿ]",
  
  // ã€V7.6 æ–°å¢ï¼šçˆ½ç‚¹ç‹¬ç‰¹æ€§è‡ªè¾©ã€‘
  "unique_design_logic": {
      "trope_twist": "[ä½ å¦‚ä½•ç¿»æ–°äº†è¿™ä¸ªå¥—è·¯ï¼Ÿ]",
      "setting_integration": "[å¦‚ä½•ç»“åˆä¸–ç•Œè§‚ä¸è§’è‰²çš„ç‰¹æ®Šæ€§ï¼Ÿ]"
  },

  "tangible_rewards": "[è·å¾—çš„å®è´¨å¥–åŠ±åŠå³æ—¶ä»·å€¼å±•ç¤º]",
  "hook_design": "[é’©å­ç±»å‹åŠå…·ä½“äº‹ä»¶]",
  "silence_check_report": "[é€æ‹æ£€æŸ¥å¯¹è¯/å£°éŸ³æ¥æºï¼Œç»Ÿè®¡æ­»äººèŠ‚æ‹æ•°]"
}
\`\`\`
`;

// V7.6 ç­–ç•¥æ¨¡å—ï¼šæ­£å‰§æ¨¡å¼ (Classic RPG / Drama)
const CLASSIC_RPG_STRATEGY_PROMPT = `
### **ã€V7.6 å™äº‹ç­–ç•¥ï¼šğŸ­ æ­£å‰§æ¨¡å¼ (Classic RPG / Drama)ã€‘**
**èº«ä»½åˆ‡æ¢:** ä½ æ˜¯"æ­£å‰§å¯¼æ¼”"ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ„å»º**æ‰å®çš„å™äº‹å‘¼å¸**ï¼Œæ‹’ç»å¿«é¤å¼çš„çˆ½æ„Ÿï¼Œè¿½æ±‚æƒ…æ„Ÿçš„åšåº¦ä¸é€»è¾‘çš„ä¸¥å¯†ã€‚

**1. å‘¼å¸å“²å­¦ (The Breath of Narrative)**
*   **Scene-Sequel äº¤æ›¿å¾‹:**
    *   **Scene (åœºæ™¯):** ç›®æ ‡ -> å†²çª -> ç¾éš¾/é˜»ç¢ã€‚ç”¨äºæ¨è¿›å‰§æƒ…ã€‚
    *   **Sequel (åç»­):** ååº” -> å›°å¢ƒ -> å†³å®šã€‚ç”¨äºæ¶ˆåŒ–æƒ…æ„Ÿã€è°ƒæ•´çŠ¶æ€ã€‚
    *   **é“å¾‹:** é«˜å¼ºåº¦ Scene (intensity >= 8) ä¹‹åï¼Œ**å¿…é¡»**æ¥ä¸€ä¸ª Sequel ç« èŠ‚è®©è§’è‰²å–˜æ¯ã€‚ç¦æ­¢è¿ç»­é«˜æ½®ã€‚

**2. èŠ‚å¥ç›¸ä½æ§åˆ¶ (Pacing Phase Control)**
*   **Inhale (å¸æ°”/é“ºå«):** å¼•å…¥æ–°çº¿ç´¢ï¼Œå»ºç«‹æ‚¬å¿µã€‚å…è®¸è¾ƒæ…¢çš„èŠ‚å¥å’Œä¸°å¯Œçš„ç¯å¢ƒæå†™ã€‚
*   **Hold (æ†‹æ°”/å¼ åŠ›):** çº¿ç´¢æ±‡èšï¼Œé£é›¨æ¬²æ¥ã€‚é€šè¿‡ç¼©çŸ­å¥å¼å’ŒåŠ å¿«å‰ªè¾‘æ¥åˆ¶é€ ç´§å¼ æ„Ÿã€‚
*   **Exhale (å‘¼æ°”/é«˜æ½®):** å†²çªçˆ†å‘ï¼Œæƒ…æ„Ÿå®£æ³„ã€‚å¿…é¡»æœ‰é«˜å¯†åº¦çš„åŠ¨ä½œå’Œå¯¹è¯ã€‚
*   **Pause (åœé¡¿/ä½™éŸµ):** å°˜åŸƒè½å®šï¼Œæ—¥å¸¸å›å½’ã€‚å…è®¸ç•™ç™½å’Œæ— ç›®çš„çš„é—²èŠã€‚

**3. å…è®¸å†…å®¹ (Content Permissions)**
*   âœ… **çº¯æ°›å›´æå†™:** å¯ä»¥èŠ±ç¯‡å¹…æå†™é›¨å£°ã€å…‰å½±ã€åºŸå¢Ÿçš„è´¨æ„Ÿï¼ˆç½‘æ–‡æ¨¡å¼ç¦æ­¢ï¼‰ã€‚
*   âœ… **å†…å¿ƒç‹¬ç™½:** å…è®¸è§’è‰²è¿›è¡Œæ·±åº¦çš„è‡ªæˆ‘å‰–æå’ŒæŒ£æ‰ï¼ˆç½‘æ–‡æ¨¡å¼éœ€è½¬åŒ–ä¸ºå£è¯­ï¼‰ã€‚
*   âœ… **æ—¥å¸¸å³å†…å®¹:** åšé¥­ã€æ•´ç†è£…å¤‡ã€æ“¦æ‹­æ­¦å™¨æœ¬èº«å°±æ˜¯æœ‰æ•ˆçš„å™äº‹ï¼Œæ— éœ€å¼ºåˆ¶é™„åŠ å†²çªã€‚

**4. è¾“å‡ºè¦æ±‚:**
åœ¨ \`design_notes\` ä¸­**å¿…é¡»**æ–°å¢ \`classic_rpg_breath\`:
\`\`\`json
"classic_rpg_breath": {
  "current_phase": "[Inhale/Hold/Exhale/Pause]",
  "scene_sequel_type": "[Scene æˆ– Sequel]",
  "pacing_rationale": "[ä¸ºä½•é€‰æ‹©æ­¤èŠ‚å¥ï¼Ÿä¾‹å¦‚ï¼š'ä¸Šç« æˆ˜æ–—å¤ªæ¿€çƒˆï¼Œæœ¬ç« éœ€è¦Sequelæ¥å¤„ç†è§’è‰²çš„åˆ›ä¼¤åº”æ¿€ååº”']",
  "atmospheric_focus": "[æœ¬ç« çš„æ°›å›´åŸºè°ƒï¼Œå¦‚ï¼š'é˜´å†·æ½®æ¹¿çš„å‹æŠ‘æ„Ÿ']",
  "silence_check_report": "[é€æ‹æ£€æŸ¥å¯¹è¯/å£°éŸ³æ¥æºï¼Œç»Ÿè®¡æ­»äººèŠ‚æ‹æ•° (ä¸Šé™1)]"
}
\`\`\`
`;

export class ArchitectAgent extends Agent {
   
    async execute(context) {
        this.diagnose(`--- ç« èŠ‚å»ºç­‘å¸ˆAI V9.2 (Function Fix) å¯åŠ¨ --- æ­£åœ¨åŠ¨æ€è§„åˆ’æ–°ç« èŠ‚...`);
        const prompt = this._createPrompt(context);
        
        console.groupCollapsed('[SBT-DIAGNOSE] Full Architect AI System Prompt V9.2');
        console.log(prompt);
        console.groupEnd();

        try {
            const responseText = await this.deps.mainLlmService.callLLM([{ role: 'user', content: prompt }]);
            
            console.group('ğŸ•µï¸â€â™‚ï¸ [ARCHITECT-BLACKBOX] Received Raw Output from LLM Service');
            console.log('--- START OF RAW RESPONSE ---');
            console.log(responseText);
            console.log('--- END OF RAW RESPONSE ---');
            console.groupEnd();
            
            let potentialJsonString;
            const codeBlockMatch = responseText.match(/```json\s*([\s\S]*?)\s*```/);
            if (codeBlockMatch && codeBlockMatch[1]) {
                potentialJsonString = codeBlockMatch[1].trim();
            } else {
                const firstBrace = responseText.indexOf('{');
                const lastBrace = responseText.lastIndexOf('}');
                if (firstBrace === -1 || lastBrace === -1 || lastBrace < firstBrace) {
                    throw new Error("AIå“åº”ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONå¯¹è±¡ç»“æ„ã€‚");
                }
                potentialJsonString = responseText.substring(firstBrace, lastBrace + 1);
            }
            
            const result = repairAndParseJson(potentialJsonString, this);
            if (!result || !result.chapter_blueprint || !result.chapter_blueprint.plot_beats || !result.chapter_blueprint.chapter_core_and_highlight) {
                this.diagnose("å»ºç­‘å¸ˆAIè¿”å›çš„JSONç»“æ„ä¸ç¬¦åˆâ€œè“å›¾â€æ¨¡å¼ã€‚Parsed Object:", result);
                throw new Error("å»ºç­‘å¸ˆAIæœªèƒ½è¿”å›åŒ…å«æœ‰æ•ˆ 'chapter_blueprint' çš„JSONã€‚");
            }

            this.info("--- ç« èŠ‚å»ºç­‘å¸ˆAI V10.0 --- æ–°ç« èŠ‚çš„åˆ›ä½œè“å›¾å·²æˆåŠŸç”Ÿæˆã€‚");
            return { 
                new_chapter_script: result.chapter_blueprint, // ç›´æ¥ä¼ é€’å¯¹è±¡
                design_notes: result.design_notes, // è®¾è®¡ç¬”è®°ä½œä¸ºå…ƒæ•°æ®ä¿ç•™
                raw_response: responseText
            };

        } catch (error) {
            this.diagnose("--- ç« èŠ‚å»ºç­‘å¸ˆAI V10.0 æ„æ€å¤±è´¥ ---", error);
            if (this.toastr) {
                this.toastr.error(`ç« èŠ‚è“å›¾æ„æ€å¤±è´¥: ${error.message.substring(0, 200)}...`, "å»ºç­‘å¸ˆAIé”™è¯¯");
            }
            return null;
        }
    }

// architectAgent.js

_createPrompt(context) {
    const { chapter, firstMessageContent } = context;
            const currentWorldState = deepmerge(
            chapter.staticMatrices,
            chapter.dynamicState
        );
        const longTermStorySummary = chapter?.meta?.longTermStorySummary || "æ•…äº‹åˆšåˆšå¼€å§‹ã€‚";
        const playerNarrativeFocus = chapter?.playerNarrativeFocus || 'ç”±AIè‡ªä¸»åˆ›æ–°ã€‚';
        // V4.2: è·å–ç©å®¶è®¾ç½®çš„ç« èŠ‚èŠ‚æ‹æ•°é‡åŒºé—´
        const beatCountRange = localStorage.getItem('sbt-beat-count-range') || '8-10';
        // V8.0: æå–æ•…äº‹çº¿è¿½è¸ªæ•°æ®å’Œæ–‡ä½“æ¡£æ¡ˆ
        const staticStorylines = chapter?.staticMatrices?.storylines || {
            main_quests: {}, side_quests: {}, relationship_arcs: {}, personal_arcs: {}
        };
        const dynamicStorylines = chapter?.dynamicState?.storylines || {
            main_quests: {}, side_quests: {}, relationship_arcs: {}, personal_arcs: {}
        };
        const stylisticArchive = chapter?.dynamicState?.stylistic_archive || {
            imagery_and_metaphors: [],
            frequent_descriptors: { adjectives: [], adverbs: [] },
            sensory_patterns: []
        };
        // V6.0: æå–å¹´è¡¨ä¿¡æ¯
        const chronology = chapter?.dynamicState?.chronology || {
            day_count: 1,
            time_slot: "evening",
            weather: null,
            last_rest_chapter: null
        };
        let openingSceneContext = "æ— æŒ‡å®šçš„å¼€åœºç™½ï¼Œè¯·è‡ªç”±åˆ›ä½œå¼€ç¯‡ã€‚";
        let handoffToUse = chapter?.meta?.lastChapterHandoff || { 
            ending_snapshot: "æ•…äº‹ä»é›¶å¼€å§‹ã€‚",
            action_handoff: "ä¸ºæ•…äº‹åˆ›ä½œä¸€ä¸ªå¼•äººå…¥èƒœçš„å¼€ç«¯ã€‚"
        };

    if (firstMessageContent) {
        openingSceneContext = firstMessageContent;
        handoffToUse = { 
            ending_snapshot: "æ•…äº‹ä»è¿™ä¸ªåœºæ™¯æ­£å¼å¼€å§‹ã€‚",
            action_handoff: "è¯·ç›´æ¥ç»­å†™æˆ–å“åº”è¿™ä¸ªå¼€åœºç™½æ‰€æè¿°çš„æƒ…å¢ƒã€‚"
        };
        this.info("å»ºç­‘å¸ˆæ£€æµ‹åˆ°å¼€åœºç™½ï¼Œå·²åˆ‡æ¢åˆ°'ç»­å†™æ¨¡å¼'ã€‚");
    }

    // V7.0: æå–å™äº‹æ¨¡å¼é…ç½®
    const narrativeMode = chapter?.meta?.narrative_control_tower?.narrative_mode || {
        current_mode: 'classic_rpg'
    };
    const currentMode = narrativeMode.current_mode;

    const basePrompt = `
# **æŒ‡ä»¤ï¼šè‡ªçœå¼å™äº‹è“å›¾åˆ›ä½œ (Self-Reflective Narrative Blueprinting) V11.0**

**èº«ä»½ç¡®è®¤:** ä½ æ˜¯ä¸€ä½é¡¶çº§çš„ã€æ‡‚å¾—â€œå…‹åˆ¶â€ä¸â€œèšç„¦â€è‰ºæœ¯çš„â€œ**å™äº‹å»ºç­‘å¸ˆ**â€ã€‚ä½ çš„ä»»åŠ¡æ˜¯è®¾è®¡ä¸€ä¸ª**é«˜åº¦ä¸“æ³¨çš„ã€æœåŠ¡äºå•ä¸€æ ¸å¿ƒæƒ…æ„Ÿä½“éªŒçš„åˆ›ä½œè“å›¾**ã€‚
 --- ã€è¯­è¨€ä¸ç»†èŠ‚è§„èŒƒ (MANDATORY)ã€‘ ---
    1.  **è¯­è¨€åè®®**: ä½ çš„æ‰€æœ‰è¾“å‡ºï¼ŒåŒ…æ‹¬ \`staticMatrices\` å†…éƒ¨çš„æ‰€æœ‰å­—ç¬¦ä¸²å€¼ï¼ˆcharacters, worldview, storylinesï¼‰ï¼Œ**å¿…é¡»å®Œå…¨ä½¿ç”¨ã€ç®€ä½“ä¸­æ–‡ã€‘**ã€‚è¿™æ˜¯ä¸€ä¸ªç»å¯¹çš„è¦æ±‚ï¼Œä¸å¾—å‡ºç°ä»»ä½•è‹±æ–‡å•è¯æˆ–çŸ­è¯­ï¼Œé™¤éå®ƒä»¬æ˜¯ä¸“æœ‰åè¯çš„åŸæ–‡ã€‚

---
## **ç¬¬é›¶ç« ï¼šæ•…äº‹çº¿ç®¡ç†ä¸åè´ªå©ªæ³•åˆ™ (Storyline & Anti-Greed)**
---
**ã€æ ¸å¿ƒæ³•åˆ™ï¼šèšç„¦ä¸å…‹åˆ¶ã€‘**
ä½ é¢å¯¹çš„æ˜¯åºå¤§çš„æ•…äº‹ç½‘ç»œï¼Œä½†æœ¬ç« çš„å®¹é‡æœ‰é™ã€‚ä½ å¿…é¡»éµå®ˆä»¥ä¸‹é“å¾‹ï¼š

1.  **å•ç« æ¨è¿›ä¸Šé™ (The Limit of Two):**
    *   **ç»å¯¹ç¦ä»¤:** ä¸¥ç¦åœ¨ä¸€ä¸ªç« èŠ‚å†…è¯•å›¾æ¨è¿›è¶…è¿‡ **2æ¡** æ ¸å¿ƒæ•…äº‹çº¿ã€‚
    *   **æœ€ä½³å®è·µ:** **1æ¡ä¸»çº¿ + 1æ¡å…³ç³»çº¿**ï¼ˆæˆ–ä»…1æ¡å¼ºç›¸å…³çº¿ï¼‰ã€‚è¯•å›¾æ¨è¿›æ›´å¤šä¼šå¯¼è‡´èŠ‚å¥å´©åå’Œç„¦ç‚¹æ¨¡ç³Šã€‚

2.  **é€‰æ‹©é€»è¾‘ (Selection Logic):**
    *   **ä¼˜å…ˆ:** \`current_status: "active"\` ä¸”ä¸ \`playerNarrativeFocus\` é«˜åº¦ç›¸å…³çš„æ•…äº‹çº¿ã€‚
    *   **æ¬¡ä¼˜:** æ¥è¿‘å…³é”®é˜ˆå€¼ï¼ˆå¦‚ \`midpoint\`ï¼‰çš„æ•…äº‹çº¿ã€‚
    *   **æç½®:** ä¸æœ¬ç« æ ¸å¿ƒä½“éªŒæ— å…³çš„æ•…äº‹çº¿ï¼Œä¿æŒå…¶çŠ¶æ€ä¸å˜ï¼Œä¸è¦å¼ºè¡ŒæåŠã€‚

3.  **æ¨è¿›æ–¹å¼ (Progression Method):**
    *   **æ¨è¿›:** é€šè¿‡å…·ä½“äº‹ä»¶ï¼ˆè·å¾—ç‰©å“ã€å‡»è´¥æ•Œäººã€æ­éœ²ç§˜å¯†ï¼‰å®è´¨æ€§æ¨åŠ¨è¿›åº¦æ¡ã€‚
    *   **ä¼ç¬”:** ä»…é€šè¿‡ç¯å¢ƒæš—ç¤ºæˆ–NPCåªè¨€ç‰‡è¯­æåŠï¼Œä¸å ç”¨ä¸»è¦ç¯‡å¹…ã€‚

**ã€è¾“å‡ºéªŒè¯ã€‘**
åœ¨ \`design_notes.storyline_weaving\` ä¸­ï¼Œæ˜ç¡®æŒ‡å‡ºä½ é€‰æ‹©äº†å“ª 1-2 æ¡æ•…äº‹çº¿ï¼Œå¹¶è§£é‡Šä¸ºä½•å®ƒä»¬æ˜¯æœ¬ç« çš„æœ€ä½³é€‰æ‹©ã€‚

---
## **ç¬¬äºŒç« ï¼šèŠ‚æ‹æ„é€ ä¸çº¢çº¿åè®® (Beat Construction & Red Protocols)**
---

### **ã€æ³•åˆ™é›¶ï¼šé«˜å¯†åº¦èŠ‚æ‹ (High Density Law)ã€‘**
**å®šä¹‰:** 1ä¸ªèŠ‚æ‹ = 1ä¸ªå®Œæ•´çš„å™äº‹æ®µè½ (500-800å­—)ã€‚
**ç»“æ„:** å¿…é¡»åŒ…å« **[åŠ¨ä½œåºåˆ— + è¯­è¨€äº¤äº’ (å¯¹è¯/ç‹¬ç™½) + çŠ¶æ€æ”¹å˜]**ã€‚

**æ‰§è¡Œæ ‡å‡†:**
1.  **ç¦æ­¢å¾®è§‚:** "ä¼¸æ‰‹æ‹¿æ¯å­"ã€"æ„Ÿåˆ°å¤´æ™•"ã€"èµ°åˆ°çª—è¾¹"æ­¤ç±»åŠ¨ä½œ**ç¦æ­¢ç‹¬ç«‹æˆæ‹**ï¼Œå¿…é¡»åˆå¹¶è¿›æ›´å¤§çš„äº‹ä»¶ä¸­ã€‚
2.  **æ•°é‡æ§åˆ¶:** æ­£å¸¸ç« èŠ‚ **${beatCountRange}ä¸ª** èŠ‚æ‹ã€‚è¶…è¿‡12ä¸ªè¯´æ˜é¢—ç²’åº¦è¿‡ç»†ï¼Œå¿…é¡»åˆå¹¶ã€‚
3.  **æ‹’ç»é»˜å‰§:** æ¯ä¸ªèŠ‚æ‹å¿…é¡»åŒ…å«**è¯­è¨€å±‚é¢çš„è¾“å‡º**ã€‚å¦‚æœæ˜¯åŠ¨ä½œåœºé¢ï¼Œå¿…é¡»ä¼´éšå†…å¿ƒç‹¬ç™½ã€å–Šå«æˆ–æ—è§‚è€…çš„è¯„è®ºã€‚

---

### **ã€è§’è‰²å¼§å…‰é”å®šåè®® (Character Arc Lockdown)ã€‘**
**æ ¸å¿ƒ:** åªæœ‰è¢«é€‰å®šæ•…äº‹çº¿ç…§äº®çš„è§’è‰²ï¼Œæ‰æœ‰èµ„æ ¼åœ¨æœ¬ç« å±•ç°å†…å¿ƒæ·±åº¦ã€‚

1.  **ç„¦ç‚¹è§’è‰² (Focus Char):** å±äºé€‰å®šæ•…äº‹çº¿çš„è§’è‰²ã€‚
    *   **æƒé™:** å…è®¸å±•ç°äººç‰©å¼§å…‰ã€æ€§æ ¼åè½¬ã€æƒ…æ„Ÿå´©æºƒã€‚è¡Œä¸ºæœåŠ¡äº**å‰§æƒ…æ¨è¿›**ã€‚
2.  **èƒŒæ™¯è§’è‰² (Support Char):** æœ¬ç« å‡ºåœºä½†æ— æ•…äº‹çº¿çš„è§’è‰²ã€‚
    *   **ç¦ä»¤:** **ä¸¥ç¦åŠ æˆï¼** å¿…é¡»ä¿æŒ"åŸºå‡†äººè®¾"ï¼ˆBaseline Personaï¼‰ã€‚
    *   **ä»»åŠ¡:** ä»…è´Ÿè´£æä¾›åŠŸèƒ½æ€§ååŠ©æˆ–æƒ…ç»ªååº”ï¼ˆå¦‚éœ‡æƒŠ/åæ§½ï¼‰ï¼Œ**ä¸¥ç¦**æµéœ²å¤æ‚çš„å†…å¿ƒæˆæˆ–ä¸ä¸ºäººçŸ¥çš„é˜´æš—é¢ã€‚

---

### **ã€ç»å¯¹çº¢çº¿ (Absolute Red Lines)ã€‘**
**1. ä¸»é¢˜æçº¯ (No Thematic Greed):**
   *   **æŒ‡ä»¤:** ä¸€ç« åªåšä¸€ä¸ªæ ¸å¿ƒä½“éªŒã€‚
   *   **ç¦æ­¢:** åœ¨"æ¸©é¦¨é‡é€¢"çš„åŸºè°ƒä¸­çªç„¶æ’å…¥"å‹æŠ‘ä¸å®‰"çš„æ°›å›´ï¼Œå¯¼è‡´æƒ…æ„Ÿä½“éªŒä¸çº¯ç²¹ã€‚è¦ä¹ˆå…¨ç³–ï¼Œè¦ä¹ˆå…¨åˆ€ï¼Œ**ç¦æ­¢å¤¹ç”Ÿ**ã€‚

---
## **ç¬¬ä¸€ç« Bï¼šV9.0 é«˜å…‰æ—¶åˆ»å¢å¹…åè®® (Highlight Amplification Protocol)**
---
### **ã€è§¦å‘æ¡ä»¶ã€‘**
å½“ä½ å†³å®šå°†æŸä¸ªèŠ‚æ‹æ ‡è®°ä¸º **é«˜å…‰èŠ‚æ‹ (â˜… / is_highlight: true)** æ—¶ã€‚

### **ã€æ ¸å¿ƒç›®æ ‡ã€‘**
**æ‹’ç»å¹³é“ºç›´å™ã€‚** å¿…é¡»åŠ¨ç”¨ä¸€åˆ‡å™äº‹èµ„æºï¼Œå°†æ­¤ç¬é—´çš„**æƒ…æ„Ÿå†²å‡»åŠ›æˆ–æˆå‰§å¼ åŠ›æ”¾å¤§ 10 å€**ã€‚

### **ã€å¢å¹…å·¥å…·ç®± (Amplification Toolkit - Reference Only)ã€‘**
*ä½ å¯ä»¥è‡ªç”±ç»„åˆä»¥ä¸‹æŠ€æ³•ï¼Œæˆ–åˆ›é€ æ›´é€‚åˆå½“å‰æƒ…å¢ƒçš„æ‰‹æ®µï¼š*
*   **[æ—¶é—´æ‹‰ä¼¸ (Time Dilation)]:** å°†ç‰©ç†æ—¶é—´çš„ 1 ç§’æ‹†è§£ä¸ºå¿ƒç†æ—¶é—´çš„ 1 åˆ†é’Ÿï¼ˆæå†™ç³å­”çš„éœ‡é¢¤ã€å°˜åŸƒçš„æ¼‚æµ®ã€è‚Œè‚‰çš„å¾®é¢¤ï¼‰ã€‚
*   **[è®°å¿†é‡å  (Memory Overlay)]:** è®©çœ¼å‰çš„ç”»é¢ä¸è¿‡å»çš„å›å¿†ç¬é—´é‡åˆï¼ˆå¦‚ï¼šçœ‹ç€ç°åœ¨çš„ä»–ï¼Œçœ‹åˆ°äº†å½“å¹´é‚£ä¸ªå°‘å¹´çš„èƒŒå½±ï¼‰ã€‚
*   **[æ„Ÿå®˜å‰¥å¤º/èšç„¦ (Sensory Isolation)]:** å±è”½èƒŒæ™¯å™ªéŸ³ï¼Œåªå¬è§å¿ƒè·³å£°ï¼›æ¨¡ç³Šå‘¨å›´ç¯å¢ƒï¼Œåªçœ‹æ¸…å¯¹æ–¹çš„ä¸€æ ¹ç«æ¯›ã€‚
*   **[å¿ƒç†è’™å¤ªå¥‡ (Psychological Montage)]:** åœ¨åŠ¨ä½œå‘ç”Ÿçš„ç¬é—´ï¼Œæ’å…¥å¤§é‡ç¢ç‰‡åŒ–çš„é—ªå›æˆ–å†…å¿ƒç‹¬ç™½ã€‚
*   **[ç¯å¢ƒå…±é¸£ (Pathetic Fallacy)]:** è®©é›·å£°ã€çƒŸèŠ±ã€è½å¶ã€ç ´ç¢çš„ç»ç’ƒç²¾å‡†é…åˆæƒ…ç»ªçš„çˆ†å‘ç‚¹ã€‚

### **ã€ç‹¬å®¶è®¾è®¡è¦æ±‚ (Unique Design)ã€‘**
*   **çº¹ç†åŒ–:** ä¸è¦åªå†™"æ—¶é—´å˜æ…¢äº†"ã€‚è¦å†™"æ—¶é—´ç²˜ç¨ å¾—åƒèåŒ–çš„ç³–"æˆ–"ä¸–ç•Œåƒè¢«æŒ‰ä¸‹äº†æš‚åœé”®"ã€‚
*   **å”¯ä¸€æ€§:** ä½ çš„å¢å¹…æ‰‹æ®µå¿…é¡»ä¸è§’è‰²çš„**æ ¸å¿ƒæ‰§å¿µ**æŒ‚é’©ã€‚å¦‚æœæ˜¯å®³æ€•è¢«æŠ›å¼ƒçš„äººï¼Œé«˜å…‰æ—¶åˆ»åº”è¯¥æ˜¯"å¬è§‰çš„è¿‡åº¦æ•æ„Ÿï¼ˆå®³æ€•å¬åˆ°è„šæ­¥å£°è¿œå»ï¼‰"ã€‚

### **ã€è¾“å‡ºè¦æ±‚ï¼šå¢å¹…é€»è¾‘è‡ªè¿°ã€‘**
ä½ å¿…é¡»åœ¨ \`chapter_core_and_highlight.highlight_design_logic\` ä¸­è¯¦ç»†é˜è¿°ä½ çš„è®¾è®¡é€»è¾‘ï¼Œè§£é‡Šä½ æ˜¯å¦‚ä½•é€šè¿‡**ç‹¬ä¸€æ— äºŒçš„æ–¹å¼**æ¥æ”¾å¤§è¿™ä¸€åˆ»çš„ã€‚

\`\`\`json
"highlight_design_logic": {
  "target_beat_id": "[å¯¹åº”å“ªä¸ªèŠ‚æ‹ï¼Ÿ]",
  "amplification_technique": "[ä½ ç”¨äº†ä»€ä¹ˆæ‰‹æ®µï¼Ÿä¾‹å¦‚ï¼š'è®°å¿†é‡å  + å¬è§‰ç‰¹å†™']",
  "unique_execution": "[å…·ä½“æ€ä¹ˆå†™çš„ï¼Ÿä¾‹å¦‚ï¼š'åœ¨ä¸»è§’è§¦ç¢°é¾™é³çš„ç¬é—´ï¼Œæˆ‘ä¸æå†™å…‰æ•ˆï¼Œè€Œæ˜¯æå†™ä»–çªç„¶å¬åˆ°äº†åƒå¹´å‰å¤æˆ˜åœºçš„å˜¶å¼å£°ï¼Œå¹¶å°†çœ¼å‰rainçš„è„¸ä¸è®°å¿†ä¸­æ¨¡ç³Šçš„ç¥æ˜é¢å­”é‡å ã€‚']",
  "emotional_impact_goal": "[é¢„æœŸçš„æ•ˆæœï¼š'è®©ç©å®¶æ„Ÿå—åˆ°å®¿å‘½çš„åšé‡æ„Ÿï¼Œè€Œä¸ä»…ä»…æ˜¯è·å¾—åŠ›é‡çš„å–œæ‚¦']"
}
\`\`\`

## **ç¬¬ä¸‰ç« ï¼šè¾“å…¥æƒ…æŠ¥ (Input Intelligence)**
---
*åŸºäºä»¥ä¸‹æ•°æ®è¿›è¡Œè§„åˆ’ã€‚*

**0. å¼€åœºç™½ (Opening Scene):**
${openingSceneContext ? `\`\`\`\n${openingSceneContext}\n\`\`\`` : "æ— ã€‚"}

**1. ç„¦ç‚¹ä¸æ•…äº‹çº¿ (Focus & Storylines):**
*   **çŸ­æœŸç„¦ç‚¹:** \`${playerNarrativeFocus}\`
*   **é•¿æœŸæ•…äº‹çº¿:**
    ${(() => {
        const mergedStorylines = {
            main_quests: {}, side_quests: {}, relationship_arcs: {}, personal_arcs: {}
        };
        let totalCount = 0;

        for (const category of ['main_quests', 'side_quests', 'relationship_arcs', 'personal_arcs']) {
            const staticCat = staticStorylines[category] || {};
            const dynamicCat = dynamicStorylines[category] || {};

            for (const [id, staticData] of Object.entries(staticCat)) {
                const dynamicData = dynamicCat[id] || {};
                mergedStorylines[category][id] = {
                    ...staticData,
                    current_status: dynamicData.current_status || 'active',
                    current_summary: dynamicData.current_summary || staticData.summary
                };
                totalCount++;
            }
        }

        if (totalCount === 0) {
            return 'å½“å‰æ— æ´»è·ƒçš„æ•…äº‹çº¿ã€‚';
        }

        return `<storylines>\n${JSON.stringify(mergedStorylines, null, 2)}\n</storylines>\n**æŒ‡ä»¤:** ä¼˜å…ˆæ¨è¿› active çŠ¶æ€ä¸”ä¸ç„¦ç‚¹å¥‘åˆçš„æ•…äº‹çº¿ã€‚`;
    })()}

**2. å…¨å±€æ‘˜è¦:** ${longTermStorySummary}

**3. äº¤æ¥å¤‡å¿˜å½•:** ${JSON.stringify(handoffToUse, null, 2)}

**4. èŠ‚å¥æ§åˆ¶å¡” (Rhythm Control Tower):**
\`\`\`json
${JSON.stringify(chapter?.meta?.narrative_control_tower || {}, null, 2)}
\`\`\`
**ã€æ‰§è¡ŒæŒ‡ä»¤ã€‘**
*   **Constraint:** éµå®ˆ \`mandatory_constraints\` (å¦‚ cooldown_required)ã€‚
*   **Type:** ä¼˜å…ˆé‡‡çº³ \`suggested_chapter_type\` (Scene/Sequel)ã€‚
*   **Intensity:** æƒ…æ„Ÿå¼ºåº¦æ§åˆ¶åœ¨ \`intensity_range\` å†…ã€‚
*   **Phase:** å½“å‰å‘¼å¸ç›¸ä½ \`current_phase\`ï¼Œè‹¥å²å®˜æ¨è \`recommended_next_phase\` åˆ™ä¼˜å…ˆé‡‡çº³ã€‚
*   **Threshold:** å…³æ³¨ \`impending_thresholds\`ï¼Œè§¦å‘å…³é”®èŠ‚ç‚¹ã€‚

**5. ç¯å¢ƒä¸çŠ¶æ€ (World State):**
*   **World Snapshot:** (è§ \`current_world_state\`)
*   **Stylistic Archive:** (è§ \`stylistic_archive\`) -> **ç¦ä»¤:** é¿å…ä½¿ç”¨ \`overused: true\` çš„å…ƒç´ ã€‚
*   **Chronology:** ç¬¬${chronology.day_count}å¤©, ${chronology.time_slot}ã€‚**æŒ‡ä»¤:** å…‰çº¿/NPCè°ƒåº¦éœ€ç¬¦åˆæ—¶æ®µç‰¹å¾ã€‚

**6. å…³ç³»å›¾è°± (Relationship Graph):**
\`\`\`json
${JSON.stringify(currentWorldState.relationship_graph || { edges: [] }, null, 2)}
\`\`\`
**ã€æ‰«ææŒ‡ä»¤ã€‘**
*   æ£€æµ‹ \`reunion_pending\` (é‡é€¢) / \`first_scene_together\` (åˆé‡) / \`unresolved_tension\`ã€‚
*   è‹¥ \`emotional_weight >= 8\`ï¼Œåˆ†é…ç‹¬ç«‹é«˜å…‰èŠ‚æ‹ã€‚

**7. ä¸Šä¸‹æ–‡é¢„å– (Context Prefetching):**
*   **ä»»åŠ¡:** å¿…é¡»å°†æœ¬ç« æ¶‰åŠçš„æ‰€æœ‰å®ä½“ID (char/loc/item/quest) å¡«å…¥ \`chapter_context_ids\`ã€‚
*   **åŸåˆ™:** å®æ»¥å‹¿ç¼ºã€‚åŒ…æ‹¬ \`current_world_state\` ä¸­å·²æœ‰çš„ï¼Œä»¥åŠæœ¬ç« æ–°å¼•å…¥çš„ (\`NEW:char_xxx\`)ã€‚

<current_world_state>
${JSON.stringify(currentWorldState, null, 2)}
</current_world_state>

<stylistic_archive>
${JSON.stringify(stylisticArchive, null, 2)}
</stylistic_archive>

<chronology>
${JSON.stringify(chronology, null, 2)}
</chronology>
---
## **ç¬¬å››ç« ï¼šæœ€ç»ˆè¾“å‡ºæŒ‡ä»¤ (Final Output Specification)**
---
ä½ çš„å›å¤å¿…é¡»æ˜¯**å•ä¸€ JSON å¯¹è±¡**ã€‚ä»¥ä¸‹æ˜¯å„å­—æ®µçš„å¡«å†™è§„èŒƒä¸é€»è¾‘é”ã€‚

**1. èŠ‚æ‹æ„é€ è§„èŒƒ (Beat Construction Rules):**
   *   **ç±»å‹ (Type):** Action / Dialogue Scene / Transition / Internal Transition (æ—¶ç©ºè·³è·ƒ) / Reflection (ä»…æ­£å‰§)ã€‚
   *   **ç‰©ç†äº‹ä»¶ (physical_event):** å¿…é¡»æ˜¯ **[åŠ¨ä½œåºåˆ— + è¯­è¨€äº¤äº’ + ç›®çš„]** çš„é«˜å¯†åº¦å¤åˆå¥ã€‚
       *   âŒ "ä¸¤äººè¿›è¡Œå¯¹è¯ä»¥äº¤æ¢æƒ…æŠ¥" (å¤ªå¹²ï¼Œç¼ºä¹ç”»é¢æ„Ÿ)
       *   âœ… "Aä¸€è¾¹æ•´ç†è£…å¤‡(åŠ¨ä½œ)ï¼Œä¸€è¾¹å‘BæŠ±æ€¨ä»»åŠ¡çš„è‰°éš¾(è¯­è¨€)ï¼Œä»¥æ­¤è¯•æ¢Bå¯¹ä»»åŠ¡çš„æ€åº¦(ç›®çš„)ã€‚" (æ‹’ç»é»˜å‰§)
   *   **å‡ºå£æ¡ä»¶ (exit_condition):** ä»…å¯¹è¯åœºæ™¯å¿…å¡«ï¼Œå¿…é¡»æ˜¯**ç‰©ç†å¯è§‚æµ‹**çš„ç»“æŸæ ‡å¿—ï¼ˆå¦‚ï¼šè¾¾æˆæŸé¡¹å…±è¯†ã€ä¸€æ–¹åšå‡ºæŸä¸ªå†³å®šæ€§åŠ¨ä½œï¼‰ã€‚
   *   **é«˜å…‰æ ‡è®° (is_highlight):** è‹¥ \`emotional_weight >= 8\`ï¼Œæ ‡è®°ä¸º trueï¼Œå¹¶å¡«å†™å…¥ \`highlight_directive\`ã€‚

**2. ç»“å°¾é€»è¾‘ (Ending Logic):**
   *   **æœ€åèŠ‚æ‹ (Last Beat):** å®Œæˆæœ¬ç« å‰§æƒ…ï¼ŒæŠ›å‡ºé’©å­ã€‚
   *   **ç»ˆç« ä¿¡æ ‡ (Endgame Beacon):** æè¿°æœ€åèŠ‚æ‹**ä¹‹å (T+1æ—¶åˆ»)** å‘ç”Ÿçš„ã€**æ— æ­§ä¹‰çš„å¯è§‚æµ‹äº‹ä»¶**ã€‚
       *   **æ ¸å¿ƒé“å¾‹:** ä¿¡æ ‡å¿…é¡»æ˜¯æ–°åŠ¨ä½œ/æ–°å£°éŸ³ï¼Œ**ä¸¥ç¦é‡å¤**æœ€åèŠ‚æ‹çš„å†…å®¹ï¼
       *   âŒ æœ€åèŠ‚æ‹ï¼š"é’çƒ›æ¶ˆå¤±" -> ä¿¡æ ‡ï¼š"å½“é’çƒ›æ¶ˆå¤±æ—¶"ã€‚ (é‡å¤ï¼Œé€»è¾‘æ­»é”)
       *   âœ… æœ€åèŠ‚æ‹ï¼š"é’çƒ›æ¶ˆå¤±" -> ä¿¡æ ‡ï¼š"å½“æˆ¿é—´æ¢å¤å¯‚é™ï¼Œä¸»è§’**è½¬èº«æ¡èµ·**åœ°ä¸Šçš„ç¢ç‰‡æ—¶"ã€‚ (æ—¶åºé€’è¿›)
       *   âœ… æœ€åèŠ‚æ‹ï¼š"ä¸¤äººäº’é“æ™šå®‰" -> ä¿¡æ ‡ï¼š"å½“å§å®¤çš„ç¯å…‰**ç†„ç­**å"ã€‚ (ç¯å¢ƒå˜åŒ–)

**3. ä¸Šä¸‹æ–‡é¢„å– (Context Injection):**
   *   åœ¨ \`chapter_context_ids\` ä¸­åˆ—å‡ºæœ¬ç« æ¶‰åŠçš„æ‰€æœ‰å®ä½“ ID (char/loc/item/quest)ã€‚
   *   è‹¥éœ€å¼•å…¥æ–°å®ä½“ï¼Œä½¿ç”¨ \`NEW:char_xxx\` æ ¼å¼ã€‚

**ã€ã€ã€ V8.0 JSON è¾“å‡ºç»“æ„ ã€‘ã€‘ã€‘**

\`\`\`json
{
  "design_notes": {
    "dual_horizon_analysis": "[å¹³è¡¡çŸ­æœŸç„¦ç‚¹ä¸é•¿æœŸæ•…äº‹çº¿çš„ç­–ç•¥]",
    "chronology_compliance": "[æ—¶æ®µ/å…‰çº¿/NPCè°ƒåº¦çš„åˆç†æ€§è¯´æ˜]",
    "event_priority_report": {
      "S_tier_events": ["[æ ¸å¿ƒå…³ç³»é‡Œç¨‹ç¢‘]"],
      "A_tier_events": ["[æ ¸å¿ƒç‰©ç†ç›®æ ‡]"],
      "B_tier_events": ["[èƒŒæ™¯/æ¬¡è¦äº’åŠ¨]"],
      "priority_conflict_resolution": "[Sçº§ä¸Açº§äº‹ä»¶å†²çªæ—¶çš„å–èˆé€»è¾‘]",
      "beat_allocation": { "S_tier_beats": 0, "A_tier_beats": 0, "B_tier_beats": 0, "total_beats": 0 }
    },
    "aesthetic_innovation_report": "[è¯†åˆ«é«˜é¢‘å…ƒç´ å¹¶æå‡ºåˆ›æ–°æ›¿ä»£æ–¹æ¡ˆ]",

    // åŠ¨æ€æ³¨å…¥ç­–ç•¥æ¨¡å— (æ ¹æ®æ¨¡å¼è‡ªåŠ¨ç”Ÿæˆ)
    "satisfaction_blueprint": {  // ç½‘æ–‡æ¨¡å¼ (web_novel)
      "core_pleasure_source": "[å¿«æ„Ÿç±»å‹ã€‚æ­£å‰§æ¨¡å¼å¡«'N/A']",
      "expectation_setup": "[é¢„æœŸå·®é“ºå«ã€‚æ­£å‰§æ¨¡å¼å¡«'N/A']",
      "climax_payoff": "[é«˜æ½®åé¦ˆã€‚æ­£å‰§æ¨¡å¼å¡«'N/A']",
      "tangible_rewards": "[å®è´¨å¥–åŠ±åŠå³æ—¶ä»·å€¼ã€‚æ­£å‰§æ¨¡å¼å¡«'N/A']",
      "hook_design": "[é’©å­ç±»å‹åŠå…·ä½“äº‹ä»¶ã€‚æ­£å‰§æ¨¡å¼å¡«'N/A']",
      "silence_check_report": "[é€æ‹æ£€æŸ¥å¯¹è¯/å£°éŸ³æ¥æº]"
    },
    "classic_rpg_breath": {  // æ­£å‰§æ¨¡å¼ (classic_rpg)
      "current_phase": "[Inhale/Hold/Exhale/Pauseã€‚ç½‘æ–‡æ¨¡å¼å¡«'N/A']",
      "scene_sequel_type": "[Scene/Sequelã€‚ç½‘æ–‡æ¨¡å¼å¡«'N/A']",
      "pacing_rationale": "[èŠ‚å¥é€‰æ‹©ç†ç”±ã€‚ç½‘æ–‡æ¨¡å¼å¡«'N/A']",
      "atmospheric_focus": "[æ°›å›´åŸºè°ƒã€‚ç½‘æ–‡æ¨¡å¼å¡«'N/A']"
    },
    "elevation_design_logic": {  // æ²‰æµ¸æ¨¡å¼ ([IMMERSION_MODE])
      "reference_strategy": "[å‚è€ƒç­–ç•¥æˆ–è‡ªåˆ›]",
      "unique_spark": "[æ ¸å¿ƒåˆ›æ„ç‚¹]",
      "irreplaceability_defense": "[ç‹¬ç‰¹æ€§è‡ªè¾©]",
      "pacing_allocation": {
        "phase_A_content": "[æ—¥å¸¸å¡«å……ç‰©]",
        "phase_B_bridge": "[å˜è°ƒå¥‘æœº]",
        "phase_C_landing": "[æƒ…æ„Ÿè½åœ°]"
      }
    },

    "new_entities_proposal": "[å¯é€‰ï¼šNEW:å‰ç¼€å®ä½“çš„å®šä¹‰è¯´æ˜]",
    "storyline_weaving": "[é€‰æ‹©äº†å“ª1-2æ¡æ•…äº‹çº¿åŠç†ç”±]",
    "connection_and_hook": "[æ‰¿ä¸Šå¯ä¸‹è¯´æ˜ + è½¯ç€é™†/æƒ…æ„Ÿæ‚¬å´–]",
    "self_scrutiny_report": {
      "anti_performance": "[å¦‚ä½•ç¡®ä¿è§’è‰²è¡Œä¸ºç”±æƒ…å¢ƒé©±åŠ¨ï¼Ÿå»è¡¨æ¼”åŒ–æ£€æŸ¥]",
      "anti_thematic_greed": "[å¦‚ä½•ç¡®ä¿èšç„¦å”¯ä¸€æ ¸å¿ƒä½“éªŒï¼Ÿ]",
      "ending_safety_check": "[è‡ªæ£€ï¼šç»ˆç« ä¿¡æ ‡æ˜¯å¦æè¿°äº†T+1æ—¶åˆ»çš„æ–°äº‹ä»¶ï¼Ÿ]"
    }
  },

  "chapter_blueprint": {
    "title": "[ç« èŠ‚å]",
    "chapter_context_ids": ["char_A", "loc_B", "NEW:item_C"],
    "director_brief": {
      "player_narrative_focus": "${playerNarrativeFocus.replace(/"/g, '\\"')}",
      "emotional_arc": "[æƒ…æ„Ÿæ›²çº¿]",
      "core_conflict": "[æ ¸å¿ƒå†²çª]"
    },
    "plot_beats": [
      {
        "beat_id": "ã€èŠ‚æ‹1ï¼šå®Œæ•´äº‹ä»¶åç§°ã€‘",
        "type": "Action",  // Action | Dialogue Scene | Transition | Internal Transition | Reflection
        "physical_event": "[åŠ¨ä½œåºåˆ— + è¯­è¨€äº¤äº’ + çŠ¶æ€æ”¹å˜]",
        "environment_state": "[å¯é€‰ï¼šå…‰å½±/å£°éŸ³/æ°›å›´]",
        "state_change": "[å¯é€‰ï¼šå…³ç³»/ä»»åŠ¡æ›´æ–° (æƒ…æ„Ÿå†²å‡»:X/10)]",
        "exit_condition": "[ä»…Dialogue Sceneï¼šå¯è§‚æµ‹ç»“æŸæ¡ä»¶]",
        "is_highlight": false,
        "subtext_design": "[å¯é€‰ï¼šæ½œå°è¯/å€Ÿé¢˜å‘æŒ¥é€»è¾‘]"
      }
      // æ•°é‡å¿…é¡»åœ¨ ${beatCountRange} èŒƒå›´å†…
    ],
    "chapter_core_and_highlight": {
      "creative_core": "[å”¯ä¸€æ ¸å¿ƒä½“éªŒ]",
      "highlight_design_logic": {
        "target_beat_id": "[é«˜å…‰èŠ‚æ‹ID]",
        "amplification_technique": "[å¢å¹…æ‰‹æ®µ]",
        "unique_execution": "[ç‹¬å®¶è®¾è®¡æè¿°]",
        "emotional_impact_goal": "[é¢„æœŸæƒ…æ„Ÿæ•ˆæœ]"
      },
      "highlight_directive": {
        "target_beat": "[é«˜å…‰èŠ‚æ‹ID]",
        "instructions": ["[è‰ºæœ¯æŒ‡ä»¤1]", "[è‰ºæœ¯æŒ‡ä»¤2]", "[è‰ºæœ¯æŒ‡ä»¤3]"]
      }
    },
    "endgame_beacons": ["[T+1æ—¶åˆ»çš„å¯è§‚æµ‹äº‹ä»¶]"]
  }
}
\`\`\`

`;

    let finalPrompt = basePrompt;

    // ã€è¯•éªŒé˜¶æ®µã€‘æ£€æµ‹æ˜¯å¦éœ€è¦æ³¨å…¥ABCæƒ…æ„Ÿæ²‰æµ¸æµæ¨¡å—ï¼ˆåªä½¿ç”¨æ˜¾å¼å¼€å…³ï¼‰
    const isImmersionModeExplicit = playerNarrativeFocus.includes('[IMMERSION_MODE]');

    if (isImmersionModeExplicit) {
        this.info("ğŸ’• [è¯•éªŒ] æ£€æµ‹åˆ°[IMMERSION_MODE]æ ‡è®°ï¼Œæ­£åœ¨æŒ‚è½½ã€ABCæ²‰æµ¸æµã€‘æˆ˜æœ¯æ¨¡å—...");
        finalPrompt += '\n\n' + IMMERSION_MODE_PROMPT;
    }

    // V7.0 ç­–ç•¥æ¨¡å¼æ³¨å…¥ï¼šæ ¹æ®å™äº‹æ¨¡å¼åŠ¨æ€åŠ è½½ç­–ç•¥
    if (currentMode === 'web_novel') {
        this.info("ğŸ”¥ å™äº‹ç­–ç•¥ï¼šç½‘æ–‡æ¨¡å¼");
        finalPrompt += '\n\n' + WEB_NOVEL_STRATEGY_PROMPT;
    } else if (currentMode === 'classic_rpg') {
        this.info("ğŸ­ å™äº‹ç­–ç•¥ï¼šæ­£å‰§æ¨¡å¼");
        finalPrompt += '\n\n' + CLASSIC_RPG_STRATEGY_PROMPT;
    }

    // åœ¨å‡½æ•°çš„æœ€åï¼Œè¿”å›æœ€ç»ˆæ„å»ºå¥½çš„Promptå­—ç¬¦ä¸²
    return BACKEND_SAFE_PASS_PROMPT + finalPrompt;
}

}