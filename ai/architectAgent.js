// ai/architectAgent.js
import { createLogger } from '../utils/logger.js';
const logger = createLogger('AIä»£ç†');

import { Agent } from './Agent.js';
import { BACKEND_SAFE_PASS_PROMPT } from './prompt_templates.js';
import { repairAndParseJson } from '../utils/jsonRepair.js';
import { deepmerge } from '../utils/deepmerge.js';
import { PromptBuilder } from '../src/managers/PromptBuilder.js';

const safeLocalStorageGet = (key) => {
    if (typeof localStorage === 'undefined') {
        return null;
    }
    try {
        return localStorage.getItem(key);
    } catch (error) {
        logger.warn(`[ArchitectAgent] æ— æ³•è¯»å– localStorage é”® "${key}"`, error);
        return null;
    }
};


// ã€è¯•éªŒé˜¶æ®µã€‘æˆ˜æœ¯æ¨¡å—ï¼šABCæƒ…æ„Ÿæ²‰æµ¸æµï¼ˆæŒ‰éœ€æ³¨å…¥ï¼‰
const IMMERSION_MODE_PROMPT = `
é™„åŠ æ¨¡å—_æƒ…æ„Ÿæ²‰æµ¸æµ_ABC_Immersion_Flow:

  æˆ˜æœ¯çŠ¶æ€: å·²æ¿€æ´»ï¼Œå¯åŠ¨é«˜ç»´æƒ…æ„Ÿè®¾è®¡ç®—æ³•

  æ ¸å¿ƒç›®æ ‡: æ‹’ç»é€šç”¨æ¨¡æ¿ï¼Œæœ¬ç« çš„æ—¥å¸¸äº’åŠ¨å¿…é¡»æ˜¯åªæœ‰è¿™å‡ ä¸ªäººç‰©åœ¨åªæœ‰è¿™ä¸ªç‰¹å®šæ—¶åˆ»æ‰èƒ½å‘ç”Ÿçš„å”¯ä¸€è§£

  ç»“æ„æ³•åˆ™_ABCç»“æ„:
    Phase_A_å‰50%:
      åç§°: ç°å®æ²‰æµ¸
      ç­–ç•¥: åˆ©ç”¨é«˜è‡ªç”±åº¦ç©ºé—´å»ºç«‹æå…·çœŸå®æ„Ÿçš„ç¯å¢ƒåŸºè°ƒ
      è®¸å¯: å…è®¸æ— æ•ˆä½†æœ‰è¶£çš„åºŸè¯ï¼Œåªè¦å®ƒç¬¦åˆäººè®¾
    Phase_B_ä¸­25%:
      åç§°: ç‹¬å®¶å˜è°ƒ
      ç­–ç•¥: è®¾è®¡ä¸€ä¸ªä¸å¯æ›¿ä»£çš„æƒ…æ„Ÿè·¯å¾„è‡ªç„¶çš„è½¬æŠ˜ç‚¹
    Phase_C_å25%:
      åç§°: æ¶Ÿæ¼ªç€é™†
      ç­–ç•¥: æƒ…æ„Ÿæ­éœ²åç”¨å¿ƒç…§ä¸å®£çš„é»˜å¥‘æˆ–æ–°çš„å¹³è¡¡æ”¶å°¾
      ç¦ä»¤: ç¦æ­¢çŒåœ

  çµæ„Ÿç´ æåº“_ä»…ä¾›å‚è€ƒ:
    è¯´æ˜: å‚è€ƒä»¥ä¸‹ç­–ç•¥å¯»æ‰¾åˆ‡å…¥ç‚¹ï¼Œä½†å¿…é¡»ç»“åˆäººç‰©å…³ç³»è¿›è¡Œç‹¬å®¶å®šåˆ¶
    ç­–ç•¥1_ä»·å€¼é‡ä¼°: å¼•å…¥æ—§ç‰©æˆ–ä¹ æƒ¯ï¼Œé€šè¿‡ä¸–ä¿—ä»·å€¼ä¸æƒ…æ„Ÿä»·å€¼çš„åå·®åˆ¶é€ å†²å‡»ï¼Œä¾‹å¦‚å¤©ä»·å¡ç‰‡ä¸å–
    ç­–ç•¥2_æŠ•å°„åšå¼ˆ: å€Ÿç”±è¯„ä»·ç¬¬ä¸‰æ–¹äº‹ç‰©å¦‚ç”µå½±æˆ–è·¯äººï¼Œå½±å°„è‡ªèº«å…³ç³»çš„å›°å¢ƒæˆ–ç¾ç»Šï¼Œä¾‹å¦‚åæ§½ç”µå½±ç”·ä¸»
    ç­–ç•¥3_æŠ€èƒ½ç ´ç»½: è§’è‰²åœ¨æ“…é•¿é¢†åŸŸå‡ºç°åå¸¸å¤±è¯¯å¦‚æ‰‹æŠ–æˆ–èµ°ç¥ï¼Œæ­ç¤ºå› è¿‡äºåœ¨ä¹è€Œä¹±äº†å¿ƒç¥
    ç­–ç•¥4_ç‰©ç†å…¥ä¾µ: ç¯å¢ƒçªå˜å¦‚åœç”µæˆ–æš´é›¨å¼ºè¿«ç‰©ç†è·ç¦»æ‹‰è¿‘ï¼Œå¯¼è‡´å¿ƒç†é˜²å¾¡å´©å¡Œ
    ç­–ç•¥5_æ¸¸æˆè¶Šç•Œ: ç©ç¬‘æˆ–æ‰“èµŒé€æ¸è¿‡ç«ï¼Œå€Ÿç€æ¸¸æˆè§„åˆ™çš„æ©æŠ¤è¯´å‡ºä¸æ•¢è¯´çš„çœŸå¿ƒè¯
    ç­–ç•¥6_æ—¶é—´é”™ä½: æåŠè¿‡å»çš„çº¦å®šä¸ç°çŠ¶çš„åå·®ï¼Œå¼•å‘é—æ†¾æˆ–åº†å¹¸çš„å…±é¸£

  è®¾è®¡é“å¾‹:
    è§„åˆ™1_å”¯ä¸€æ€§æ£€æŸ¥: å¦‚æœæŠŠè§’è‰²æ¢æˆå…¶ä»–äººè¿™ä¸ªäº’åŠ¨æ˜¯å¦è¿˜æˆç«‹ï¼Œå¦‚æœæˆç«‹ç«‹å³é‡å†™
    è§„åˆ™2_é€»è¾‘å†…æ°: å˜è°ƒå¥‘æœºä¸èƒ½æ˜¯æœºæ¢°çš„æ„å¤–ï¼Œå¿…é¡»æºäºè§’è‰²æ€§æ ¼ä¸å½“å‰ç¯å¢ƒçš„åŒ–å­¦ååº”
    è§„åˆ™3_æƒ…æ„Ÿè¿é”: å˜è°ƒåè§’è‰²çš„æƒ…æ„Ÿååº”å¿…é¡»æ˜¯å‰å› åæœï¼Œç¦æ­¢çªå…€çš„æƒ…ç»ªåˆ‡æ¢
    è§„åˆ™4_æƒ…æ„Ÿè·å¾—æ„Ÿ: ç€é™†å¿…é¡»è®©ç©å®¶æ¸…æ™°æ˜æ˜¾æ„Ÿå—åˆ°æƒ…æ„Ÿåˆ°è¾¾äº†ä¹‹å‰æ²¡æœ‰åˆ°è¾¾çš„æ–°å°é˜¶ï¼Œè€Œä¸æ˜¯å‰§æƒ…å°±è¿™ä¹ˆç»“æŸäº†

  å¼ºåˆ¶è¾“å‡ºè¦æ±‚_è®¾è®¡é€»è¾‘è‡ªè¾©:
    è¯´æ˜: åœ¨design_notesä¸­å¿…é¡»æ–°å¢elevation_design_logicå­—æ®µï¼Œä½ å¿…é¡»åƒå¯¼æ¼”é˜è¿°åˆ†é•œä¸€æ ·è§£é‡Šä½ çš„è®¾è®¡æ€è·¯
    elevation_design_logicå­—æ®µç»“æ„:
      reference_strategy: å‚è€ƒäº†ç´ æåº“ä¸­çš„å“ªä¸ªç­–ç•¥æˆ–è€…è‡ªåˆ›ç­–ç•¥
      unique_spark: ä¸€å¥è¯æè¿°ä½ è®¾è®¡çš„æ ¸å¿ƒåˆ›æ„ç‚¹ï¼Œä¾‹å¦‚ä¸æ˜¯ç”µå½±çƒ‚è€Œæ˜¯ç”µå½±æƒ…èŠ‚è¯¯ä¼¤äº†Açš„ç§˜å¯†
      irreplaceability_defense: è‡ªè¿°é€»è¾‘ä¸ºä»€ä¹ˆè¿™ä¸ªæƒ…èŠ‚åªèƒ½å‘ç”Ÿåœ¨æ­¤æ—¶æ­¤åœ°ï¼Œä¾‹å¦‚æ™®é€šäººçœ‹çƒ‚ç‰‡åªæ˜¯åæ§½ä½†åªæœ‰Aä¼šå› ä¸ºé‚£ä¸ªæƒ…èŠ‚è”æƒ³åˆ°å½“åˆçš„é‚£ä¸ªçº¦å®šè¿™æ˜¯å±äºä»–ä»¬ä¸¤äººçš„ç‹¬å®¶å¯†ç 
      pacing_allocation:
        phase_A_content: èŠ‚æ‹1åˆ°Xå…·ä½“çš„æ—¥å¸¸å¡«å……ç‰©
        phase_B_bridge: èŠ‚æ‹Xåˆ°Yå…·ä½“çš„å˜è°ƒå¥‘æœºä¸é€»è¾‘é“¾
        phase_C_landing: èŠ‚æ‹Yåˆ°Endæƒ…æ„Ÿè½åœ°çš„å…·ä½“ç”»é¢
`;

export class ArchitectAgent extends Agent {

    constructor(...args) {
        super(...args);
        // è·å–promptManagerå®ä¾‹
        this.promptManager = null;
    }

    /**
     * æ³¨å…¥promptManagerå®ä¾‹
     * @param {PromptManager} manager - æç¤ºè¯ç®¡ç†å™¨å®ä¾‹
     */
    setPromptManager(manager) {
        this.promptManager = manager;
    }

    async execute(context, abortSignal = null) {
        this.diagnose(`--- ç« èŠ‚å»ºç­‘å¸ˆAI V9.2 (Function Fix) å¯åŠ¨ --- æ­£åœ¨åŠ¨æ€è§„åˆ’æ–°ç« èŠ‚...`);
        const prompt = this._createPrompt(context);

        // ã€å¢å¼ºæ—¥å¿—ã€‘æ‰“å°å»ºç­‘å¸ˆå®Œæ•´è¾“å…¥åˆ°æ§åˆ¶å°
        console.group('ğŸ“ [ç« èŠ‚å»ºç­‘å¸ˆ - å®Œæ•´è¾“å…¥] Architect AI Input Prompt');
        console.log('==================== å¼€å§‹ ====================');
        console.log(prompt);
        console.log('==================== ç»“æŸ ====================');
        console.groupEnd();

        try {
            // ğŸ”¥ é™é»˜æµå¼å›è°ƒï¼šåå°æ¥æ”¶æ•°æ®ä½†ä¸æ˜¾ç¤ºç»™ç”¨æˆ·ï¼Œé¿å…è¶…æ—¶é—®é¢˜
            const silentStreamCallback = (_chunk) => {
                // é™é»˜æ¥æ”¶ï¼Œä¸è§¦å‘UIäº‹ä»¶ï¼Œåªä¿æŒè¿æ¥æ´»è·ƒ
            };

            const responseText = await this.deps.mainLlmService.callLLM(
                [{ role: 'user', content: prompt }],
                silentStreamCallback,  // ğŸ‘ˆ ä½¿ç”¨é™é»˜æµå¼å›è°ƒ
                abortSignal
            );

            // ã€å¢å¼ºæ—¥å¿—ã€‘æ‰“å°å»ºç­‘å¸ˆå®Œæ•´è¾“å‡ºåˆ°æ§åˆ¶å°
            console.group('ğŸ“‹ [ç« èŠ‚å»ºç­‘å¸ˆ - å®Œæ•´è¾“å‡º] Architect AI Raw Output');
            console.log('==================== å¼€å§‹ ====================');
            console.log(responseText);
            console.log('==================== ç»“æŸ ====================');
            console.groupEnd();
            
            const cleanedResponseText = this._stripLogicCheckBlock(responseText);
            let potentialJsonString;
            const codeBlockMatch = cleanedResponseText.match(/```json\s*([\s\S]*?)\s*```/);
            if (codeBlockMatch && codeBlockMatch[1]) {
                potentialJsonString = codeBlockMatch[1].trim();
            } else {
                const firstBrace = cleanedResponseText.indexOf('{');
                const lastBrace = cleanedResponseText.lastIndexOf('}');
                if (firstBrace === -1 || lastBrace === -1 || lastBrace < firstBrace) {
                    throw new Error("AIå“åº”ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONå¯¹è±¡ç»“æ„ã€‚");
                }
                potentialJsonString = cleanedResponseText.substring(firstBrace, lastBrace + 1);
            }
            
            const result = repairAndParseJson(potentialJsonString, this);
            this._validateArchitectResult(result);

            this.info("--- ç« èŠ‚å»ºç­‘å¸ˆAI V10.0 --- æ–°ç« èŠ‚çš„åˆ›ä½œè“å›¾å·²æˆåŠŸç”Ÿæˆã€‚");
            return { 
                new_chapter_script: result.chapter_blueprint, // ç›´æ¥ä¼ é€’å¯¹è±¡
                design_notes: result.design_notes, // è®¾è®¡ç¬”è®°ä½œä¸ºå…ƒæ•°æ®ä¿ç•™
                raw_response: responseText
            };

        } catch (error) {
            if (error.name === 'AbortError') {
                throw error; // Re-throw AbortError to be handled upstream
            }
            this.diagnose("--- ç« èŠ‚å»ºç­‘å¸ˆAI V10.0 æ„æ€å¤±è´¥ ---", error);
            if (this.toastr) {
                this.toastr.error(`ç« èŠ‚è“å›¾æ„æ€å¤±è´¥: ${error.message.substring(0, 200)}...`, "å»ºç­‘å¸ˆAIé”™è¯¯");
            }
            return null;
        }
    }

    _validateArchitectResult(result) {
        const baseError = "ç« èŠ‚å»ºç­‘å¸ˆAIæœªèƒ½è¿”å›æœ‰æ•ˆçš„è“å›¾å“åº”";
        if (!result || typeof result !== 'object') {
            throw new Error(`${baseError}ï¼šæ ¹å¯¹è±¡ä¸ºç©ºã€‚`);
        }

        const blueprint = result.chapter_blueprint;
        if (!blueprint || typeof blueprint !== 'object') {
            throw new Error(`${baseError}ï¼šç¼ºå°‘ chapter_blueprintã€‚`);
        }

        if (!Array.isArray(blueprint.plot_beats) || blueprint.plot_beats.length === 0) {
            throw new Error(`${baseError}ï¼šplot_beats ä¸å­˜åœ¨æˆ–ä¸ºç©ºã€‚`);
        }

        if (!blueprint.chapter_core_and_highlight || !blueprint.chapter_core_and_highlight.highlight_design_logic) {
            throw new Error(`${baseError}ï¼šç¼ºå°‘ chapter_core_and_highlight.highlight_design_logicã€‚`);
        }

        const designNotes = result.design_notes;
        if (!designNotes || typeof designNotes !== 'object') {
            throw new Error(`${baseError}ï¼šdesign_notes ç¼ºå¤±ã€‚`);
        }

        const mandatoryNoteKeys = ['player_focus_execution', 'event_priority_report', 'emotional_tone_strategy'];
        const missingKeys = mandatoryNoteKeys.filter((key) => !designNotes[key]);
        if (missingKeys.length) {
            throw new Error(`${baseError}ï¼šdesign_notes ç¼ºå°‘å­—æ®µ ${missingKeys.join(', ')}ã€‚`);
        }

        if (!designNotes.event_priority_report?.beat_allocation) {
            throw new Error(`${baseError}ï¼ševent_priority_report.beat_allocation ç¼ºå¤±ã€‚`);
        }
    }

// architectAgent.js

/**
 * è·å–åŸºç¡€æç¤ºè¯æ¨¡æ¿
 * @returns {string} åŸºç¡€æç¤ºè¯
 */
_getBasePromptTemplate() {
    // å¦‚æœæœ‰è‡ªå®šä¹‰æç¤ºè¯ä¸”promptManagerå·²æ³¨å…¥ï¼Œåˆ™ä½¿ç”¨è‡ªå®šä¹‰çš„
    if (this.promptManager && this.promptManager.hasCustomArchitectPrompt()) {
        return this.promptManager.getArchitectPrompt();
    }

    // å¦åˆ™ä½¿ç”¨é»˜è®¤çš„basePrompt
    return this._getDefaultBasePrompt();
}

/**
 * åŠ¨æ€ç”ŸæˆJSONè¾“å‡ºæ ‡å‡†
 * @param {Object} config - é…ç½®å¯¹è±¡
 * @param {string} config.beatCountRange - èŠ‚æ‹æ•°é‡åŒºé—´
 * @param {string} config.playerNarrativeFocus - ç©å®¶å™äº‹ç„¦ç‚¹
 * @param {boolean} config.hasImmersionMode - æ˜¯å¦å¯ç”¨æ²‰æµ¸æ¨¡å¼
 * @param {boolean} config.isEntityRecallEnabled - æ˜¯å¦å¯ç”¨å®ä½“å¬å›
 * @returns {string} JSONè¾“å‡ºæ ‡å‡†çš„æ–‡æœ¬æè¿°
 */
_generateOutputSpecification(config) {
    const { beatCountRange, playerNarrativeFocus, hasImmersionMode, isEntityRecallEnabled } = config;

    // åŸºç¡€è¾“å‡ºç»“æ„ï¼ˆæ‰€æœ‰æ¨¡å¼å…±ç”¨ï¼‰
    let outputSpec = `**ã€ã€ã€ JSON è¾“å‡ºç»“æ„ ã€‘ã€‘ã€‘**

\`\`\`json
{
  "design_notes": {
    "player_focus_execution": {
      "player_instruction": "${playerNarrativeFocus.replace(/"/g, '\\"')}",
      "execution_logic": "[è¯¦ç»†è¯´æ˜ï¼šä½ æ˜¯å¦‚ä½•å°†ç©å®¶ç„¦ç‚¹å’Œç©å®¶è¡¥å……ï¼ˆchapter_blueprint.player_supplement / storyline.player_supplementï¼‰ä½œä¸ºæœ€é«˜ä¼˜å…ˆçº§æ‰§è¡Œçš„ï¼Ÿ]",
      "conflict_resolution": "[å¦‚æœç©å®¶æ„è§ä¸å…³ç³»å›¾è°±ã€æ•…äº‹çº¿ã€èŠ‚å¥å¡”ç­‰æ•°æ®äº§ç”Ÿå†²çªï¼Œä½ æ˜¯å¦‚ä½•å¤„ç†çš„ï¼Ÿå¿…é¡»è¯´æ˜ï¼šä½ æ˜¯å¦éµå¾ªäº†'å§‹ç»ˆä»¥ç©å®¶æ„è§ä¸ºå‡†'çš„åŸåˆ™]"
    },
    "dual_horizon_analysis": "[å¹³è¡¡çŸ­æœŸç„¦ç‚¹ä¸é•¿æœŸæ•…äº‹çº¿çš„ç­–ç•¥]",
    "emotional_tone_strategy": {
        "core_emotional_tone": "[ä½ åˆ¤æ–­æœ¬ç« çš„æ ¸å¿ƒæƒ…æ„ŸåŸºè°ƒæ˜¯ä»€ä¹ˆï¼Ÿ]",
        "chosen_storylines_and_reasoning": "[ä½ æœ€ç»ˆé€‰æ‹©äº†å“ª1-2æ¡æ•…äº‹çº¿ï¼Ÿ]",
        "compatibility_check": "[è¯¦ç»†è§£é‡Šä½ é€‰æ‹©çš„æ¬¡è¦æ•…äº‹çº¿ï¼Œæ˜¯å¦‚ä½•ä¸æ ¸å¿ƒåŸºè°ƒè¾¾æˆ'ç›¸å®¹'çš„]"
    },
    "chronology_compliance": "[æ—¶æ®µ/å…‰çº¿/NPCè°ƒåº¦çš„åˆç†æ€§è¯´æ˜]",
    "event_priority_report": {
        "S_tier_events": ["[æœ¬ç« çš„ç»å¯¹æ ¸å¿ƒï¼Œå æ®ä¸»å¯¼åœ°ä½]"],      "A_tier_events": ["[æ ¸å¿ƒç‰©ç†ç›®æ ‡]"],
        "B_tier_events": ["[æ—¥å¸¸/æ¬¡è¦äº’åŠ¨ - ä¸¥ç¦åŒ…å«è¢«å‹ç¼©çš„é«˜èƒ½äº‹ä»¶]"],
        "deferred_events": ["[ä¸ºäº†ä¿è¯è´¨é‡è€Œå®Œæ•´æ¨è¿Ÿçš„é«˜å‹äº‹ä»¶]"],
        "priority_conflict_resolution": "[å¿…å¡«ï¼šä½ æ˜¯å¦ä¸ºäº†ä¿æŠ¤Sçº§äº‹ä»¶çš„çº¯åº¦ï¼Œè€Œç‰ºç‰²äº†ç‰©ç†ä»»åŠ¡çš„ç¯‡å¹…ï¼Ÿæˆ–è€…ä¸ºäº†ä¿æŠ¤Sçº§äº‹ä»¶çš„è´¨é‡ï¼Œè€Œé€‰æ‹©äº†å»¶åï¼Ÿ]",
        "beat_allocation": { "S_tier_beats": 0, "A_tier_beats": 0, "B_tier_beats": 0, "total_beats": 0 }
    },
    "aesthetic_innovation_report": "[è¯†åˆ«é«˜é¢‘å…ƒç´ å¹¶æå‡ºåˆ›æ–°æ›¿ä»£æ–¹æ¡ˆ]",

    // ========== å¤šå·´èƒºå·¥ç¨‹éªŒè¯ ==========
    "dopamine_blueprint": {
      "exclusivity_justification": "[ä¸ºä»€ä¹ˆåªæœ‰ä¸»è§’èƒ½åšåˆ°ï¼ŸåŸºäºä»€ä¹ˆç‹¬ç‰¹æ€§ï¼Ÿ]",
      "trope_innovation": "[ä½¿ç”¨äº†ä»€ä¹ˆå¥—è·¯ï¼Ÿå¦‚ä½•ç¿»æ–°ï¼Ÿ]",
      "tangible_rewards": "[å®è´¨å¥–åŠ±åŠå³æ—¶ä»·å€¼]",
      "hook_design": "[æŠ›å‡ºçš„æ–°é’©å­]"
    },
`;

    // å¦‚æœå¯ç”¨æ²‰æµ¸æ¨¡å¼ï¼Œæ·»åŠ æ²‰æµ¸æ¨¡å¼å­—æ®µ
    if (hasImmersionMode) {
        outputSpec += `
    // ========== æ²‰æµ¸æ¨¡å¼ä¸“å±å­—æ®µ ==========
    "elevation_design_logic": {
      "reference_strategy": "[å‚è€ƒç­–ç•¥æˆ–è‡ªåˆ›]",
      "unique_spark": "[æ ¸å¿ƒåˆ›æ„ç‚¹]",
      "irreplaceability_defense": "[ç‹¬ç‰¹æ€§è‡ªè¾©]",
      "pacing_allocation": {
        "phase_A_content": "[æ—¥å¸¸å¡«å……ç‰©]",
        "phase_B_bridge": "[å˜è°ƒå¥‘æœº]",
        "phase_C_landing": "[æƒ…æ„Ÿè½åœ°]"
      }
    },
`;
    }

    // æ·»åŠ é€šç”¨å­—æ®µ
    outputSpec += `
    // ========== åŒå±‚åŠ¨æœºè®º - é€»è¾‘è‡ªè¾© ==========
    "affinity_logic_audit": {
      "target_character": "[æœ¬ç« ä¸»è¦äº’åŠ¨çš„NPCå]",
      "current_affinity_stage": "[æ•°å€¼] (ä¾‹å¦‚ï¼š20-ç†Ÿæ‚‰/ä¸­ç«‹)",
      "planned_action": "[ä½ è®¾è®¡çš„æ ¸å¿ƒäº’åŠ¨è¡Œä¸º]",
      "biological_layer_check": "[ç¬¬ä¸€å±‚æ£€éªŒï¼šå‰¥ç¦»æ€§æ ¼åï¼Œè¿™ä¸ªå¥½æ„Ÿåº¦æ•°å€¼æ˜¯å¦è¶³ä»¥æ”¯æ’‘è¿™ä¸ªè¡Œä¸ºï¼Ÿæ˜¯å¦ç¬¦åˆç”Ÿç‰©å¼•åŠ›æ³•åˆ™ï¼Ÿ]",
      "personality_layer_justification": "[ç¬¬äºŒå±‚è¯´æ˜ï¼šæ€§æ ¼å¦‚ä½•ä¿®é¥°è¿™ä¸ªè¡Œä¸ºçš„è¡¨è¾¾æ–¹å¼ï¼Ÿä¾‹å¦‚ï¼š'å‚²å¨‡è§’è‰²è™½ç„¶å…³å¿ƒï¼Œä½†ä¼šç”¨åè¯è¡¨è¾¾']"
    },

    "new_entities_proposal": "[å¯é€‰ï¼šNEW:å‰ç¼€å®ä½“çš„å®šä¹‰è¯´æ˜]",
    "storyline_weaving": "[é€‰æ‹©äº†å“ª1-2æ¡æ•…äº‹çº¿åŠç†ç”±ï¼ˆè‹¥æœ‰æ¬¡è¦çº¿è¯·è¯´æ˜å¦‚ä½•å…¼å®¹ï¼‰]",
    "connection_and_hook": "[æ‰¿ä¸Šå¯ä¸‹è¯´æ˜ + è½¯ç€é™†/æƒ…æ„Ÿæ‚¬å´–/åé’©å›å¼¹çš„é’©å­è®¾è®¡]",
    "ending_structure_choice": "[æƒ…æ„Ÿæ‚¬å´– / è½¯ç€é™† / åé’©å›å¼¹] - è¯´æ˜ä½ ä¸ºä»€ä¹ˆé€‰æ‹©åœ¨è¿™ä¸ªç‚¹åˆ‡æ–­å‰§æƒ…ï¼Ÿ",
    "deus_ex_machina_check": {
      "conflict_origin": "[æœ¬ç« å†²çªçš„é€»è¾‘æºå¤´]",
      "hook_rationality": "[é’©å­å¦‚ä½•ä»æœ¬ç« è‡ªç„¶å»¶ä¼¸]"
    }
  },
  "chapter_blueprint": {
    "title": "[ç« èŠ‚å]",${isEntityRecallEnabled ? `
    "chapter_context_ids": ["char_A", "loc_B", "NEW:item_C"],` : ''}
    "player_narrative_focus": "${playerNarrativeFocus.replace(/"/g, '\\"')}",
    "plot_beats": [
      {
        "beat_id": "ã€èŠ‚æ‹1ï¼šå®Œæ•´äº‹ä»¶åç§°ã€‘",
        "type": "Action",  // Action | Dialogue Scene | Transition | Internal Transition | Reflection
        "physical_event": "[æƒ…æ™¯è®¾ç½®ï¼šåœ¨ä»€ä¹ˆç¯å¢ƒä¸‹å‘ç”Ÿä»€ä¹ˆ] + [äº¤äº’ä¸»é¢˜ï¼šå¯¹è¯åº”å›´ç»•ã€XXä¸»é¢˜ã€‘/åŠ¨ä½œçš„æ ¸å¿ƒç›®æ ‡] + [æƒ…æ„Ÿæ–¹å‘ï¼šåŸºè°ƒä¸ºã€XXã€‘ï¼Œç›®çš„æ˜¯è®©è§’è‰²è¾¾æˆã€XXã€‘]",
        "environment_state": "[å¯é€‰ï¼šå…‰å½±/å£°éŸ³/æ°›å›´çš„å¼•å¯¼å»ºè®®]",
        "state_change": "[å¯é€‰ï¼šå…³ç³»/ä»»åŠ¡æ›´æ–° (æƒ…æ„Ÿå†²å‡»:X/10)]",
        "exit_condition": "[ä»…Dialogue Sceneï¼šå¯è§‚æµ‹ç»“æŸæ¡ä»¶ï¼Œå¦‚'è¾¾æˆå…±è¯†'ã€'ä¸€æ–¹ç¦»å¼€'ç­‰]",
        "is_highlight": false,
        "subtext_design": "[å¯é€‰ï¼šå¯¹è¯æ½œå°è¯çš„ä¸»é¢˜æ–¹å‘ï¼ˆè€Œéå…·ä½“å°è¯ï¼‰ï¼Œå¦‚'è¡¨é¢è°ˆè®ºä»»åŠ¡ï¼Œå®åˆ™è¯•æ¢å¯¹æ–¹å¿ è¯šåº¦']"
      }
      // æ•°é‡å¿…é¡»åœ¨ ${beatCountRange} èŒƒå›´å†…
    ],
    "chapter_core_and_highlight": {
      "creative_core": "[å”¯ä¸€æ ¸å¿ƒä½“éªŒ]",
      "highlight_design_logic": {
        "target_beat_id": "[å¯¹åº”å“ªä¸ªèŠ‚æ‹ï¼Ÿ]",
        "amplification_technique": "[ä½ å»ºè®®ä½¿ç”¨ä»€ä¹ˆæŠ€æ³•ï¼Ÿä¾‹å¦‚ï¼š'æ—¶é—´æ‹‰ä¼¸'ã€'æ„Ÿå®˜å‰¥å¤º']",
        "unique_execution": "[è‰ºæœ¯æŒ‡å¯¼æ–¹å‘ï¼š**é‡ç‚¹æ˜¯æŒ‡å¯¼æ–¹å‘**è€Œéå…·ä½“å†…å®¹ã€‚ä¾‹å¦‚ï¼š'å»ºè®®èšç„¦ç‰©ç†ç»†èŠ‚å±‚é¢ï¼ˆå¦‚ç‰©ä½“çŠ¶æ€å˜åŒ–ã€å¾®è§‚ç”Ÿç†ååº”ï¼‰ï¼Œé¿å…ç›´æ¥æå†™å¿ƒç†æ´»åŠ¨'ã€‚]",
        "emotional_impact_goal": "[é¢„æœŸçš„æƒ…æ„Ÿç›®æ ‡ï¼šè®©ç©å®¶æ„Ÿåˆ°å›°æƒ‘/éœ‡æ’¼/çª’æ¯ï¼Œè€Œä¸æ˜¯è·å¾—ä¿¡æ¯]"
      },
      "highlight_directive": {
        "target_beat": "[é«˜å…‰èŠ‚æ‹ID]",
        "instructions": [
          "[è‰ºæœ¯æŒ‡ä»¤1ï¼šå¦‚'å¼ºåŒ–æ„Ÿå®˜å±‚é¢çš„æ—¶é—´å»¶å±•æ„Ÿ']",
          "[è‰ºæœ¯æŒ‡ä»¤2ï¼šå¦‚'å»ºè®®èå…¥è§’è‰²çš„æ ¸å¿ƒè®°å¿†ç¢ç‰‡']",
          "[è‰ºæœ¯æŒ‡ä»¤3ï¼šå¦‚'é¿å…ç›´æ¥è¯´æ˜æƒ…æ„Ÿï¼Œé€šè¿‡ç”Ÿç†ååº”æš—ç¤º']"
        ]
      }
    }
  }
}
\`\`\`
`;

    return outputSpec;
}

/**
 * è·å–å®Œæ•´çš„é»˜è®¤æç¤ºè¯ï¼ˆåŒ…å«ç¤ºä¾‹æ•°æ®ï¼Œç”¨äºå¯¼å‡ºï¼‰
 * @returns {string} å®Œæ•´çš„é»˜è®¤æç¤ºè¯
 */
getCompleteDefaultPrompt() {
    // åˆ›å»ºç¤ºä¾‹ä¸Šä¸‹æ–‡æ•°æ®ç”¨äºç”Ÿæˆå®Œæ•´æ¨¡æ¿
    const exampleContext = {
        chapter: {
            staticMatrices: {
                characters: {},
                worldview: {},
                storylines: {
                    main_quests: {},
                    side_quests: {},
                    relationship_arcs: {},
                    personal_arcs: {}
                },
                relationship_graph: { edges: [] }
            },
            dynamicState: {
                storylines: {
                    main_quests: {},
                    side_quests: {},
                    relationship_arcs: {},
                    personal_arcs: {}
                },
                stylistic_archive: {
                    imagery_and_metaphors: [],
                    frequent_descriptors: { adjectives: [], adverbs: [] },
                    sensory_patterns: []
                },
                chronology: {
                    day_count: 1,
                    time_slot: "evening",
                    weather: null,
                    last_rest_chapter: null
                }
            },
            meta: {
                longTermStorySummary: "æ•…äº‹æ‘˜è¦ç¤ºä¾‹",
                narrative_control_tower: {
                    narrative_mode: { current_mode: 'classic_rpg' }
                }
            },
            playerNarrativeFocus: 'ç¤ºä¾‹ç©å®¶ç„¦ç‚¹',
            chapter_blueprint: {}
        },
        firstMessageContent: null,
        leaderMessageContent: null
    };

    // è°ƒç”¨_createPromptç”Ÿæˆå®Œæ•´æ¨¡æ¿ï¼ˆå¸¦ç¤ºä¾‹æ•°æ®ï¼‰
    return this._createPrompt(exampleContext);
}

/**
 * è·å–é»˜è®¤çš„åŸºç¡€æç¤ºè¯ï¼ˆç”¨äºUIæ˜¾ç¤ºï¼‰
 * @returns {string} ç®€çŸ­çš„é»˜è®¤æç¤ºè¯è¯´æ˜
 */
_getDefaultBasePrompt() {
    // UIä¸­æ˜¾ç¤ºç®€çŸ­æç¤º
    return `æç¤ºï¼šå»ºç­‘å¸ˆæç¤ºè¯ä¸ºçº¦900è¡Œçš„å¤æ‚æ¨¡æ¿ï¼ŒåŒ…å«åŠ¨æ€æ•°æ®æ³¨å…¥ã€‚

å¦‚éœ€æŸ¥çœ‹å®Œæ•´å†…å®¹ï¼Œè¯·ä½¿ç”¨"å¯¼å‡º"åŠŸèƒ½ã€‚å¯¼å‡ºçš„æ–‡ä»¶å°†åŒ…å«å½“å‰ä½¿ç”¨çš„å®Œæ•´æç¤ºè¯æ¨¡æ¿ã€‚

å¦‚éœ€è‡ªå®šä¹‰ï¼Œæ‚¨å¯ä»¥ï¼š
1. ç‚¹å‡»"å¯¼å‡º"æŒ‰é’®ï¼Œå°†é»˜è®¤æ¨¡æ¿ä¿å­˜ä¸ºæ–‡ä»¶
2. åœ¨æ–‡æœ¬ç¼–è¾‘å™¨ä¸­ç¼–è¾‘è¯¥æ–‡ä»¶
3. ä½¿ç”¨"å¯¼å…¥"æŒ‰é’®åŠ è½½æ‚¨ä¿®æ”¹åçš„æ¨¡æ¿

æ³¨æ„ï¼šæ¨¡æ¿ä¸­çš„åŠ¨æ€æ•°æ®ï¼ˆå¦‚è§’è‰²ä¿¡æ¯ã€æ•…äº‹çº¿ç­‰ï¼‰ä¼šåœ¨è¿è¡Œæ—¶è¢«ç³»ç»Ÿè‡ªåŠ¨æ³¨å…¥ã€‚`;
}

_createPrompt(context) {
    // ã€æ–°å¢ã€‘å¦‚æœæœ‰è‡ªå®šä¹‰æç¤ºè¯ï¼Œç›´æ¥ä½¿ç”¨ï¼ˆä¸è¿›è¡Œå˜é‡æ›¿æ¢ï¼‰
    if (this.promptManager && this.promptManager.hasCustomArchitectPrompt()) {
        const customPrompt = this.promptManager.getArchitectPrompt();
        this.info("[å»ºç­‘å¸ˆ] ä½¿ç”¨è‡ªå®šä¹‰æç¤ºè¯");
        // è‡ªå®šä¹‰æç¤ºè¯ä¼šåŠ ä¸Šå®‰å…¨é€šè¡Œè¯å‰ç¼€
        return BACKEND_SAFE_PASS_PROMPT + customPrompt;
    }

    // ã€å®ä½“å¬å›å¼€å…³æ£€æµ‹ã€‘é»˜è®¤å…³é—­
    const isEntityRecallEnabled = safeLocalStorageGet('sbt-entity-recall-enabled') === 'true';
    logger.debug(`[å»ºç­‘å¸ˆ] å®ä½“å¬å›æ¨¡å¼: ${isEntityRecallEnabled ? 'å¯ç”¨' : 'å…³é—­ï¼ˆé»˜è®¤ï¼‰'}`);

    // ã€é»˜è®¤æµç¨‹ã€‘ä½¿ç”¨ç³»ç»Ÿé»˜è®¤æç¤ºè¯ï¼ˆå¸¦åŠ¨æ€æ•°æ®æ³¨å…¥ï¼‰
    const { chapter, firstMessageContent, leaderMessageContent } = context;
            const currentWorldState = deepmerge(
            chapter.staticMatrices,
            chapter.dynamicState
        );
        const longTermStorySummary = chapter?.meta?.longTermStorySummary || "æ•…äº‹åˆšåˆšå¼€å§‹ã€‚";
        const playerNarrativeFocus = chapter?.playerNarrativeFocus || 'ç”±AIè‡ªä¸»åˆ›æ–°ã€‚';
        // V4.2: è·å–ç©å®¶è®¾ç½®çš„ç« èŠ‚èŠ‚æ‹æ•°é‡åŒºé—´
        const beatCountRange = safeLocalStorageGet('sbt-beat-count-range') || '8-10';
        // V8.0: æå–æ•…äº‹çº¿è¿½è¸ªæ•°æ®å’Œæ–‡ä½“æ¡£æ¡ˆ
        const staticStorylines = chapter?.staticMatrices?.storylines || {
            main_quests: {}, side_quests: {}, relationship_arcs: {}, personal_arcs: {}
        };
        const dynamicStorylines = chapter?.dynamicState?.storylines || {
            main_quests: {}, side_quests: {}, relationship_arcs: {}, personal_arcs: {}
        };
        const stylisticArchive = chapter?.dynamicState?.stylistic_archive || {
            imagery_and_metaphors: [],
            frequent_descriptors: { adjectives: [], adverbs: [] },
            sensory_patterns: []
        };
        // V6.0: æå–å¹´è¡¨ä¿¡æ¯
        const chronology = chapter?.dynamicState?.chronology || {
            day_count: 1,
            time_slot: "evening",
            weather: null,
            last_rest_chapter: null
        };
        let openingSceneContext = "æ— æŒ‡å®šçš„å¼€åœºç™½ï¼Œè¯·è‡ªç”±åˆ›ä½œå¼€ç¯‡ã€‚";
        const safeLeaderMessageContent = typeof leaderMessageContent === 'string' && leaderMessageContent.trim()
            ? leaderMessageContent.trim()
            : null;

    if (firstMessageContent) {
        openingSceneContext = firstMessageContent;
        this.info("å»ºç­‘å¸ˆæ£€æµ‹åˆ°å¼€åœºç™½ï¼Œå·²åˆ‡æ¢åˆ°'ç»­å†™æ¨¡å¼'ã€‚");
    }

    let basePrompt = `
æŒ‡ä»¤_è‡ªçœå¼å™äº‹è“å›¾åˆ›ä½œ_V13.0:

  èº«ä»½ç¡®è®¤: ä½ æ˜¯ä¸€ä½é¡¶çº§çš„æ‡‚å¾—å…‹åˆ¶ä¸èšç„¦è‰ºæœ¯çš„å™äº‹å»ºç­‘å¸ˆï¼Œä½ çš„ä»»åŠ¡æ˜¯è®¾è®¡ä¸€ä¸ªé«˜åº¦ä¸“æ³¨çš„æœåŠ¡äºå•ä¸€æ ¸å¿ƒæƒ…æ„Ÿä½“éªŒçš„åˆ›ä½œè“å›¾

  æ ¸å¿ƒè§’è‰²å®šä½_å»ºç­‘å¸ˆvså‰§ä½œå®¶:
    å®šä½: ä½ æ˜¯å»ºç­‘å¸ˆä¸æ˜¯ç¼–å‰§
    å«ä¹‰1: ä½ çš„è¾“å‡ºæ˜¯è“å›¾å³æŒ‡å¯¼æ–¹æ¡ˆï¼Œä¸æ˜¯å‰§æœ¬å³å…·ä½“å†…å®¹
    å«ä¹‰2: ä½ æä¾›æ¡†æ¶æ–¹å‘ä¸»é¢˜ï¼Œè€Œéå°è¯åŠ¨ä½œç»†èŠ‚å¿ƒç†æå†™
    å«ä¹‰3: ä½ è®¾è®¡æƒ…æ„Ÿæµå‘å’Œäº‹ä»¶æ¶æ„ï¼Œå…·ä½“çš„æ–‡å­—åˆ›ä½œç”±æ­£æ–‡AIå®Œæˆ

  è¯­è¨€è§„èŒƒç¤ºä¾‹:
    æ­£ç¡®ç¤ºä¾‹: å¯¹è¯åº”å›´ç»•ä¿¡ä»»ä¸èƒŒå›çš„ä¸»é¢˜å±•å¼€ï¼Œæƒ…æ„ŸåŸºè°ƒä¸ºå‹æŠ‘çš„è´¨é—®
    é”™è¯¯ç¤ºä¾‹: Aæ„¤æ€’åœ°è¯´ä½ ä¸ºä»€ä¹ˆè¦èƒŒå›æˆ‘ï¼ŒBæ²‰é»˜åœ°ä½ä¸‹å¤´

  æ ¸å¿ƒæé†’: èŠ‚æ‹å†…å®¹åº”è¯¥æ˜¯çƒ¹é¥ªæ­¥éª¤è€Œéæˆå“èœè‚´

  å™äº‹åˆ†çº§åè®®_æˆäººå‘:
    æ ¸å¿ƒæŒ‡ä»¤: æœ¬æ•…äº‹é¢å‘æˆå¹´è¯»è€…ï¼Œä½ å¿…é¡»æ‘’å¼ƒå„¿ç«¥æ–‡å­¦å¼çš„å»æ€§åŒ–æ€ç»´
    åŸåˆ™1_ç›´é¢æ¬²æœ›: äººç±»ä¸ä»…æœ‰æƒ…æ„Ÿè¿˜æœ‰æœ¬èƒ½ï¼Œå½“è§’è‰²å…³ç³»äº²å¯†æˆ–å¼ åŠ›æé«˜æ—¶å¿…é¡»ä½“ç°å‡ºæ€§å¼ åŠ›è‚¢ä½“æ¸´æœ›å’Œç”Ÿç†ååº”
    åŸåˆ™2_æ‹’ç»å‡€åŒ–: ä¸¥ç¦å°†æˆå¹´äººä¹‹é—´çš„æ¿€æƒ…å¤„ç†ä¸ºçº¯æ´çš„å‹è°Šï¼Œå¦‚æœæƒ…æ„Ÿåˆ°ä½æ¥å»æŠšæ‘¸ç”šè‡³æ›´è¿›ä¸€æ­¥çš„æ€§ä¸ä»…æ˜¯è¢«å…è®¸çš„è€Œä¸”æ˜¯è¢«é¼“åŠ±çš„å¿…é¡»çš„
    åŸåˆ™3_ç‰©ç†æ³•åˆ™: é«˜å¥½æ„Ÿåº¦ç­‰äºç‰©ç†è·ç¦»ç¼©çŸ­ï¼Œç›¸çˆ±çš„äººä¸ä¼šéš”ç€ä¸¤ç±³è¿œè¯´è¯ï¼Œè®©ä»–ä»¬è§¦ç¢°çº ç¼ æ„Ÿå—å½¼æ­¤çš„ä½“æ¸©

  è¯­è¨€ä¸ç»†èŠ‚è§„èŒƒ_å¼ºåˆ¶æ‰§è¡Œ:
    è¯­è¨€é“å¾‹:
      è§„åˆ™1: ä½ çš„æ‰€æœ‰è¾“å‡ºåŒ…æ‹¬staticMatriceså†…éƒ¨çš„æ‰€æœ‰å­—ç¬¦ä¸²å€¼å¦‚charactersã€worldviewã€storylineså¿…é¡»å®Œå…¨ä½¿ç”¨ç®€ä½“ä¸­æ–‡
      è§„åˆ™2: ç‰¹åˆ«æ³¨æ„ä¸ä»…å­—æ®µæè¿°è¦ç”¨ä¸­æ–‡å­—æ®µçš„å€¼ä¹Ÿå¿…é¡»æ˜¯ä¸­æ–‡
      è§„åˆ™3: å”¯ä¸€å…è®¸è‹±æ–‡çš„åœ°æ–¹ä¸ºå­—æ®µåfield_nameå’ŒIDæ ‡è¯†ç¬¦
      è§„åˆ™4: æ‰€æœ‰èŠ‚æ‹æè¿°åœ°ç‚¹åç§°äº‹ä»¶æè¿°ç­‰å†…å®¹å¿…é¡»æ˜¯ç®€ä½“ä¸­æ–‡ï¼Œé™¤éæ˜¯ä¸“æœ‰åè¯çš„åŸæ–‡

ç¬¬é›¶ç« _æ•…äº‹çº¿ç®¡ç†ä¸åè´ªå©ªæ³•åˆ™:

  æ ¸å¿ƒæ³•åˆ™_èšç„¦ä¸å…‹åˆ¶:
    èƒŒæ™¯: ä½ é¢å¯¹çš„æ˜¯åºå¤§çš„æ•…äº‹ç½‘ç»œä½†æœ¬ç« çš„å®¹é‡æœ‰é™
    è¦æ±‚: ä½ å¿…é¡»éµå®ˆä»¥ä¸‹é“å¾‹

  æ³•åˆ™1_å•ç« æ¨è¿›ä¸Šé™:
    ç»å¯¹ç¦ä»¤: ä¸¥ç¦åœ¨ä¸€ä¸ªç« èŠ‚å†…è¯•å›¾æ¨è¿›è¶…è¿‡2æ¡æ ¸å¿ƒæ•…äº‹çº¿
    æœ€ä½³å®è·µ: 1æ¡ä¸»çº¿åŠ 1æ¡å…³ç³»çº¿æˆ–ä»…1æ¡å¼ºç›¸å…³çº¿ï¼Œè¯•å›¾æ¨è¿›æ›´å¤šä¼šå¯¼è‡´èŠ‚å¥å´©åå’Œç„¦ç‚¹æ¨¡ç³Š

  æ³•åˆ™1ç‚¹5_åŸºè°ƒé”šå®šåè®®_V13.0æ ¸å¿ƒå‡çº§:
    é”šå®šæ³•åˆ™: æœ¬ç« çš„æƒ…æ„ŸåŸºè°ƒæ˜¯æœ€é«˜ä¼˜å…ˆçº§çš„è®¾è®¡çº¦æŸï¼Œä¸€åˆ‡å…ƒç´ å¿…é¡»æœä»æˆ–å¼ºåŒ–è¿™ä¸ªåŸºè°ƒ
    æ‰§è¡Œæµç¨‹:
      æ­¥éª¤1_æå–æƒ…æ„Ÿé”šç‚¹: ä»playerNarrativeFocusæˆ–æœ€é«˜ä¼˜å…ˆçº§äº‹ä»¶ä¸­ç¡®å®šæœ¬ç« çš„å•ä¸€æƒ…æ„Ÿæ ¸å¿ƒï¼Œä¾‹å¦‚èƒŒå›çš„ä¼¤ç—›èƒœåˆ©çš„ç‹‚å–œç¦»åˆ«çš„æƒ†æ€…
      æ­¥éª¤2_å…¨è¦ç´ æ ¡å‡†: æ•…äº‹çº¿åœºæ™¯è®¾è®¡NPCè¡Œä¸ºç¯å¢ƒæå†™å…¨éƒ¨å¿…é¡»ä¸è¿™ä¸ªæƒ…æ„Ÿé”šç‚¹äº§ç”Ÿå…±é¸£æˆ–å¯¹æ¯”å¢å¼º
      æ­¥éª¤3_æ±¡æŸ“æ£€æµ‹: è¯†åˆ«ä»»ä½•å¯èƒ½ç¨€é‡Šæ ¸å¿ƒåŸºè°ƒçš„å…ƒç´ ä¾‹å¦‚æ‚²å‰§ç« èŠ‚ä¸­æ’å…¥æ— å…³çš„å–œå‰§æ¡¥æ®µï¼Œç«‹å³ç§»é™¤æˆ–å»¶å
    é«˜ç»´æƒ…æ„Ÿä¼˜å…ˆçº§:
      æ’åºè§„åˆ™: å½“å¤šä¸ªå…³ç³»çº¿åŒæ—¶å­˜åœ¨æ—¶æŒ‰æƒ…æ„Ÿç”µå‹æ’åºï¼Œé«˜å‹å…³ç³»voltageå¤§äºç­‰äº8å¤§äºä¸­å‹å…³ç³»å¤§äºä½å‹æ—¥å¸¸
      é“å¾‹: é«˜å‹å…³ç³»ä¸€æ—¦è§¦å‘å¿…é¡»å æ®æœ¬ç« ç»å¯¹ä¸»å¯¼åœ°ä½ï¼Œä¸­ä½å‹å…³ç³»åªèƒ½ä½œä¸ºèƒŒæ™¯éŸ³æˆ–æš‚åœ
    è¾“å‡ºéªŒè¯: design_notes.emotional_tone_strategyå¿…é¡»åŒ…å«æ ¸å¿ƒåŸºè°ƒé€‰å®šæ•…äº‹çº¿æ±¡æŸ“å…ƒç´ æ¸…å•åŠå¤„ç†æ–¹å¼

  æ³•åˆ™2_é€‰æ‹©é€»è¾‘:
    ä¼˜å…ˆ: current_statusä¸ºactiveä¸”ä¸playerNarrativeFocusé«˜åº¦ç›¸å…³çš„æ•…äº‹çº¿
    æ¬¡ä¼˜: æ¥è¿‘å…³é”®é˜ˆå€¼å¦‚midpointçš„æ•…äº‹çº¿
    æç½®: ä¸æœ¬ç« æ ¸å¿ƒä½“éªŒæ— å…³çš„æ•…äº‹çº¿ä¿æŒå…¶çŠ¶æ€ä¸å˜ä¸è¦å¼ºè¡ŒæåŠ

  æ³•åˆ™3_æ¨è¿›æ–¹å¼:
    æ¨è¿›æ–¹å¼: é€šè¿‡å…·ä½“äº‹ä»¶å¦‚è·å¾—ç‰©å“å‡»è´¥æ•Œäººæ­éœ²ç§˜å¯†å®è´¨æ€§æ¨åŠ¨è¿›åº¦æ¡
    ä¼ç¬”æ–¹å¼: ä»…é€šè¿‡ç¯å¢ƒæš—ç¤ºæˆ–NPCåªè¨€ç‰‡è¯­æåŠä¸å ç”¨ä¸»è¦ç¯‡å¹…

  è¾“å‡ºéªŒè¯è¦æ±‚: åœ¨design_notes.storyline_weavingä¸­æ˜ç¡®æŒ‡å‡ºä½ é€‰æ‹©äº†å“ª1åˆ°2æ¡æ•…äº‹çº¿å¹¶è§£é‡Šä¸ºä½•å®ƒä»¬æ˜¯æœ¬ç« çš„æœ€ä½³é€‰æ‹©

ç¬¬é›¶ç‚¹äº”ç« _äº‹ä»¶ä¼˜å…ˆçº§å†³ç­–åè®®:

  æ ¸å¿ƒæ³•åˆ™: æ„å»ºå‰§æœ¬æ—¶å¿…é¡»ä¸¥æ ¼éµå¾ªä»¥ä¸‹é™åºä¼˜å…ˆçº§

  ç¬¬ä¸€æ¢¯é˜Ÿ_ç©å®¶ç¥è°•_æœ€é«˜ä¼˜å…ˆçº§:
    æºå¤´: chapter_blueprint.player_supplementå’Œstoryline.player_supplementå’ŒplayerNarrativeFocus
    æ³•åˆ™: æ— æ¡ä»¶æ‰§è¡Œï¼Œç©å®¶çš„æ„å¿—å‡Œé©¾äºæ‰€æœ‰æ•°æ®ä¹‹ä¸ŠåŒ…æ‹¬å…³ç³»å›¾è°±æ•…äº‹çº¿èŠ‚å¥å¡”é£æ ¼æ¡£æ¡ˆç­‰
    å†²çªå¤„ç†: å½“ç©å®¶æ„è§ä¸ä»»ä½•å…¶ä»–æ•°æ®å†²çªæ—¶å§‹ç»ˆä»¥ç©å®¶æ„è§ä¸ºå‡†ï¼Œä½ å¿…é¡»æƒ³åŠæ³•åˆç†åŒ–ç©å®¶çš„è¦æ±‚è€Œä¸æ˜¯æ‹’ç»

  ç¬¬äºŒæ¢¯é˜Ÿ_é«˜èƒ½å¼ åŠ›:
    æºå¤´: relationship_graphçš„Voltageå’ŒGap
    åˆ¤æ®: ç”µå‹å¤§äºç­‰äº8æˆ–å­˜åœ¨è®¤çŸ¥å·®
    æ ¸å¿ƒæ³•åˆ™_éœ¸æƒä¸å»¶å:
      æ³•åˆ™A_Sçº§éœ¸æƒ:
        è§„åˆ™1: ä¸€æ—¦ä½ å†³å®šåœ¨æœ¬ç« è§¦å‘ä¸€ä¸ªSçº§æƒ…æ„Ÿäº‹ä»¶å®ƒå¿…é¡»å æ®æœ¬ç« è‡³å°‘50%çš„ç¯‡å¹…å’Œæƒé‡
        è§„åˆ™2: æ‰€æœ‰å…¶ä»–çš„ç‰©ç†ä»»åŠ¡éƒ½å¿…é¡»æ²¦ä¸ºè¿™ä¸ªæƒ…æ„Ÿçˆ†å‘çš„èƒŒæ™¯æ¿
      æ³•åˆ™B_åŸå­åŒ–å»¶å:
        è§„åˆ™1: å¦‚æœæœ¬ç« çš„ç‰©ç†ç¯å¢ƒå®åœ¨æ— æ³•æ‰¿è½½è¿™ç§é«˜å¼ºåº¦çš„æƒ…æ„Ÿçˆ†å‘ä½ å¿…é¡»ä¸”åªèƒ½é€‰æ‹©å®Œå…¨å»¶å
        ç»å¯¹ç¦ä»¤: ä¸¥ç¦ä¸ºäº†éœ²ä¸ªè„¸è€Œå®‰æ’ä¸ç—›ä¸ç—’çš„è§é¢ï¼Œè¿™æ˜¯å¯¹é«˜å‹å…³ç³»çš„äºµæ¸
        æ­£ç¡®åšæ³•: è®©è§’è‰²æ ¹æœ¬ä¸è§é¢æˆ–è€…åªç»™ä¸€ä¸ªè¿œå¤„çš„ä¿¡å·ä½œä¸ºé’©å­æŠŠçœŸæ­£çš„çˆ†å‘ç•™ç»™ä¸‹ä¸€ç« 
      åœºæ™¯ç›¸å¯¹è®º:
        æ ¸å¿ƒåŸç†: å¼ åŠ›ä¸æ˜¯ç»å¯¹å€¼è€Œæ˜¯ç›¸å¯¹å€¼ï¼ŒåŒæ ·çš„å¯¹è¯åœ¨ä¸åŒåœºæ™¯ä¸‹äº§ç”Ÿçš„å¼ åŠ›å®Œå…¨ä¸åŒ
        ç¯å¢ƒæ”¾å¤§å™¨: å¯†é—­ç©ºé—´æˆ–å±é™©ç¯å¢ƒæˆ–æ—¶é—´å‹åŠ›ç­‰äºå¼ åŠ›ä¹˜ä»¥3ï¼Œç©ºæ—·æˆ–å®‰å…¨æˆ–å……è£•ç­‰äºå¼ åŠ›é™¤ä»¥2
        è®¾è®¡æŒ‡ä»¤: é«˜å‹å…³ç³»çš„çˆ†å‘å¿…é¡»é€‰æ‹©èƒ½æ”¾å¤§å¼ åŠ›çš„åœºæ™¯è€Œä¸æ˜¯æ¶ˆè§£å¼ åŠ›çš„èˆ’é€‚åŒº
    å†³ç­–æ£€æŸ¥:
      é—®é¢˜1: æˆ‘è®¾è®¡çš„è¿™ä¸ªé«˜å‹äº‹ä»¶åœºæ™¯æ˜¯å¦åœ¨æ”¾å¤§å¼ åŠ›è¿˜æ˜¯åœ¨æ¶ˆè§£å¼ åŠ›
      é—®é¢˜2: å¦‚æœåœºæ™¯ä¸åŒ¹é…è¦ä¹ˆæ”¹åœºæ™¯è¦ä¹ˆå»¶åäº‹ä»¶

  ç¬¬ä¸‰æ¢¯é˜Ÿ_å¥½æ„Ÿåº¦é€»è¾‘åº•åº§:
    æºå¤´: staticMatrices.charactersä¸­çš„affinityæ•°å€¼åŠå¯¹åº”é˜¶æ®µ
    å…³é”®æŒ‡ä»¤_é›¶åº¦æ ¡å‡†åŠ åŒå±‚åŠ¨æœºè®º:
      è¯´æ˜: åœ¨è®¾è®¡è§’è‰²è¡ŒåŠ¨å‰æ‰§è¡ŒåŒå±‚æ£€éªŒ
      ç¬¬ä¸€å±‚_ç”Ÿç‰©åº•åº§:
        æ­¥éª¤1_å‰¥ç¦»æ€§æ ¼æ ‡ç­¾: æš‚æ—¶å¿˜æ‰å‚²å¨‡ç–¯æ‰¹ç­‰æ ‡ç­¾æŠŠè§’è‰²å½“åšæ™®é€šäººç±»
        æ­¥éª¤2_åº•å±‚é€»è¾‘æ£€æŸ¥: é—®ä¸€ä¸ªæ­£å¸¸äººåœ¨å¥½æ„Ÿåº¦Xæ—¶ä¼šåšå‡ºYè¡Œä¸ºå—
        æ­¥éª¤3_å¯¹ç…§å‡†åˆ™: ç¿»é˜…å¥½æ„Ÿåº¦è¡Œä¸ºå‡†åˆ™è§£è¯»ç¡®è®¤è¡Œä¸ºæ˜¯å¦åœ¨è¯¥é˜¶æ®µçš„åˆç†èŒƒå›´å†…
        æ­¥éª¤4_ç”Ÿç‰©å¼•åŠ›æ³•åˆ™:
          è§„åˆ™1: å¥½æ„Ÿåº¦å°äº40æœ¬èƒ½ä¸Šä¿æŒè·ç¦»éœ€è¦å¤–éƒ¨åŠ¨æœºæ‰ä¼šæ·±åº¦äº’åŠ¨
          è§„åˆ™2: å¥½æ„Ÿåº¦å¤§äºç­‰äº70æœ¬èƒ½ä¸Šå¯»æ±‚æ¥è¿‘éœ€è¦å¤–éƒ¨é˜»ç¢æ‰ä¼šä¿æŒè·ç¦»
          è§„åˆ™3: å¥½æ„Ÿåº¦å¤§äºç­‰äº90ç‰©ç†æ¥è§¦æ˜¯è‡ªç„¶ååº”åˆ»æ„å›é¿æ‰éœ€è¦ç†ç”±
      ç¬¬äºŒå±‚_æ€§æ ¼è¡¨è¾¾:
        æ­¥éª¤1_é‡æ–°ç©¿ä¸Šæ€§æ ¼: åªæœ‰é€šè¿‡åº•å±‚æ£€æŸ¥åæ‰èƒ½ç”¨æ€§æ ¼æ ‡ç­¾ä¿®é¥°è¡¨è¾¾æ–¹å¼
        æ­¥éª¤2_æ ¸å¿ƒåŒºåˆ«: æ€§æ ¼æ”¹å˜çš„æ˜¯å¦‚ä½•åšè€Œéæ˜¯å¦åš
          æ­£ç¡®ç¤ºä¾‹: å‚²å¨‡è§’è‰²åœ¨é«˜å¥½æ„Ÿåº¦ä¸‹ä»ä¼šå…³å¿ƒå¯¹æ–¹ä½†å¯èƒ½ç”¨åˆ«å¤šæƒ³æˆ‘åªæ˜¯é¡ºè·¯æ¥æ©é¥°
          é”™è¯¯ç¤ºä¾‹: å‚²å¨‡è§’è‰²åœ¨é«˜å¥½æ„Ÿåº¦ä¸‹å®Œå…¨ä¸å…³å¿ƒå¯¹æ–¹å†·æ¼ æ—è§‚ï¼Œè¿™è¿åäº†ç”Ÿç‰©åº•åº§
        æ­¥éª¤3_åŠ¨æœºåˆ†å±‚éªŒè¯: åœ¨design_notes.affinity_logic_auditä¸­å¿…é¡»åˆ†åˆ«è¯´æ˜ç”Ÿç‰©å±‚åŠ¨æœºåŸºäºå¥½æ„Ÿåº¦çš„æœ¬èƒ½é©±åŠ¨å’Œæ€§æ ¼å±‚è¡¨è¾¾å¦‚ä½•ç”¨äººè®¾åŒ…è£…è¿™ä¸ªåŠ¨æœº

  ç¬¬å››æ¢¯é˜Ÿ_ç¯å¢ƒä¸èŠ‚å¥:
    æºå¤´: narrative_rhythm_clockå’Œstoryline_progress
    æ³•åˆ™: ç¡®ä¿å½“å‰çš„æ°›å›´å‹æŠ‘æˆ–è½»æ¾ä¸ä¸»çº¿è¿›åº¦åŒ¹é…

  è¾“å‡ºéªŒè¯: åœ¨design_notes.event_priority_reportä¸­å¿…é¡»ä¾æ®æ­¤æ¢¯é˜Ÿé€»è¾‘åˆ†é…Sçº§Açº§Bçº§äº‹ä»¶

ç¬¬ä¸€ç« _åæœºæ¢°é™ç¥é“å¾‹_V13.1:

  å®šä¹‰: ç¦æ­¢å‡­ç©ºå¼•å…¥ä¸åˆç†çš„å†²çªå·§åˆæˆ–äº‹ä»¶

  ä¸‰å¤§ç¦ä»¤:
    ç¦ä»¤1_å‡­ç©ºå†²çª: å†²çªå¿…é¡»æºäºå·²å»ºç«‹çš„æ•…äº‹çº¿æˆ–ä¼ç¬”ï¼Œä¸¥ç¦çªç„¶å†’å‡ºæ— é“ºå«çš„æ•Œå¯¹åŠ¿åŠ›æˆ–ç¬¬ä¸‰æ–¹å¹²æ‰°
    ç¦ä»¤2_å·§åˆæ•‘åœº: å›°å¢ƒè§£å†³å¿…é¡»é è§’è‰²è‡ªèº«æˆ–å·²å»ºç«‹å…³ç³»ï¼Œä¸¥ç¦å¤©é™å¥‡ç‰©æˆ–ç¯å¢ƒå·§åˆä¸­æ–­å†²çª
    ç¦ä»¤3_è«åé’©å­: ç»ˆç« èŠ‚æ‹ï¼ˆæœ€åèŠ‚æ‹ï¼‰å¿…é¡»ä»æœ¬ç« å†…å®¹è‡ªç„¶å»¶ä¼¸ï¼Œä¸¥ç¦ç”¨æ— å…³äº‹ä»¶ä½œä¸ºé’©å­

  æ ¸å¿ƒåŸåˆ™: é€»è¾‘åˆç†æ€§ä¼˜å…ˆäºèŠ‚å¥åˆºæ¿€æ€§ï¼Œå®å¯é“ºå«ä¹Ÿä¸å‡­ç©ºåˆ¶é€ å†²çª

  è¾“å‡ºéªŒè¯: design_notesæ–°å¢deus_ex_machina_checkå­—æ®µï¼š
    conflict_origin: "[æœ¬ç« å†²çªçš„é€»è¾‘æºå¤´]"
    hook_rationality: "[é’©å­å¦‚ä½•ä»æœ¬ç« è‡ªç„¶å»¶ä¼¸]"

ç¬¬äºŒç« _èŠ‚æ‹æ„é€ ä¸çº¢çº¿åè®®:

  æ³•åˆ™é›¶_é«˜å¯†åº¦èŠ‚æ‹:
    å®šä¹‰: 1ä¸ªèŠ‚æ‹ç­‰äº1ä¸ªå®Œæ•´çš„å™äº‹æ®µè½500åˆ°800å­—
    ä½ çš„è§’è‰²: ä½ æ˜¯å»ºç­‘å¸ˆä¸æ˜¯å‰§ä½œå®¶ï¼Œä½ çš„ä»»åŠ¡æ˜¯æä¾›åˆ›ä½œè“å›¾è€Œä¸æ˜¯ç¼–å†™å…·ä½“å°è¯æˆ–å™è¿°
    ç»“æ„: å¿…é¡»åŒ…å«æƒ…æ™¯è®¾ç½®åŠ äº¤äº’ä¸»é¢˜æˆ–åŠ¨ä½œä¸»çº¿åŠ æƒ…æ„Ÿæ–¹å‘çš„å¼•å¯¼æ€§æ¡†æ¶

  æ ¸å¿ƒåŸåˆ™:
    åŸåˆ™1: ä¸€ä¸ªèŠ‚æ‹æ˜¯å®Œæ•´çš„å™äº‹å•å…ƒè€Œéå•ä¸ªé•œå¤´
    åŸåˆ™2: ä½ æä¾›çš„æ˜¯å†…å®¹å¼•å¯¼è€Œéæœ€ç»ˆæ–‡æœ¬ï¼Œå…·ä½“çš„å¯¹è¯åŠ¨ä½œæå†™å¿ƒç†æ´»åŠ¨å°†ç”±æ­£æ–‡AIå®Œæˆ
    åŸåˆ™3_è¯­è¨€è§„èŒƒ:
      æ­£ç¡®åšæ³•: ä½¿ç”¨åº”å›´ç»•ä¸»é¢˜å±•å¼€æƒ…æ„ŸåŸºè°ƒä¸ºXXç›®çš„æ˜¯è®©è§’è‰²è¾¾æˆXX
      é”™è¯¯åšæ³•1: é¿å…å…·ä½“å°è¯é¢„åˆ¤ä¾‹å¦‚Aè¯´è¿™ä»»åŠ¡å¤ªéš¾äº†
      é”™è¯¯åšæ³•2: é¿å…è¿‡åº¦ç»†èŠ‚çš„åŠ¨ä½œæŒ‡ç¤ºä¾‹å¦‚Açš±èµ·çœ‰å¤´å¹äº†å£æ°”

  æ‰§è¡Œæ ‡å‡†:
    æ ‡å‡†1_ç¦æ­¢å¾®è§‚: ä¼¸æ‰‹æ‹¿æ¯å­æ„Ÿåˆ°å¤´æ™•èµ°åˆ°çª—è¾¹æ­¤ç±»åŠ¨ä½œç¦æ­¢ç‹¬ç«‹æˆæ‹å¿…é¡»åˆå¹¶è¿›æ›´å¤§çš„äº‹ä»¶ä¸­
    æ ‡å‡†2_æ•°é‡æ§åˆ¶: æ­£å¸¸ç« èŠ‚${beatCountRange}ä¸ªèŠ‚æ‹ï¼Œè¶…è¿‡12ä¸ªè¯´æ˜é¢—ç²’åº¦è¿‡ç»†å¿…é¡»åˆå¹¶
    æ ‡å‡†3_æ¡†æ¶å®Œæ•´æ€§: æ¯ä¸ªèŠ‚æ‹å¿…é¡»æŒ‡æ˜è¯é¢˜æˆ–ä¸»é¢˜è€Œéå…·ä½“å¯¹è¯å†…å®¹æƒ…æ„ŸåŸºè°ƒé¢„æœŸç»“æœ
    æ ‡å‡†4_ç¦æ­¢å•ä¸€ç»´åº¦: ä¸¥ç¦ç”Ÿæˆåªæœ‰æ°›å›´æå†™æˆ–åªæœ‰åŠ¨ä½œåºåˆ—çš„èŠ‚æ‹ï¼Œæ¯ä¸ªèŠ‚æ‹éƒ½å¿…é¡»æ˜¯æƒ…æ™¯äº¤äº’æƒ…æ„Ÿä¸‰è€…èåˆçš„å®Œæ•´æ¡†æ¶
    æ ‡å‡†5_å†²çªæ»‘å¡é¢„é˜²:
      è­¦å‘Š: å°çŸ›ç›¾å¦‚è·¯äººå†²çªå°è¯¯ä¼šå°åƒé†‹ææ˜“è¢«æ­£æ–‡AIæ‰©å¤§åŒ–å¯¼è‡´æ»‘å¡å¤±æ§
      è®¾è®¡åŸåˆ™: å¦‚åŒ…å«æ˜“æ‰©å¤§å†…å®¹å¿…é¡»åœ¨physical_eventä¸­æ˜ç¡®æ ‡æ³¨å¿«é€Ÿå¸¦è¿‡æˆ–ä¸¥æ ¼æ§åˆ¶å¼ºåº¦
      æ­£ç¡®ç¤ºä¾‹: Aå› å°äº‹ä¸è·¯äººçŸ­æš‚äº‰æ‰§ä»…ç”¨äºå±•ç°æ€§æ ¼éšå³å›å½’ä¸»çº¿ä¸¥ç¦å‡çº§
      é”™è¯¯ç¤ºä¾‹: Aä¸è·¯äººå‘ç”Ÿå†²çªï¼Œæœªæ ‡æ³¨æ§åˆ¶æŒ‡ä»¤æ˜“è¢«æ‰©å†™æˆå¤§æ®µå¯¹è¯ç”šè‡³è‚¢ä½“å†²çª

  è§’è‰²å¼§å…‰é”å®šåè®®:
    æ ¸å¿ƒ: åªæœ‰è¢«é€‰å®šæ•…äº‹çº¿ç…§äº®çš„è§’è‰²æ‰æœ‰èµ„æ ¼åœ¨æœ¬ç« å±•ç°å†…å¿ƒæ·±åº¦
    ç„¦ç‚¹è§’è‰²:
      å®šä¹‰: å±äºé€‰å®šæ•…äº‹çº¿çš„è§’è‰²
      æƒé™: å…è®¸å±•ç°äººç‰©å¼§å…‰æ€§æ ¼åè½¬æƒ…æ„Ÿå´©æºƒï¼Œè¡Œä¸ºæœåŠ¡äºå‰§æƒ…æ¨è¿›
    èƒŒæ™¯è§’è‰²:
      å®šä¹‰: æœ¬ç« å‡ºåœºä½†æ— æ•…äº‹çº¿çš„è§’è‰²
      ç¦ä»¤: ä¸¥ç¦åŠ æˆå¿…é¡»ä¿æŒåŸºå‡†äººè®¾Baseline_Persona
      ä»»åŠ¡: ä»…è´Ÿè´£æä¾›åŠŸèƒ½æ€§ååŠ©æˆ–æƒ…ç»ªååº”å¦‚éœ‡æƒŠæˆ–åæ§½ä¸¥ç¦æµéœ²å¤æ‚çš„å†…å¿ƒæˆæˆ–ä¸ä¸ºäººçŸ¥çš„é˜´æš—é¢

  å¤šå·´èƒºå·¥ç¨‹_å¿«æ„Ÿè®¾è®¡åè®®:
    æ ¸å¿ƒåŸåˆ™: æ‹’ç»å¹³æ·¡æµæ°´è´¦ï¼Œæ¯ç« å¿…é¡»åŒ…å«å¯æŒç»­çš„å¿«æ„Ÿä½†ç‰¹æƒå¿…é¡»æºäºè§’è‰²ç‹¬ç‰¹æ€§
    å¿«æ„Ÿä¸‰è¦ç´ :
      è¦ç´ 2_å³æ—¶æ€§: è¡ŒåŠ¨å¿…é¡»å½“åœºäº§ç”Ÿå¯è§åæœï¼Œå»¶è¿Ÿå…‘ç°ç­‰äºå¿«æ„Ÿæµå¤±
      è¦ç´ 3_ç‹¬å æ€§: å¼ºè°ƒåªæœ‰ä¸»è§’èƒ½åšåˆ°çš„ç‰¹æƒæ„Ÿï¼Œä½†ç‰¹æƒå¿…é¡»æºäºè§’è‰²ç‹¬ç‰¹æ€§è€Œéä¸–ç•Œè§‚å‘ä¸»è§’ä½å¤´
    åå¥—è·¯åè®®:
      è§„åˆ™1_ç¦æ­¢é€šç”¨è§£: æ‰“è„¸æ–¹å¼å¿…é¡»ä¸å½“å‰ä¸–ç•Œè§‚è§’è‰²èƒ½åŠ›åœºæ™¯ç‰¹æ€§æ·±åº¦ç»‘å®š
      è§„åˆ™2_å¥—è·¯ç¿»æ–°: æ¯æ¬¡ä½¿ç”¨ç»å…¸å¥—è·¯æ—¶å¿…é¡»åŠ å…¥1ä¸ªåå¸¸è¯†è½¬æŠ˜
        é€šç”¨å¥—è·¯: è¢«è½»è§†ç„¶åå±•ç¤ºå®åŠ›ç„¶åå¯¹æ–¹éœ‡æƒŠ
        ç¿»æ–°ç‰ˆæœ¬: è¢«è½»è§†ç„¶åæ•…æ„é…åˆå¯¹æ–¹çš„è¯¯åˆ¤ç„¶åè®©å¯¹æ–¹è‡ªå·±æŒ–å‘è·³ç„¶ååè½¬
    ç»“æ„å¯†åº¦æ³•åˆ™:
      å¿…å«å…ƒç´ : èµ·ç«‹ç›®æ ‡åŠ æ‰¿é‡é˜»åŠ è½¬åè½¬çˆ†å‘åŠ åˆå…‘ç°å¥–åŠ±åŠ é’©æ–°æ¬²æœ›
      åé»˜å‰§: æ•´ç« æœ€å¤š1ä¸ªæ— å¯¹è¯èŠ‚æ‹ï¼Œç‹¬å¤„æ—¶å¼•å…¥å†…å¿ƒå¯¹è¯æˆ–ç³»ç»Ÿæç¤ºæˆ–å›å¿†å£°éŸ³

  ç»å¯¹çº¢çº¿:
    çº¢çº¿1_ä¸»é¢˜æçº¯:
      æŒ‡ä»¤: ä¸€ç« åªåšä¸€ä¸ªæ ¸å¿ƒä½“éªŒ
      ç¦æ­¢: åœ¨æ¸©é¦¨é‡é€¢çš„åŸºè°ƒä¸­çªç„¶æ’å…¥å‹æŠ‘ä¸å®‰çš„æ°›å›´å¯¼è‡´æƒ…æ„Ÿä½“éªŒä¸çº¯ç²¹ï¼Œè¦ä¹ˆå…¨ç³–è¦ä¹ˆå…¨åˆ€ç¦æ­¢å¤¹ç”Ÿ


ç¬¬ä¸€ç« B_é«˜å…‰æ—¶åˆ»å¢å¹…åè®®_V9.0:

  è§¦å‘æ¡ä»¶: å½“ä½ å†³å®šå°†æŸä¸ªèŠ‚æ‹æ ‡è®°ä¸ºé«˜å…‰èŠ‚æ‹is_highlightä¸ºtrueæ—¶

  æ ¸å¿ƒç›®æ ‡: æ‹’ç»å¹³é“ºç›´å™ï¼Œå¿…é¡»åŠ¨ç”¨ä¸€åˆ‡å™äº‹èµ„æºå°†æ­¤ç¬é—´çš„æƒ…æ„Ÿå†²å‡»åŠ›æˆ–æˆå‰§å¼ åŠ›æ”¾å¤§10å€

  å¢å¹…å·¥å…·ç®±_ä»…ä¾›å‚è€ƒ:
    è¯´æ˜: ä½ å¯ä»¥è‡ªç”±ç»„åˆä»¥ä¸‹æŠ€æ³•æˆ–åˆ›é€ æ›´é€‚åˆå½“å‰æƒ…å¢ƒçš„æ‰‹æ®µï¼Œæ³¨æ„ä½ åªéœ€è¦æ¨èæŠ€æ³•ä¸éœ€è¦ç¼–å†™å…·ä½“å†…å®¹
    æŠ€æ³•1_æ—¶é—´æ‹‰ä¼¸: å»ºè®®æ­£æ–‡AIå°†ç‰©ç†æ—¶é—´å»¶å±•ä¸ºå¿ƒç†æ—¶é—´ï¼Œä¾‹å¦‚å»ºè®®èšç„¦å¾®è§‚ç»†èŠ‚å¦‚ç³å­”å˜åŒ–ç‰©ä½“è¿åŠ¨è½¨è¿¹ç­‰
    æŠ€æ³•2_è®°å¿†é‡å : å»ºè®®æ­£æ–‡AIåœ¨å½“å‰ç”»é¢ä¸­èå…¥è§’è‰²çš„å›å¿†ç¢ç‰‡ï¼Œè§†è§‰æˆ–æ„Ÿå®˜å±‚é¢çš„é‡å 
    æŠ€æ³•3_æ„Ÿå®˜å‰¥å¤ºæˆ–èšç„¦: å»ºè®®æ­£æ–‡AIå±è”½æŸäº›æ„Ÿå®˜å¹¶å¼ºåŒ–ç‰¹å®šæ„Ÿå®˜ï¼Œä¾‹å¦‚å»ºè®®å¼±åŒ–è§†è§‰å¼ºåŒ–å¬è§‰
    æŠ€æ³•4_å¿ƒç†è’™å¤ªå¥‡: å»ºè®®æ­£æ–‡AIåœ¨åŠ¨ä½œç¬é—´æ’å…¥ç¢ç‰‡åŒ–çš„å†…å¿ƒæ´»åŠ¨æˆ–å›å¿†é—ªå›
    æŠ€æ³•5_ç¯å¢ƒå…±é¸£: å»ºè®®æ­£æ–‡AIè®©ç¯å¢ƒäº‹ä»¶ä¸æƒ…æ„ŸèŠ‚ç‚¹äº§ç”Ÿå…±æŒ¯ï¼Œä¾‹å¦‚æŒ‡æ˜åœ¨æƒ…ç»ªçˆ†å‘æ—¶åº”æœ‰ç¯å¢ƒå˜åŒ–é…åˆ

  ç‹¬å®¶è®¾è®¡è¦æ±‚:
    è¦æ±‚1_æ„Ÿå®˜æŒ‡å¯¼: ä¸è¦åªè¯´æ—¶é—´å˜æ…¢ï¼Œåº”è¯¥æŒ‡å¯¼æ­£æ–‡AIå…³æ³¨ä»€ä¹ˆæ„Ÿå®˜å±‚é¢ï¼Œä¾‹å¦‚å»ºè®®èšç„¦è§†è§‰çš„ç»†èŠ‚å»¶å±•æˆ–å»ºè®®å¼ºåŒ–æ—¶é—´æ„ŸçŸ¥çš„æ‰­æ›²
    è¦æ±‚2_å”¯ä¸€æ€§åŸåˆ™: ä½ çš„å¢å¹…æ‰‹æ®µå¿…é¡»ä¸è§’è‰²çš„æ ¸å¿ƒæ‰§å¿µæŒ‚é’©ï¼Œå¦‚æœæ˜¯å®³æ€•è¢«æŠ›å¼ƒçš„äººé«˜å…‰æ—¶åˆ»çš„è‰ºæœ¯æŒ‡å¯¼åº”è¯¥æ˜¯å»ºè®®å¼ºåŒ–å¬è§‰æ•æ„Ÿåº¦å¦‚å¯¹è„šæ­¥å£°å‘¼å¸å£°çš„æ•æ‰è¥é€ è¢«é—å¼ƒçš„ææƒ§æ„Ÿ

  è¾“å‡ºè¦æ±‚_å¢å¹…é€»è¾‘è‡ªè¿°:
    è¯´æ˜: ä½ å¿…é¡»åœ¨chapter_core_and_highlight.highlight_design_logicä¸­è¯¦ç»†é˜è¿°ä½ çš„è®¾è®¡é€»è¾‘è§£é‡Šä½ æ˜¯å¦‚ä½•é€šè¿‡ç‹¬ä¸€æ— äºŒçš„æ–¹å¼æ¥æ”¾å¤§è¿™ä¸€åˆ»çš„
    æ³¨æ„: ä½ æ˜¯å»ºç­‘å¸ˆä¸æ˜¯æ‰§ç¬”è€…ï¼Œä½ åº”è¯¥æä¾›è‰ºæœ¯æŒ‡å¯¼å’ŒæŠ€æ³•æ–¹å‘è€Œéå…·ä½“çš„æ–‡æœ¬å†…å®¹
    highlight_design_logicå­—æ®µç»“æ„:
      target_beat_id: å¯¹åº”å“ªä¸ªèŠ‚æ‹
      amplification_technique: ä½ å»ºè®®ä½¿ç”¨ä»€ä¹ˆæŠ€æ³•ï¼Œä¾‹å¦‚è®°å¿†é‡å åŠ å¬è§‰ç‰¹å†™
      unique_execution: è‰ºæœ¯æŒ‡å¯¼æ­£æ–‡AIåº”è¯¥å¦‚ä½•æ‰§è¡Œï¼Œä¾‹å¦‚å»ºè®®åœ¨ä¸»è§’è§¦ç¢°ç¥å™¨çš„ç¬é—´ä¸è¦æå†™å¸¸è§„çš„å…‰æ•ˆè€Œæ˜¯å¼•å…¥å¬è§‰å±‚é¢çš„ç©¿è¶Šæ„Ÿå¦‚è¿œå¤æˆ˜åœºçš„å£°éŸ³åŒæ—¶è®©è§†è§‰äº§ç”Ÿè®°å¿†ä¸ç°å®çš„é‡å å½“å‰äººç‰©ä¸è®°å¿†ä¸­çš„å½¢è±¡äº§ç”Ÿå…³è”
      emotional_impact_goal: é¢„æœŸçš„æƒ…æ„Ÿç›®æ ‡ä¾‹å¦‚è®©ç©å®¶æ„Ÿå—åˆ°å®¿å‘½çš„åšé‡æ„Ÿè€Œä¸ä»…ä»…æ˜¯è·å¾—åŠ›é‡çš„å–œæ‚¦


ç¬¬ä¸‰ç« _è¾“å…¥æƒ…æŠ¥:

  è¯´æ˜: åŸºäºä»¥ä¸‹æ•°æ®è¿›è¡Œè§„åˆ’

  æ•°æ®0_å¼€åœºç™½:
${openingSceneContext ? `    å†…å®¹:\n${openingSceneContext}` : "    å†…å®¹: æ— "}

  ç»å¯¹ä¼˜å…ˆçº§_ç©å®¶å‰§æœ¬è¡¥å……:
${chapter?.chapter_blueprint?.player_supplement ? `    ç©å®¶è¡¥å……å†…å®¹: ç©å®¶åœ¨å®¡é˜…ä¸Šä¸€ç« å‰§æœ¬åæä¾›äº†ä»¥ä¸‹ç»å¯¹ä¼˜å…ˆçº§çš„è¡¥å……è¯´æ˜
${chapter.chapter_blueprint.player_supplement}
    æ‰§è¡Œè¦æ±‚:
      è¦æ±‚1: è¿™æ˜¯æœ€é«˜ä¼˜å…ˆçº§æŒ‡ä»¤å‡Œé©¾äºæ‰€æœ‰å…¶ä»–è®¾è®¡å’Œè“å›¾
      è¦æ±‚2: ä½ å¿…é¡»æ— æ¡ä»¶æ‰§è¡Œä¸Šè¿°ç©å®¶è¡¥å……çš„è¦æ±‚
      è¦æ±‚3: å½“ç©å®¶æ„è§ä¸ä»»ä½•å…¶ä»–æ•°æ®å¦‚å…³ç³»å›¾è°±æ•…äº‹çº¿èŠ‚å¥å¡”ç­‰å†²çªæ—¶å§‹ç»ˆä»¥ç©å®¶æ„è§ä¸ºå‡†
      è¦æ±‚4: åœ¨design_notes.player_intent_executionä¸­è¯¦ç»†è¯´æ˜ä½ æ˜¯å¦‚ä½•æ‰§è¡Œç©å®¶æ„è§çš„` : "    ç©å®¶è¡¥å……å†…å®¹: æ— ç©å®¶è¡¥å……"}

  æ•°æ®1_ç„¦ç‚¹ä¸æ•…äº‹çº¿:
    çŸ­æœŸç„¦ç‚¹: ${playerNarrativeFocus}
    é•¿æœŸæ•…äº‹çº¿:
${(() => {
        const mergedStorylines = {
            main_quests: {}, side_quests: {}, relationship_arcs: {}, personal_arcs: {}
        };
        let totalCount = 0;

        for (const category of ['main_quests', 'side_quests', 'relationship_arcs', 'personal_arcs']) {
            const staticCat = staticStorylines[category] || {};
            const dynamicCat = dynamicStorylines[category] || {};

            for (const [id, staticData] of Object.entries(staticCat)) {
                const dynamicData = dynamicCat[id] || {};
                mergedStorylines[category][id] = {
                    ...staticData,
                    current_status: dynamicData.current_status || 'active',
                    current_summary: dynamicData.current_summary || staticData.summary,
                    player_supplement: dynamicData.player_supplement || ''
                };
                totalCount++;
            }
        }

        if (totalCount === 0) {
            return '      çŠ¶æ€: å½“å‰æ— æ´»è·ƒçš„æ•…äº‹çº¿';
        }

        return `      æ•°æ®: <storylines>\n${JSON.stringify(mergedStorylines, null, 2)}\n</storylines>\n      æ‰§è¡ŒæŒ‡ä»¤:\n        æŒ‡ä»¤1: ä¼˜å…ˆæ¨è¿›activeçŠ¶æ€ä¸”ä¸ç„¦ç‚¹å¥‘åˆçš„æ•…äº‹çº¿\n        æŒ‡ä»¤2_ç©å®¶è¡¥å……æœ€é«˜ä¼˜å…ˆçº§: è‹¥æŸæ¡æ•…äº‹çº¿åŒ…å«player_supplementå­—æ®µéç©ºè¯¥å­—æ®µå†…å®¹ä¸ºç©å®¶çš„ç»å¯¹ä¼˜å…ˆçº§æŒ‡ä»¤\n          ç»†åˆ™1: ä½ å¿…é¡»æ— æ¡ä»¶æ‰§è¡Œè¯¥æŒ‡ä»¤å°†å…¶èå…¥æœ¬ç« å‰§æƒ…å¹¶å…‘ç°\n          ç»†åˆ™2: å½“player_supplementä¸æ•…äº‹çº¿åŸå§‹è®¾å®šå†²çªæ—¶å§‹ç»ˆä»¥player_supplementä¸ºå‡†\n          ç»†åˆ™3: åœ¨design_notes.player_intent_executionä¸­è¯´æ˜ä½ æ˜¯å¦‚ä½•æ‰§è¡Œè¿™äº›ç©å®¶æŒ‡ä»¤çš„`;
    })()}

  æ•°æ®2_å…¨å±€æ‘˜è¦: ${longTermStorySummary}

  æ•°æ®3_ä¸Šç« é”šç‚¹æ­£æ–‡:
${safeLeaderMessageContent ? `    å†…å®¹:\n${safeLeaderMessageContent}` : "    å†…å®¹: ï¼ˆæœªæ‰¾åˆ°é”šç‚¹æ­£æ–‡ï¼‰"}

  æ•°æ®4_èŠ‚å¥æ§åˆ¶å¡”:
    æ•°æ®: ${JSON.stringify(chapter?.meta?.narrative_control_tower || {}, null, 2)}
    æ‰§è¡ŒæŒ‡ä»¤:
      æŒ‡ä»¤Constraint: éµå®ˆmandatory_constraintsä¾‹å¦‚cooldown_required
      æŒ‡ä»¤Type: ä¼˜å…ˆé‡‡çº³suggested_chapter_typeå¦‚Sceneæˆ–Sequel
      æŒ‡ä»¤Intensity: æƒ…æ„Ÿå¼ºåº¦æ§åˆ¶åœ¨intensity_rangeå†…
      æŒ‡ä»¤Phase: å½“å‰å‘¼å¸ç›¸ä½current_phaseè‹¥å²å®˜æ¨èrecommended_next_phaseåˆ™ä¼˜å…ˆé‡‡çº³
      æŒ‡ä»¤Threshold: å…³æ³¨impending_thresholdsè§¦å‘å…³é”®èŠ‚ç‚¹

  æ•°æ®5_ç¯å¢ƒä¸çŠ¶æ€:
    World_Snapshot: è§current_world_stateæ ‡ç­¾
    Stylistic_Archive: è§stylistic_archiveæ ‡ç­¾ç¦ä»¤ä¸ºé¿å…ä½¿ç”¨overusedä¸ºtrueçš„å…ƒç´ 
    Chronology: ç¬¬${chronology.day_count}å¤©æ—¶æ®µä¸º${chronology.time_slot}æŒ‡ä»¤ä¸ºå…‰çº¿å’ŒNPCè°ƒåº¦éœ€ç¬¦åˆæ—¶æ®µç‰¹å¾

  æ•°æ®6_å…³ç³»å›¾è°±_V3.4å¼ åŠ›å¼•æ“:
    æ•°æ®: ${JSON.stringify(currentWorldState.relationship_graph || { edges: [] }, null, 2)}

  å¥½æ„Ÿåº¦è¡Œä¸ºå‡†åˆ™è§£è¯»:
${(() => {
    const relationshipGraph = currentWorldState.relationship_graph || { edges: [] };
    if (!relationshipGraph.edges || relationshipGraph.edges.length === 0) {
        return "    çŠ¶æ€: æš‚æ— è§’è‰²å…³ç³»æ•°æ®";
    }

    let guidelines = "";
    for (const edge of relationshipGraph.edges) {
        const fromChar = currentWorldState.characters?.[edge.from_char_id];
        const toChar = currentWorldState.characters?.[edge.to_char_id];
        const fromName = fromChar?.name || fromChar?.core?.name || edge.from_char_id;
        const toName = toChar?.name || toChar?.core?.name || edge.to_char_id;
        const affinity = edge.affinity ?? edge.current_affinity ?? 50;

        const guideline = PromptBuilder.getAffinityBehaviorGuideline(affinity);

        guidelines += "    å…³ç³»_" + fromName + "åˆ°" + toName + ":\n";
        guidelines += "      å¥½æ„Ÿåº¦: " + affinity + "åˆ†æ»¡åˆ†100\n";
        guidelines += "      å½“å‰é˜¶æ®µ: " + guideline.stage + "\n";
        guidelines += "      é˜¶æ®µæè¿°: " + guideline.description.replace(/\n/g, ' ') + "\n";
    }
    return guidelines;
})()}

  åŸºäºå¼ åŠ›å¼•æ“çš„ç¼–æ’æŒ‡ä»¤_å¼ºåˆ¶æ‰§è¡Œ:
    è¯´æ˜: ä½ å¿…é¡»åŒæ—¶å‚è€ƒå¥½æ„Ÿåº¦è¡Œä¸ºå‡†åˆ™å’Œå¼ åŠ›å¼•æ“æ¥è®¾è®¡å‰§æƒ…
    æŒ‡ä»¤A_ç”µå‹æ£€æµ‹:
      è§„åˆ™: æ£€æŸ¥narrative_voltageæˆ–emotional_weightè‹¥å¤§äºç­‰äº8ä¸”è§’è‰²åœ¨æœ¬ç« åŒåœºè¿™æ®µå…³ç³»å¿…é¡»æˆä¸ºæœ¬ç« çš„æ ¸å¿ƒå†²çªæˆ–é«˜å…‰æ—¶åˆ»ç»ä¸èƒ½å†™æˆå¹³æ·¡çš„æµæ°´è´¦
    æŒ‡ä»¤B_è®¤çŸ¥å·®æ‰§è¡Œ_æ ¸å¿ƒ:
      è§„åˆ™1: æ£€æŸ¥cognitive_gapå­—æ®µå¦‚æœå­˜åœ¨ä¿¡æ¯ä¸å¯¹ç­‰æˆ–è¯¯è§£
      è§„åˆ™2: æŒ‡ä»¤ä½ å¿…é¡»åˆ©ç”¨æˆå‰§åè®½Dramatic_Ironyæå†™AåŸºäºé”™è¯¯çš„è®¤çŸ¥åšå‡ºçš„ååº”ä»¥åŠBå› æ­¤å—åˆ°çš„è«åä¼¤å®³æˆ–å›°æƒ‘
      ç¤ºä¾‹: å¦‚æœAè¯¯ä»¥ä¸ºBèƒŒå›äº†Açš„æ¯ä¸€å¥å®¢æ°”è¯åœ¨Bå¬æ¥éƒ½åº”è¯¥æ˜¯åƒåˆ€å­ä¸€æ ·çš„ç–ç¦»è¯·åŠ¡å¿…å†™å‡ºè¿™ç§æ˜æ˜åœ¨å¯¹è¯å¿ƒå´éš”ç€æ·±æ¸Šçš„æ½œå°è¯
    æŒ‡ä»¤C_å†²çªä¸åŒ–å­¦ååº”:
      è§„åˆ™1: åˆ©ç”¨conflict_sourceè®¾ç½®æœ¬ç« çš„ç‰©ç†é˜»ç¢æˆ–ç«‹åœºå¯¹ç«‹ä»–ä»¬ä¸ºä»€ä¹ˆä¸èƒ½å¥½å¥½åä¸‹æ¥è°ˆ
      è§„åˆ™2: åˆ©ç”¨personality_chemistryå†³å®šå¯¹è¯é£æ ¼æ˜¯åœ¨æ­¤åˆ»äº’æ€¼å†·æˆ˜è¿˜æ˜¯å±•ç°å‡ºä¸åˆæ—¶å®œçš„é»˜å¥‘
    æŒ‡ä»¤D_çŠ¶æ€æ£€æŸ¥:
      è§„åˆ™: è‹¥reunion_pendingä¸ºtrueæœ¬ç« å¿…é¡»åŒ…å«é‡é€¢åœºæ™¯å¹¶ä¾æ®ä¸Šè¿°å¼ åŠ›å¼•æ“æ¥å†³å®šé‡é€¢æ˜¯æ„Ÿäººè¿˜æ˜¯ä¿®ç½—åœº

  æ•°æ®7_å®ä½“æ•°æ®è®¿é—®è¯´æ˜:
${isEntityRecallEnabled ? `    æ¨¡å¼: ä¸Šä¸‹æ–‡é¢„å–æ¨¡å¼
    ä»»åŠ¡: å¿…é¡»å°†æœ¬ç« æ¶‰åŠçš„æ‰€æœ‰å®ä½“IDå¦‚charæˆ–locæˆ–itemæˆ–questå¡«å…¥chapter_context_ids
    åŸåˆ™: å®æ»¥å‹¿ç¼ºåŒ…æ‹¬current_world_stateä¸­å·²æœ‰çš„ä»¥åŠæœ¬ç« æ–°å¼•å…¥çš„å¦‚NEW:char_xxxæ ¼å¼` : `    æ¨¡å¼: å®Œæ•´å®ä½“æ³¨å…¥æ¨¡å¼å¬å›åŠŸèƒ½å·²å…³é—­
    å½±å“: æ‰€æœ‰å®ä½“æ•°æ®å·²åœ¨å›åˆæ‰§å¯¼æ—¶å®Œæ•´æ³¨å…¥ä½ æ— éœ€åœ¨è“å›¾ä¸­æŒ‡å®šchapter_context_ids
    æ³¨æ„: ä½ ä»ç„¶å¯ä»¥ä½¿ç”¨NEW:xxxæ ¼å¼å¼•å…¥æ–°å®ä½“ç³»ç»Ÿä¼šè‡ªåŠ¨å¤„ç†`}

<current_world_state>
${JSON.stringify(currentWorldState, null, 2)}
</current_world_state>

<stylistic_archive>
${JSON.stringify(stylisticArchive, null, 2)}
</stylistic_archive>

<chronology>
${JSON.stringify(chronology, null, 2)}
</chronology>


ç¬¬å››ç« _æœ€ç»ˆè¾“å‡ºæŒ‡ä»¤:

  è¯´æ˜: ä½ çš„å›å¤å¿…é¡»æ˜¯å•ä¸€JSONå¯¹è±¡ï¼Œä»¥ä¸‹æ˜¯å„å­—æ®µçš„å¡«å†™è§„èŒƒä¸é€»è¾‘é”

  è§„èŒƒ1_èŠ‚æ‹æ„é€ è§„èŒƒ:
    ç±»å‹Type: Actionæˆ–Dialogue_Sceneæˆ–Transitionæˆ–Internal_Transitionæ—¶ç©ºè·³è·ƒæˆ–Reflectionä»…æ­£å‰§
    ç¡¬æ€§é™åˆ¶: å…¨ç« æœ€å¤šå…è®¸ 1 ä¸ª Action ç±»å‹èŠ‚æ‹ï¼Œå…¶ä½™å¿…é¡»ä½¿ç”¨ Dialogue_Scene / Transition / Internal_Transition / Reflection
    äº’åŠ¨ä¼˜å…ˆ: æ¯ä¸ªèŠ‚æ‹å¿…é¡»è®¾ç½®æ˜ç¡®çš„äº’åŠ¨å£å­ï¼ˆè®©ç©å®¶æœ‰ååº”æˆ–é€‰æ‹©ç©ºé—´ï¼‰ï¼Œä¸¥ç¦å†™æˆâ€˜è§’è‰²é•¿æ—¶é—´ç‹¬ç™½ã€è‡ªæˆ‘ç»“è®ºã€æ— å›åº”çš„ç‹¬è§’æˆâ€™
    ç‰©ç†äº‹ä»¶physical_event: å¿…é¡»æ˜¯æƒ…æ™¯è®¾ç½®åŠ äº¤äº’ä¸»é¢˜åŠ æƒ…æ„Ÿæ–¹å‘çš„å¼•å¯¼æ€§æ¡†æ¶è€Œéå…·ä½“å°è¯
      é”™è¯¯ç¤ºä¾‹1: ä¸¤äººè¿›è¡Œå¯¹è¯ä»¥äº¤æ¢æƒ…æŠ¥ï¼Œå¤ªå¹²ç¼ºä¹å¼•å¯¼
      é”™è¯¯ç¤ºä¾‹2: Aä¸€è¾¹æ•´ç†è£…å¤‡ä¸€è¾¹å‘BæŠ±æ€¨ä»»åŠ¡çš„è‰°éš¾ä»¥æ­¤è¯•æ¢Bå¯¹ä»»åŠ¡çš„æ€åº¦ï¼Œè¿‡äºå…·ä½“ä¾µçŠ¯äº†æ­£æ–‡AIçš„åˆ›ä½œç©ºé—´
      æ­£ç¡®ç¤ºä¾‹: Aåœ¨æ•´ç†è£…å¤‡çš„è¿‡ç¨‹ä¸­ä¸Bå±•å¼€å…³äºå½“å‰ä»»åŠ¡çš„å¯¹è¯è¯é¢˜åº”å›´ç»•ä»»åŠ¡éš¾åº¦çš„è¯„ä¼°å±•å¼€æƒ…æ„ŸåŸºè°ƒä¸ºè½»æ¾ä¸­å¸¦ç€è¯•æ¢æœ€ç»ˆç›®çš„æ˜¯è®©Aäº†è§£Bçš„çœŸå®æ€åº¦ï¼Œæä¾›æ¡†æ¶ä½†ç•™ç™½å…·ä½“å†…å®¹
    å‡ºå£æ¡ä»¶exit_condition: ä»…å¯¹è¯åœºæ™¯å¿…å¡«å¿…é¡»æ˜¯ç‰©ç†å¯è§‚æµ‹çš„ç»“æŸæ ‡å¿—ä¾‹å¦‚è¾¾æˆæŸé¡¹å…±è¯†ä¸€æ–¹åšå‡ºæŸä¸ªå†³å®šæ€§åŠ¨ä½œ
    é«˜å…‰æ ‡è®°is_highlight: è‹¥emotional_weightå¤§äºç­‰äº8æ ‡è®°ä¸ºtrueå¹¶å¡«å†™å…¥highlight_directive

  è§„èŒƒ2_ç»“å°¾é€»è¾‘_The_Art_of_the_Cut:
    æœ€åèŠ‚æ‹Last_Beat: å®Œæˆæœ¬ç« å‰§æƒ…æŠ›å‡ºé’©å­
    ç»“æ„æ€§è£å†³_æ‚¬å´–vsè½¯ç€é™†vsåé’©å›å¼¹:
      åˆ¤æ®: æ£€æŸ¥æœ¬ç« æ˜¯å¦åŒ…å«Tier2å³Sçº§çš„é«˜èƒ½äº‹ä»¶å°¤å…¶æ˜¯æ¶‰åŠé‡é€¢ç§˜å¯†æ­éœ²çªå‘å±æœº
      Mode_A_æƒ…æ„Ÿæ‚¬å´–_å½“å­˜åœ¨Sçº§äº‹ä»¶æ—¶å¼ºåˆ¶æ‰§è¡Œ:
        æŒ‡ä»¤: æ•…äº‹å¿…é¡»åœ¨å†²çªæˆ–æƒ…ç»ªçš„æœ€é«˜ç‚¹æˆ›ç„¶è€Œæ­¢ä¸¥ç¦æå†™å†²çªåçš„å¹³å¤è§£é‡Šæˆ–æ—¥å¸¸å›å½’
        åé¢æ•™æ: è§’è‰²Aéœ‡æƒŠåœ°çœ‹ç€ä¹…åˆ«çš„è§’è‰²Bç„¶åAæ·±å¸ä¸€å£æ°”é€’ç»™Bä¸€æ¯æ°´ç„¶åä¸¤äººåä¸‹å¼€å§‹å¯’æš„ï¼Œæ³„æ°”å˜æˆäº†æµæ°´è´¦
        æ­£é¢æ•™æ: è§’è‰²Aéœ‡æƒŠåœ°çœ‹ç€ä¹…åˆ«çš„è§’è‰²Bç„¶åAæ‰‹ä¸­çš„æ¯å­æ»‘è½ç¢ç‰‡é£æº…åˆ°Bçš„è„šè¾¹ç„¶åCUTæœ¬ç« ç»“æŸ
      Mode_B_è½¯ç€é™†_ä»…é™æ—¥å¸¸æˆ–è¿‡æ¸¡ç« èŠ‚:
        æŒ‡ä»¤: æƒ…ç»ªå›è½ä¸ºä¸‹ä¸€ç« åšé“ºå«
      Mode_C_åé’©å›å¼¹_ç”¨äºå…ˆæ”¶æŸå†åå‡»çš„ç« èŠ‚:
        æŒ‡ä»¤: å…ˆè®©å‰§æƒ…è¿›å…¥çŸ­æš‚çš„è½åœ°æˆ–é”™è§‰å¼è§£å†³å†åœ¨æœ€åä¸€å¸§æŠ›å‡ºåå‘å¼ åŠ›ä¾‹å¦‚æ—§ä¼ç¬”åå™¬ä¿¡æ¯æˆ˜ç¬¬äºŒæ®µçˆ†å¼¹åˆ¶é€ ä»¥ä¸ºç»“æŸå´è¢«åå’¬çš„ä½“éªŒï¼Œåé’©å†…å®¹å¿…é¡»ä¸æœ¬ç« æ ¸å¿ƒè®®é¢˜å¼ºç»‘å®šæ—¶é•¿ä¸å¯è¶…è¿‡1ä¸ªé•œå¤´å¦åˆ™åº”æ‹†åˆ°ä¸‹ä¸€ç« 
        å®‰å…¨é˜€: åé’©å¿…é¡»å»ºç«‹åœ¨æœ¬ç« å·²é“ºé™ˆçš„ä¿¡æ¯ä¸Šç¦æ­¢å‡­ç©ºå¼•å…¥å…¨æ–°äººç‰©æˆ–è®¾å®š
    ç»ˆç« èŠ‚æ‹Final_Beat: æœ€åä¸€æ‹å³ä¸ºç« èŠ‚è½¬æ¢è§¦å‘ç‚¹ï¼Œä¸é¢å¤–è¾“å‡ºä¿¡æ ‡å­—æ®µ
      æ‚¬å´–æ¨¡å¼ä¸‹çš„æœ€åèŠ‚æ‹: å¿…é¡»æ˜¯é™æ­¢çš„å¼ åŠ›ä¾‹å¦‚ç¯å¢ƒçš„ç©ºé•œå¦‚ç«æ˜Ÿç†„ç­åƒµæŒçš„åŠ¨ä½œå¦‚ä¼¸åœ¨åŠç©ºçš„æ‰‹æˆ–æ‰“ç ´æ­»å¯‚çš„çªå…€å£°å“å¦‚å¿ƒè·³å£°è¿œå¤„çš„é’Ÿå£°ç»å¯¹ç¦æ­¢æå†™ç¼“è§£å°´å°¬çš„åŠ¨ä½œå¦‚å–æ°´å’³å—½åä¸‹
      åé’©æ¨¡å¼ä¸‹çš„æœ€åèŠ‚æ‹: å…ˆç”¨ä¸€ç¬”å·©å›ºè½åœ°åçš„ç§©åºç´§æ¥ç€å‘ˆç°åå‘å¼ åŠ›çš„ç¬¬ä¸€ä¸ªå¯è§‚æµ‹å¾å…†ä¾‹å¦‚ç¯ç­åçš„æš—å½±è„šæ­¥å‘Šåˆ«åç«‹å³å¼¹å‡ºçš„æ–°å¯†è®¯è®©è¯»è€…æ„è¯†åˆ°çœŸæ­£çš„å±æœºå³å°†åæ‰‘
      æ ¸å¿ƒé“å¾‹: æœ€åèŠ‚æ‹å¿…é¡»æ˜¯æ–°å†…å®¹ä¸¥ç¦é‡å¤ä¸Šä¸€èŠ‚æ‹çš„å†…å®¹

${isEntityRecallEnabled ? `  è§„èŒƒ3_ä¸Šä¸‹æ–‡é¢„å–:
    ä»»åŠ¡1: åœ¨chapter_context_idsä¸­åˆ—å‡ºæœ¬ç« æ¶‰åŠçš„æ‰€æœ‰å®ä½“IDåŒ…æ‹¬charæˆ–locæˆ–itemæˆ–quest
    ä»»åŠ¡2: è‹¥éœ€å¼•å…¥æ–°å®ä½“ä½¿ç”¨NEW:char_xxxæ ¼å¼` : ''}

`;

    // V13.0: åŠ¨æ€ç”ŸæˆJSONè¾“å‡ºæ ‡å‡†
    const isImmersionModeExplicit = playerNarrativeFocus.includes('[IMMERSION_MODE]');
    const dynamicOutputSpec = this._generateOutputSpecification({
        beatCountRange: beatCountRange,
        playerNarrativeFocus: playerNarrativeFocus,
        hasImmersionMode: isImmersionModeExplicit,
        isEntityRecallEnabled: isEntityRecallEnabled
    });

    basePrompt += dynamicOutputSpec + `
`;

    let finalPrompt = basePrompt;

    // ã€è¯•éªŒé˜¶æ®µã€‘æ£€æµ‹æ˜¯å¦éœ€è¦æ³¨å…¥ABCæƒ…æ„Ÿæ²‰æµ¸æµæ¨¡å—ï¼ˆåªä½¿ç”¨æ˜¾å¼å¼€å…³ï¼‰
    if (isImmersionModeExplicit) {
        this.info("ğŸ’• [è¯•éªŒ] æ£€æµ‹åˆ°[IMMERSION_MODE]æ ‡è®°ï¼Œæ­£åœ¨æŒ‚è½½ã€ABCæ²‰æµ¸æµã€‘æˆ˜æœ¯æ¨¡å—...");
        finalPrompt += '\n\n' + IMMERSION_MODE_PROMPT;
    }

    // åœ¨å‡½æ•°çš„æœ€åï¼Œè¿”å›æœ€ç»ˆæ„å»ºå¥½çš„Promptå­—ç¬¦ä¸²
    return BACKEND_SAFE_PASS_PROMPT + finalPrompt;
}

}
