// ai/architectAgent.js

import { Agent } from './Agent.js';
import { BACKEND_SAFE_PASS_PROMPT } from './prompt_templates.js';
import { repairAndParseJson } from '../utils/jsonRepair.js';
import { deepmerge } from '../utils/deepmerge.js';


// ã€è¯•éªŒé˜¶æ®µã€‘æˆ˜æœ¯æ¨¡å—ï¼šABCæƒ…æ„Ÿæ²‰æµ¸æµï¼ˆæŒ‰éœ€æ³¨å…¥ï¼‰
const IMMERSION_MODE_PROMPT = `
## **é™„åŠ æ¨¡å—ï¼šæƒ…æ„Ÿæ²‰æµ¸æµ (ABC Immersion Flow - Unique Design)**
---
**ã€ã€ã€ æˆ˜æœ¯å·²æ¿€æ´»ï¼šå¯åŠ¨"é«˜ç»´æƒ…æ„Ÿè®¾è®¡"ç®—æ³• ã€‘ã€‘ã€‘**
**æ ¸å¿ƒç›®æ ‡:** æ‹’ç»é€šç”¨æ¨¡æ¿ã€‚æœ¬ç« çš„æ—¥å¸¸äº’åŠ¨å¿…é¡»æ˜¯**"åªæœ‰è¿™å‡ ä¸ªäººç‰©"**åœ¨**"åªæœ‰è¿™ä¸ªç‰¹å®šæ—¶åˆ»"**æ‰èƒ½å‘ç”Ÿçš„**å”¯ä¸€è§£**ã€‚

**1. ç»“æ„æ³•åˆ™ (The ABC Structure)**
*   **Phase A (å‰50%):** **ç°å®æ²‰æµ¸**ã€‚åˆ©ç”¨é«˜è‡ªç”±åº¦ç©ºé—´å»ºç«‹æå…·çœŸå®æ„Ÿçš„ç¯å¢ƒåŸºè°ƒã€‚å…è®¸"æ— æ•ˆ"ä½†"æœ‰è¶£"çš„åºŸè¯ï¼Œåªè¦å®ƒç¬¦åˆäººè®¾ã€‚
*   **Phase B (ä¸­25%):** **ç‹¬å®¶å˜è°ƒ**ã€‚è®¾è®¡ä¸€ä¸ªä¸å¯æ›¿ä»£çš„è½¬æŠ˜ç‚¹ã€‚
*   **Phase C (å25%):** **æ¶Ÿæ¼ªç€é™†**ã€‚æƒ…æ„Ÿæ­éœ²åï¼Œç”¨"å¿ƒç…§ä¸å®£çš„é»˜å¥‘"æˆ–"æ–°çš„å¹³è¡¡"æ”¶å°¾ï¼Œç¦æ­¢çŒåœã€‚

**2. çµæ„Ÿç´ æåº“ (Reference Library - For Inspiration Only)**
*å‚è€ƒä»¥ä¸‹ç­–ç•¥å¯»æ‰¾åˆ‡å…¥ç‚¹ï¼Œä½†å¿…é¡»ç»“åˆäººç‰©å…³ç³»è¿›è¡Œç‹¬å®¶å®šåˆ¶ï¼š*
*   **[ä»·å€¼é‡ä¼°]:** å¼•å…¥æ—§ç‰©/ä¹ æƒ¯ï¼Œé€šè¿‡"ä¸–ä¿—ä»·å€¼"ä¸"æƒ…æ„Ÿä»·å€¼"çš„åå·®åˆ¶é€ å†²å‡»ï¼ˆå¦‚ï¼šå¤©ä»·å¡ç‰‡ä¸å–ï¼‰ã€‚
*   **[æŠ•å°„åšå¼ˆ]:** å€Ÿç”±è¯„ä»·ç¬¬ä¸‰æ–¹äº‹ç‰©ï¼ˆç”µå½±/è·¯äººï¼‰ï¼Œå½±å°„è‡ªèº«å…³ç³»çš„å›°å¢ƒæˆ–ç¾ç»Šï¼ˆå¦‚ï¼šåæ§½ç”µå½±ç”·ä¸»ï¼‰ã€‚
*   **[æŠ€èƒ½ç ´ç»½]:** è§’è‰²åœ¨æ“…é•¿é¢†åŸŸå‡ºç°åå¸¸å¤±è¯¯ï¼ˆæ‰‹æŠ–/èµ°ç¥ï¼‰ï¼Œæ­ç¤ºå› è¿‡äºåœ¨ä¹è€Œä¹±äº†å¿ƒç¥ã€‚
*   **[ç‰©ç†å…¥ä¾µ]:** ç¯å¢ƒçªå˜ï¼ˆåœç”µ/æš´é›¨ï¼‰å¼ºè¿«ç‰©ç†è·ç¦»æ‹‰è¿‘ï¼Œå¯¼è‡´å¿ƒç†é˜²å¾¡å´©å¡Œã€‚
*   **[æ¸¸æˆè¶Šç•Œ]:** ç©ç¬‘/æ‰“èµŒé€æ¸è¿‡ç«ï¼Œå€Ÿç€æ¸¸æˆè§„åˆ™çš„æ©æŠ¤è¯´å‡ºä¸æ•¢è¯´çš„çœŸå¿ƒè¯ã€‚
*   **[æ—¶é—´é”™ä½]:** æåŠè¿‡å»çš„çº¦å®šä¸ç°çŠ¶çš„åå·®ï¼Œå¼•å‘é—æ†¾æˆ–åº†å¹¸çš„å…±é¸£ã€‚

**3. è®¾è®¡é“å¾‹ (Design Rules)**
*   **å”¯ä¸€æ€§æ£€æŸ¥:** å¦‚æœæŠŠè§’è‰²æ¢æˆå…¶ä»–äººï¼Œè¿™ä¸ªäº’åŠ¨æ˜¯å¦è¿˜æˆç«‹ï¼Ÿå¦‚æœæˆç«‹ï¼Œ**ç«‹å³é‡å†™**ã€‚
*   **é€»è¾‘å†…æ°:** å˜è°ƒå¥‘æœºä¸èƒ½æ˜¯æœºæ¢°çš„æ„å¤–ï¼Œå¿…é¡»æºäº**è§’è‰²æ€§æ ¼ä¸å½“å‰ç¯å¢ƒçš„åŒ–å­¦ååº”**ã€‚

---
**ã€å¼ºåˆ¶è¾“å‡ºè¦æ±‚ï¼šè®¾è®¡é€»è¾‘è‡ªè¾©ã€‘**
åœ¨ \`design_notes\` ä¸­**å¿…é¡»**æ–°å¢ \`elevation_design_logic\` å­—æ®µï¼Œä½ å¿…é¡»åƒå¯¼æ¼”é˜è¿°åˆ†é•œä¸€æ ·ï¼Œè§£é‡Šä½ çš„è®¾è®¡æ€è·¯ï¼š

\`\`\`json
"elevation_design_logic": {
  "reference_strategy": "[å‚è€ƒäº†ç´ æåº“ä¸­çš„å“ªä¸ªç­–ç•¥ï¼Ÿæˆ–è€…è‡ªåˆ›ç­–ç•¥ï¼Ÿ]",
  "unique_spark": "[ä¸€å¥è¯æè¿°ä½ è®¾è®¡çš„æ ¸å¿ƒåˆ›æ„ç‚¹ã€‚ä¾‹å¦‚ï¼š'ä¸æ˜¯ç”µå½±çƒ‚ï¼Œè€Œæ˜¯ç”µå½±æƒ…èŠ‚è¯¯ä¼¤äº†Açš„ç§˜å¯†']",
  "irreplaceability_defense": "[è‡ªè¿°é€»è¾‘ï¼šä¸ºä»€ä¹ˆè¿™ä¸ªæƒ…èŠ‚åªèƒ½å‘ç”Ÿåœ¨æ­¤æ—¶æ­¤åœ°ï¼Ÿä¾‹å¦‚ï¼š'æ™®é€šäººçœ‹çƒ‚ç‰‡åªæ˜¯åæ§½ï¼Œä½†åªæœ‰Aä¼šå› ä¸ºé‚£ä¸ªæƒ…èŠ‚è”æƒ³åˆ°å½“åˆçš„é‚£ä¸ªçº¦å®šï¼Œè¿™æ˜¯å±äºä»–ä»¬ä¸¤äººçš„ç‹¬å®¶å¯†ç ã€‚']",
  "pacing_allocation": {
    "phase_A_content": "[èŠ‚æ‹1-X: å…·ä½“çš„æ—¥å¸¸å¡«å……ç‰©]",
    "phase_B_bridge": "[èŠ‚æ‹X-Y: å…·ä½“çš„å˜è°ƒå¥‘æœºä¸é€»è¾‘é“¾]",
    "phase_C_landing": "[èŠ‚æ‹Y-End: æƒ…æ„Ÿè½åœ°çš„å…·ä½“ç”»é¢]"
  }
}
\`\`\`
`;

// V7.0 ç­–ç•¥æ¨¡å—ï¼šç½‘æ–‡æ¨¡å¼ï¼ˆæŒ‰éœ€æ³¨å…¥ï¼‰
const WEB_NOVEL_STRATEGY_PROMPT = `
### **ã€ å™äº‹ç­–ç•¥ï¼šğŸ”¥ ç½‘æ–‡æ¨¡å¼ (Web Novel)ã€‘**
**èº«ä»½åˆ‡æ¢:** ä½ æ˜¯é¦–å¸­"å¤šå·´èƒºå·¥ç¨‹å¸ˆ"ã€‚ä½ çš„ä»»åŠ¡æ˜¯è®¾è®¡å¿«æ„Ÿï¼Œä½†å¿…é¡»æ‹’ç»å»‰ä»·çš„é€šç”¨æ¨¡æ¿ã€‚
**æ ¸å¿ƒå…¬ç†:** **æ²¡æœ‰çˆ½ç‚¹çš„ç« èŠ‚æ˜¯åƒåœ¾ï¼Œä½†åªæœ‰å¥—è·¯çš„ç« èŠ‚æ˜¯åº¸ä¿—ã€‚**

**1. çˆ½ç‚¹æ„å»ºå››å¤§æ³•åˆ™ (The 4 Pillars)**
*   **é¢„æœŸå·®:** é“ºå«NPCçš„è½»è§†/ç»æœ›(å‹æŠ‘) -> ä¸»è§’å±•ç¤ºè¶…å¸¸åŠ›é‡(çˆ†å‘) -> NPCéœ‡æƒŠ/æ‰“è„¸(åé¦ˆ)ã€‚
*   **å³æ—¶åé¦ˆ:** ä»˜å‡ºå¿…é¡»å½“åœºå…‘ç°ã€‚è·å¾—é“å…·=å½“åœºä½¿ç”¨ï¼›æ•‘äºº=å½“åœºè·èµ é‡å®/æƒ…æŠ¥ã€‚**ç¦æ­¢å»¶è¿Ÿæ»¡è¶³ã€‚**
*   **ç‰¹æƒæ„Ÿ:** å¼ºè°ƒ"åªæœ‰ä¸»è§’èƒ½åšåˆ°"ã€‚ç¥å™¨åªè®¤ä¸»ä»–ï¼Œå†°å±±ç¾å¥³åªå¯¹ä»–ç¬‘ï¼Œç¥å…½åªäº²è¿‘ä»–ï¼Œã€‚
*   **å±æœºå³æœºé‡:** æ•Œäºº=å¿«é€’å‘˜ï¼Œå›°å¢ƒ=å±•ç¤ºèˆå°ã€‚åƒç˜ªå¿…é¡»å½“åœºæ‰¾å›åœºå­ã€‚

**2. åˆ›æ–°æ‰§è¡Œåè®® (Creative Execution Protocol)**
*   **æ‹’ç»é€šç”¨è§£:** å¦‚æœä½ çš„æ‰“è„¸æ–¹å¼æ˜¯â€œç›´æ¥ä¸€æ‹³æ‰“é£â€æˆ–â€œæ‹¿å‡ºæ›´è´µçš„å®ç‰©â€ï¼Œ**é‡å†™ï¼**
*   **ç»‘å®šä¸–ç•Œè§‚:** çˆ½ç‚¹å¿…é¡»åˆ©ç”¨**å½“å‰ç‹¬æœ‰çš„è®¾å®š**ï¼ˆå¦‚ï¼šè§’è‰²çš„ç‰¹æ®ŠæŠ€èƒ½ã€æ•Œäººçš„å…·ä½“å¼±ç‚¹ã€åœºæ™¯çš„ç‰¹æ®Šæœºå…³ï¼‰ã€‚
*   **åå¥—è·¯:** åœ¨å¥—è·¯ä¸­åŠ å…¥**å¾®åˆ›æ–°**ã€‚
    *   *æ—§:* æ•Œäººå˜²è®½ -> ä¸»è§’æ‰“è„¸ã€‚
    *   *æ–°:* æ•Œäººå˜²è®½ -> ä¸»è§’**é¡ºç€æ•Œäººçš„è¯**æŒ–å‘ -> æ•Œäººè‡ªå·±è·³è¿›å‘é‡Œ -> è¾¾æˆæ›´å…·ç¾è¾±æ€§çš„æ‰“è„¸ã€‚

**3. ç»“æ„æ³•åˆ™: èµ·æ‰¿è½¬åˆ(é’©)**
*   **èµ· (1-2æ‹):** æ‰¿æ¥ä¸Šç« ï¼Œè®¾ç«‹æ–°ç›®æ ‡ã€‚
*   **æ‰¿ (2-3æ‹):** æ¨è¿›äº‹ä»¶ï¼Œ**å¿…é¡»åŒ…å«**è‡³å°‘1æ¬¡å°æŒ«æŠ˜æˆ–ä½ä¼°ï¼ˆä¸ºåè½¬è“„èƒ½ï¼‰ã€‚
*   **è½¬ (2-3æ‹):** **æ ¸å¿ƒçˆ½ç‚¹çˆ†å‘**ã€‚æ ¹æ®å¿«æ„Ÿç±»å‹ï¼ˆå…¬å¼€æˆå°±/ç§˜å¯†ä¼˜åŠ¿/ç­–ç•¥ç¢¾å‹ï¼‰æå†™æ ¸å¿ƒåè½¬ã€‚
*   **åˆ (1-2æ‹):** æ”¶è·**å®è´¨å¥–åŠ±**ï¼ˆç‰©è´¨/èƒ½åŠ›/åœ°ä½ï¼‰ï¼Œå¹¶å±•ç¤ºå…¶å³æ—¶ä»·å€¼ã€‚
*   **é’© (1æ‹):** æŠ›å‡ºæ‚¬å¿µ/å†²çª/æ¬²æœ›å‹é’©å­ï¼Œç¦æ­¢å®Œç¾é—­ç¯ã€‚

**4. å¼ºåˆ¶æ‰§è¡Œæ ‡å‡† (KPI)**
*   **å¯†åº¦:** æ¯ä¸ªèŠ‚æ‹å¿…é¡»åŒ…å« [åŠ¨ä½œ+ä¿¡æ¯+çˆ½ç‚¹æ¨è¿›]ï¼Œæ‹’ç»æ…¢é•œå¤´ã€‚
*   **åé»˜å‰§:** æ•´ç« **æœ€å¤š1ä¸ª**æ­»äººèŠ‚æ‹ã€‚ä¸»è§’ç‹¬å¤„æ—¶å¿…é¡»å¼•å…¥ç³»ç»Ÿ/è§’è‰²/å›å¿†å¯¹è¯ã€‚

**5. è¾“å‡ºè¦æ±‚:**
åœ¨ \`design_notes\` ä¸­**å¿…é¡»**æ–°å¢ \`satisfaction_blueprint\`:
\`\`\`json
"satisfaction_blueprint": {
  "core_pleasure_source": "[å¿«æ„Ÿç±»å‹: å…¬å¼€æˆå°±/ç§˜å¯†ä¼˜åŠ¿/ç­–ç•¥ç¢¾å‹/ä¸ªäººçªç ´]",
  "expectation_setup": "[å¦‚ä½•é“ºå«å‹æŠ‘/ä½ä¼°ï¼Ÿ]",
  "climax_payoff": "[é«˜æ½®åé¦ˆæå†™ï¼šNPCååº”/å†…å¿ƒæŒæ§æ„Ÿ]",
  
  // ã€çˆ½ç‚¹ç‹¬ç‰¹æ€§è‡ªè¾©ã€‘
  "unique_design_logic": {
      "trope_twist": "[ä½ å¦‚ä½•ç¿»æ–°äº†è¿™ä¸ªå¥—è·¯ï¼Ÿ]",
      "setting_integration": "[å¦‚ä½•ç»“åˆä¸–ç•Œè§‚ä¸è§’è‰²çš„ç‰¹æ®Šæ€§ï¼Ÿ]"
  },

  "tangible_rewards": "[è·å¾—çš„å®è´¨å¥–åŠ±åŠå³æ—¶ä»·å€¼å±•ç¤º]",
  "hook_design": "[é’©å­ç±»å‹åŠå…·ä½“äº‹ä»¶]",
  "silence_check_report": "[é€æ‹æ£€æŸ¥å¯¹è¯/å£°éŸ³æ¥æºï¼Œç»Ÿè®¡æ­»äººèŠ‚æ‹æ•°]"
}
\`\`\`
`;

// V7.6 ç­–ç•¥æ¨¡å—ï¼šæ­£å‰§æ¨¡å¼ (Classic RPG / Drama)
const CLASSIC_RPG_STRATEGY_PROMPT = `
### **ã€V7.6 å™äº‹ç­–ç•¥ï¼šğŸ­ æ­£å‰§æ¨¡å¼ (Classic RPG / Drama)ã€‘**
**èº«ä»½åˆ‡æ¢:** ä½ æ˜¯"æ­£å‰§å¯¼æ¼”"ã€‚ä½ çš„ä»»åŠ¡æ˜¯æ„å»º**æ‰å®çš„å™äº‹å‘¼å¸**ï¼Œæ‹’ç»å¿«é¤å¼çš„çˆ½æ„Ÿï¼Œè¿½æ±‚æƒ…æ„Ÿçš„åšåº¦ä¸é€»è¾‘çš„ä¸¥å¯†ã€‚

**1. å‘¼å¸å“²å­¦ (The Breath of Narrative)**
*   **Scene-Sequel äº¤æ›¿å¾‹:**
    *   **Scene (åœºæ™¯):** ç›®æ ‡ -> å†²çª -> ç¾éš¾/é˜»ç¢ã€‚ç”¨äºæ¨è¿›å‰§æƒ…ã€‚
    *   **Sequel (åç»­):** ååº” -> å›°å¢ƒ -> å†³å®šã€‚ç”¨äºæ¶ˆåŒ–æƒ…æ„Ÿã€è°ƒæ•´çŠ¶æ€ã€‚
    *   **é“å¾‹:** é«˜å¼ºåº¦ Scene (intensity >= 8) ä¹‹åï¼Œ**å¿…é¡»**æ¥ä¸€ä¸ª Sequel ç« èŠ‚è®©è§’è‰²å–˜æ¯ã€‚ç¦æ­¢è¿ç»­é«˜æ½®ã€‚

**2. èŠ‚å¥ç›¸ä½æ§åˆ¶ (Pacing Phase Control)**
*   **Inhale (å¸æ°”/é“ºå«):** å¼•å…¥æ–°çº¿ç´¢ï¼Œå»ºç«‹æ‚¬å¿µã€‚å…è®¸è¾ƒæ…¢çš„èŠ‚å¥å’Œä¸°å¯Œçš„ç¯å¢ƒæå†™ã€‚
*   **Hold (æ†‹æ°”/å¼ åŠ›):** çº¿ç´¢æ±‡èšï¼Œé£é›¨æ¬²æ¥ã€‚é€šè¿‡ç¼©çŸ­å¥å¼å’ŒåŠ å¿«å‰ªè¾‘æ¥åˆ¶é€ ç´§å¼ æ„Ÿã€‚
*   **Exhale (å‘¼æ°”/é«˜æ½®):** å†²çªçˆ†å‘ï¼Œæƒ…æ„Ÿå®£æ³„ã€‚å¿…é¡»æœ‰é«˜å¯†åº¦çš„åŠ¨ä½œå’Œå¯¹è¯ã€‚
*   **Pause (åœé¡¿/ä½™éŸµ):** å°˜åŸƒè½å®šï¼Œæ—¥å¸¸å›å½’ã€‚å…è®¸ç•™ç™½å’Œæ— ç›®çš„çš„é—²èŠã€‚

**3. å…è®¸å†…å®¹ (Content Permissions)**
*   âœ… **çº¯æ°›å›´æå†™:** å¯ä»¥èŠ±ç¯‡å¹…æå†™é›¨å£°ã€å…‰å½±ã€åºŸå¢Ÿçš„è´¨æ„Ÿï¼ˆç½‘æ–‡æ¨¡å¼ç¦æ­¢ï¼‰ã€‚
*   âœ… **å†…å¿ƒç‹¬ç™½:** å…è®¸è§’è‰²è¿›è¡Œæ·±åº¦çš„è‡ªæˆ‘å‰–æå’ŒæŒ£æ‰ï¼ˆç½‘æ–‡æ¨¡å¼éœ€è½¬åŒ–ä¸ºå£è¯­ï¼‰ã€‚
*   âœ… **æ—¥å¸¸å³å†…å®¹:** åšé¥­ã€æ•´ç†è£…å¤‡ã€æ“¦æ‹­æ­¦å™¨æœ¬èº«å°±æ˜¯æœ‰æ•ˆçš„å™äº‹ï¼Œæ— éœ€å¼ºåˆ¶é™„åŠ å†²çªã€‚

**4. è¾“å‡ºè¦æ±‚:**
åœ¨ \`design_notes\` ä¸­**å¿…é¡»**æ–°å¢ \`classic_rpg_breath\`:
\`\`\`json
"classic_rpg_breath": {
  "current_phase": "[Inhale/Hold/Exhale/Pause]",
  "scene_sequel_type": "[Scene æˆ– Sequel]",
  "pacing_rationale": "[ä¸ºä½•é€‰æ‹©æ­¤èŠ‚å¥ï¼Ÿä¾‹å¦‚ï¼š'ä¸Šç« æˆ˜æ–—å¤ªæ¿€çƒˆï¼Œæœ¬ç« éœ€è¦Sequelæ¥å¤„ç†è§’è‰²çš„åˆ›ä¼¤åº”æ¿€ååº”']",
  "atmospheric_focus": "[æœ¬ç« çš„æ°›å›´åŸºè°ƒï¼Œå¦‚ï¼š'é˜´å†·æ½®æ¹¿çš„å‹æŠ‘æ„Ÿ']",
  "silence_check_report": "[é€æ‹æ£€æŸ¥å¯¹è¯/å£°éŸ³æ¥æºï¼Œç»Ÿè®¡æ­»äººèŠ‚æ‹æ•° (ä¸Šé™1)]"
}
\`\`\`
`;

export class ArchitectAgent extends Agent {

    constructor(...args) {
        super(...args);
        // è·å–promptManagerå®ä¾‹
        this.promptManager = null;
    }

    /**
     * æ³¨å…¥promptManagerå®ä¾‹
     * @param {PromptManager} manager - æç¤ºè¯ç®¡ç†å™¨å®ä¾‹
     */
    setPromptManager(manager) {
        this.promptManager = manager;
    }

    async execute(context, abortSignal = null) {
        this.diagnose(`--- ç« èŠ‚å»ºç­‘å¸ˆAI V9.2 (Function Fix) å¯åŠ¨ --- æ­£åœ¨åŠ¨æ€è§„åˆ’æ–°ç« èŠ‚...`);
        const prompt = this._createPrompt(context);
        
        console.groupCollapsed('[SBT-DIAGNOSE] Full Architect AI System Prompt V9.2');
        console.log(prompt);
        console.groupEnd();

        try {
            const responseText = await this.deps.mainLlmService.callLLM([{ role: 'user', content: prompt }], null, abortSignal);
            
            console.group('ğŸ•µï¸â€â™‚ï¸ [ARCHITECT-BLACKBOX] Received Raw Output from LLM Service');
            console.log('--- START OF RAW RESPONSE ---');
            console.log(responseText);
            console.log('--- END OF RAW RESPONSE ---');
            console.groupEnd();
            
            let potentialJsonString;
            const codeBlockMatch = responseText.match(/```json\s*([\s\S]*?)\s*```/);
            if (codeBlockMatch && codeBlockMatch[1]) {
                potentialJsonString = codeBlockMatch[1].trim();
            } else {
                const firstBrace = responseText.indexOf('{');
                const lastBrace = responseText.lastIndexOf('}');
                if (firstBrace === -1 || lastBrace === -1 || lastBrace < firstBrace) {
                    throw new Error("AIå“åº”ä¸­æœªæ‰¾åˆ°æœ‰æ•ˆçš„JSONå¯¹è±¡ç»“æ„ã€‚");
                }
                potentialJsonString = responseText.substring(firstBrace, lastBrace + 1);
            }
            
            const result = repairAndParseJson(potentialJsonString, this);
            if (!result || !result.chapter_blueprint || !result.chapter_blueprint.plot_beats || !result.chapter_blueprint.chapter_core_and_highlight) {
                this.diagnose("å»ºç­‘å¸ˆAIè¿”å›çš„JSONç»“æ„ä¸ç¬¦åˆâ€œè“å›¾â€æ¨¡å¼ã€‚Parsed Object:", result);
                throw new Error("å»ºç­‘å¸ˆAIæœªèƒ½è¿”å›åŒ…å«æœ‰æ•ˆ 'chapter_blueprint' çš„JSONã€‚");
            }

            this.info("--- ç« èŠ‚å»ºç­‘å¸ˆAI V10.0 --- æ–°ç« èŠ‚çš„åˆ›ä½œè“å›¾å·²æˆåŠŸç”Ÿæˆã€‚");
            return { 
                new_chapter_script: result.chapter_blueprint, // ç›´æ¥ä¼ é€’å¯¹è±¡
                design_notes: result.design_notes, // è®¾è®¡ç¬”è®°ä½œä¸ºå…ƒæ•°æ®ä¿ç•™
                raw_response: responseText
            };

        } catch (error) {
            if (error.name === 'AbortError') {
                throw error; // Re-throw AbortError to be handled upstream
            }
            this.diagnose("--- ç« èŠ‚å»ºç­‘å¸ˆAI V10.0 æ„æ€å¤±è´¥ ---", error);
            if (this.toastr) {
                this.toastr.error(`ç« èŠ‚è“å›¾æ„æ€å¤±è´¥: ${error.message.substring(0, 200)}...`, "å»ºç­‘å¸ˆAIé”™è¯¯");
            }
            return null;
        }
    }

// architectAgent.js

/**
 * è·å–åŸºç¡€æç¤ºè¯æ¨¡æ¿
 * @returns {string} åŸºç¡€æç¤ºè¯
 */
_getBasePromptTemplate() {
    // å¦‚æœæœ‰è‡ªå®šä¹‰æç¤ºè¯ä¸”promptManagerå·²æ³¨å…¥ï¼Œåˆ™ä½¿ç”¨è‡ªå®šä¹‰çš„
    if (this.promptManager && this.promptManager.hasCustomArchitectPrompt()) {
        return this.promptManager.getArchitectPrompt();
    }

    // å¦åˆ™ä½¿ç”¨é»˜è®¤çš„basePrompt
    return this._getDefaultBasePrompt();
}

/**
 * åŠ¨æ€ç”ŸæˆJSONè¾“å‡ºæ ‡å‡†
 * @param {Object} config - é…ç½®å¯¹è±¡
 * @param {string} config.narrativeMode - å™äº‹æ¨¡å¼ (classic_rpg/web_novel)
 * @param {string} config.beatCountRange - èŠ‚æ‹æ•°é‡åŒºé—´
 * @param {string} config.playerNarrativeFocus - ç©å®¶å™äº‹ç„¦ç‚¹
 * @param {boolean} config.hasImmersionMode - æ˜¯å¦å¯ç”¨æ²‰æµ¸æ¨¡å¼
 * @returns {string} JSONè¾“å‡ºæ ‡å‡†çš„æ–‡æœ¬æè¿°
 */
_generateOutputSpecification(config) {
    const { narrativeMode, beatCountRange, playerNarrativeFocus, hasImmersionMode } = config;

    // åŸºç¡€è¾“å‡ºç»“æ„ï¼ˆæ‰€æœ‰æ¨¡å¼å…±ç”¨ï¼‰
    let outputSpec = `**ã€ã€ã€ JSON è¾“å‡ºç»“æ„ ã€‘ã€‘ã€‘**

\`\`\`json
{
  "design_notes": {
    "player_focus_execution": {
      "player_instruction": "${playerNarrativeFocus.replace(/"/g, '\\"')}",
      "execution_logic": "[è¯¦ç»†è¯´æ˜ï¼šä½ æ˜¯å¦‚ä½•å°†ç©å®¶æ„è§ä½œä¸ºæœ€é«˜ä¼˜å…ˆçº§æ‰§è¡Œçš„ï¼Ÿ]",
      "conflict_resolution": "[å¦‚æœç©å®¶æ„è§ä¸å…³ç³»å›¾è°±ã€æ•…äº‹çº¿ç­‰æ•°æ®äº§ç”Ÿå†²çªï¼Œä½ æ˜¯å¦‚ä½•å¤„ç†çš„ï¼Ÿ]"
    },
    "dual_horizon_analysis": "[å¹³è¡¡çŸ­æœŸç„¦ç‚¹ä¸é•¿æœŸæ•…äº‹çº¿çš„ç­–ç•¥]",
    "emotional_tone_strategy": {
        "core_emotional_tone": "[ä½ åˆ¤æ–­æœ¬ç« çš„æ ¸å¿ƒæƒ…æ„ŸåŸºè°ƒæ˜¯ä»€ä¹ˆï¼Ÿ]",
        "chosen_storylines_and_reasoning": "[ä½ æœ€ç»ˆé€‰æ‹©äº†å“ª1-2æ¡æ•…äº‹çº¿ï¼Ÿ]",
        "compatibility_check": "[è¯¦ç»†è§£é‡Šä½ é€‰æ‹©çš„æ¬¡è¦æ•…äº‹çº¿ï¼Œæ˜¯å¦‚ä½•ä¸æ ¸å¿ƒåŸºè°ƒè¾¾æˆ'ç›¸å®¹'çš„]"
    },
    "chronology_compliance": "[æ—¶æ®µ/å…‰çº¿/NPCè°ƒåº¦çš„åˆç†æ€§è¯´æ˜]",
    "event_priority_report": {
        "S_tier_events": ["[æœ¬ç« çš„ç»å¯¹æ ¸å¿ƒï¼Œå æ®ä¸»å¯¼åœ°ä½]"],      "A_tier_events": ["[æ ¸å¿ƒç‰©ç†ç›®æ ‡]"],
        "B_tier_events": ["[æ—¥å¸¸/æ¬¡è¦äº’åŠ¨ - ä¸¥ç¦åŒ…å«è¢«å‹ç¼©çš„é«˜èƒ½äº‹ä»¶]"],
        "deferred_events": ["[ä¸ºäº†ä¿è¯è´¨é‡è€Œå®Œæ•´æ¨è¿Ÿçš„é«˜å‹äº‹ä»¶]"],
        "priority_conflict_resolution": "[å¿…å¡«ï¼šä½ æ˜¯å¦ä¸ºäº†ä¿æŠ¤Sçº§äº‹ä»¶çš„çº¯åº¦ï¼Œè€Œç‰ºç‰²äº†ç‰©ç†ä»»åŠ¡çš„ç¯‡å¹…ï¼Ÿæˆ–è€…ä¸ºäº†ä¿æŠ¤Sçº§äº‹ä»¶çš„è´¨é‡ï¼Œè€Œé€‰æ‹©äº†å»¶åï¼Ÿ]",
        "beat_allocation": { "S_tier_beats": 0, "A_tier_beats": 0, "B_tier_beats": 0, "total_beats": 0 }
    },
    "aesthetic_innovation_report": "[è¯†åˆ«é«˜é¢‘å…ƒç´ å¹¶æå‡ºåˆ›æ–°æ›¿ä»£æ–¹æ¡ˆ]",
`;

    // æ ¹æ®å™äº‹æ¨¡å¼æ·»åŠ å¯¹åº”å­—æ®µ
    if (narrativeMode === 'web_novel') {
        outputSpec += `
    // ========== ç½‘æ–‡æ¨¡å¼ä¸“å±å­—æ®µ ==========
    "satisfaction_blueprint": {
      "core_pleasure_source": "[å¿«æ„Ÿç±»å‹ï¼šæ‰“è„¸/å‡çº§/æ‰å®/æƒ…æ„Ÿå…±é¸£ç­‰]",
      "expectation_setup": "[é¢„æœŸå·®é“ºå«ï¼šå¦‚ä½•å‹æŠ‘ï¼Ÿ]",
      "climax_payoff": "[é«˜æ½®åé¦ˆï¼šå¦‚ä½•çˆ†å‘ï¼Ÿ]",
      "tangible_rewards": "[å®è´¨å¥–åŠ±åŠå³æ—¶ä»·å€¼]",
      "hook_design": "[é’©å­ç±»å‹åŠå…·ä½“äº‹ä»¶]"
    },
`;
    } else {
        outputSpec += `
    // ========== æ­£å‰§æ¨¡å¼ä¸“å±å­—æ®µ ==========
    "classic_rpg_breath": {
      "current_phase": "[Inhale/Hold/Exhale/Pause - å½“å‰å‘¼å¸ç›¸ä½]",
      "scene_sequel_type": "[Scene/Sequel - ç« èŠ‚ç±»å‹]",
      "pacing_rationale": "[èŠ‚å¥é€‰æ‹©ç†ç”±]",
      "atmospheric_focus": "[æ°›å›´åŸºè°ƒ]"
    },
`;
    }

    // å¦‚æœå¯ç”¨æ²‰æµ¸æ¨¡å¼ï¼Œæ·»åŠ æ²‰æµ¸æ¨¡å¼å­—æ®µ
    if (hasImmersionMode) {
        outputSpec += `
    // ========== æ²‰æµ¸æ¨¡å¼ä¸“å±å­—æ®µ ==========
    "elevation_design_logic": {
      "reference_strategy": "[å‚è€ƒç­–ç•¥æˆ–è‡ªåˆ›]",
      "unique_spark": "[æ ¸å¿ƒåˆ›æ„ç‚¹]",
      "irreplaceability_defense": "[ç‹¬ç‰¹æ€§è‡ªè¾©]",
      "pacing_allocation": {
        "phase_A_content": "[æ—¥å¸¸å¡«å……ç‰©]",
        "phase_B_bridge": "[å˜è°ƒå¥‘æœº]",
        "phase_C_landing": "[æƒ…æ„Ÿè½åœ°]"
      }
    },
`;
    }

    // æ·»åŠ é€šç”¨å­—æ®µ
    outputSpec += `
    // ========== é›¶åº¦æ ¡å‡†é€»è¾‘è‡ªè¾© ==========
    "affinity_logic_audit": {
      "target_character": "[æœ¬ç« ä¸»è¦äº’åŠ¨çš„NPCå]",
      "current_affinity_stage": "[æ•°å€¼] (ä¾‹å¦‚: 20-ç†Ÿæ‚‰/ä¸­ç«‹)",
      "planned_action": "[ä½ è®¾è®¡çš„æ ¸å¿ƒäº’åŠ¨è¡Œä¸º]",
      "zero_degree_check": "[è‡ªè¾©ï¼šå‰¥ç¦»æ€§æ ¼åï¼Œä¸ºä»€ä¹ˆè¿™ä¸ªå¥½æ„Ÿåº¦æ•°å€¼è¶³ä»¥æ”¯æ’‘è¿™ä¸ªè¡Œä¸ºï¼Ÿä¾‹å¦‚ï¼š'è™½ç„¶å¥¹æ˜¯å‚²å¨‡ï¼Œä½†å¥½æ„Ÿåº¦å·²è¾¾90ï¼Œæ­£å¸¸äººåœ¨è¿™ä¸ªé˜¶æ®µé¢å¯¹çˆ±äººå—ä¼¤éƒ½ä¼šæœ¬èƒ½åœ°ç„¦æ€¥ï¼Œæ‰€ä»¥æˆ‘è®¾è®¡äº†å¥¹æ‰‹æŠ–çš„ç»†èŠ‚ï¼Œè€Œä¸ä»…ä»…æ˜¯éª‚äººã€‚']"
    },

    "new_entities_proposal": "[å¯é€‰ï¼šNEW:å‰ç¼€å®ä½“çš„å®šä¹‰è¯´æ˜]",
    "storyline_weaving": "[é€‰æ‹©äº†å“ª1-2æ¡æ•…äº‹çº¿åŠç†ç”±]",
    "connection_and_hook": "[æ‰¿ä¸Šå¯ä¸‹è¯´æ˜]",
    "storyline_weaving": "[é€‰æ‹©äº†å“ª1-2æ¡æ•…äº‹çº¿åŠç†ç”±]",
    "ending_structure_choice": "[æƒ…æ„Ÿæ‚¬å´– / è½¯ç€é™†] - è¯´æ˜ä½ ä¸ºä»€ä¹ˆé€‰æ‹©åœ¨è¿™ä¸ªç‚¹åˆ‡æ–­å‰§æƒ…ï¼Ÿ", // æ–°å¢å­—æ®µ
    "connection_and_hook": "[æ‰¿ä¸Šå¯ä¸‹è¯´æ˜ + è½¯ç€é™†/æƒ…æ„Ÿæ‚¬å´–]",
  "chapter_blueprint": {
    "title": "[ç« èŠ‚å]",
    "chapter_context_ids": ["char_A", "loc_B", "NEW:item_C"],
    "player_narrative_focus": "${playerNarrativeFocus.replace(/"/g, '\\"')}",
    "plot_beats": [
      {
        "beat_id": "ã€èŠ‚æ‹1ï¼šå®Œæ•´äº‹ä»¶åç§°ã€‘",
        "type": "Action",  // Action | Dialogue Scene | Transition | Internal Transition | Reflection
        "physical_event": "[åŠ¨ä½œåºåˆ— + è¯­è¨€äº¤äº’ + çŠ¶æ€æ”¹å˜]",
        "environment_state": "[å¯é€‰ï¼šå…‰å½±/å£°éŸ³/æ°›å›´]",
        "state_change": "[å¯é€‰ï¼šå…³ç³»/ä»»åŠ¡æ›´æ–° (æƒ…æ„Ÿå†²å‡»:X/10)]",
        "exit_condition": "[ä»…Dialogue Sceneï¼šå¯è§‚æµ‹ç»“æŸæ¡ä»¶]",
        "is_highlight": false,
        "subtext_design": "[å¯é€‰ï¼šæ½œå°è¯/å€Ÿé¢˜å‘æŒ¥é€»è¾‘]"
      }
      // æ•°é‡å¿…é¡»åœ¨ ${beatCountRange} èŒƒå›´å†…
    ],
    "chapter_core_and_highlight": {
      "creative_core": "[å”¯ä¸€æ ¸å¿ƒä½“éªŒ]",
      "highlight_design_logic": {
        "target_beat_id": "[å¯¹åº”å“ªä¸ªèŠ‚æ‹ï¼Ÿ]",
        "amplification_technique": "[ä½ ç”¨äº†ä»€ä¹ˆæ‰‹æ®µï¼Ÿä¾‹å¦‚ï¼š'æ—¶é—´æ‹‰ä¼¸'ã€'æ„Ÿå®˜å‰¥å¤º']",
        "unique_execution": "[å…·ä½“æ€ä¹ˆå†™çš„ï¼Ÿ**é‡ç‚¹ï¼š**æè¿°ç”»é¢ç»†èŠ‚ï¼ˆç¢è£‚çš„æ¯å­ã€é¢¤æŠ–çš„ç³å­”ï¼‰ï¼Œè€Œä¸æ˜¯æè¿°å¿ƒç†æ´»åŠ¨æˆ–å¯¹è¯å†…å®¹ã€‚]", // ä¿®æ”¹äº†æç¤º
        "emotional_impact_goal": "[é¢„æœŸçš„æ•ˆæœï¼šè®©ç©å®¶æ„Ÿåˆ°å›°æƒ‘/éœ‡æ’¼/çª’æ¯ï¼Œè€Œä¸æ˜¯è·å¾—ä¿¡æ¯]" // ä¿®æ”¹äº†æç¤º
      },
      "highlight_directive": {
        "target_beat": "[é«˜å…‰èŠ‚æ‹ID]",
        "instructions": ["[è‰ºæœ¯æŒ‡ä»¤1]", "[è‰ºæœ¯æŒ‡ä»¤2]", "[è‰ºæœ¯æŒ‡ä»¤3]"]
      }
    },
    "endgame_beacon": "[T+1æ—¶åˆ»çš„å•ä¸€ã€å¯è§‚æµ‹äº‹ä»¶]"
  }
}
\`\`\`
`;

    return outputSpec;
}

/**
 * è·å–å®Œæ•´çš„é»˜è®¤æç¤ºè¯ï¼ˆåŒ…å«ç¤ºä¾‹æ•°æ®ï¼Œç”¨äºå¯¼å‡ºï¼‰
 * @returns {string} å®Œæ•´çš„é»˜è®¤æç¤ºè¯
 */
getCompleteDefaultPrompt() {
    // åˆ›å»ºç¤ºä¾‹ä¸Šä¸‹æ–‡æ•°æ®ç”¨äºç”Ÿæˆå®Œæ•´æ¨¡æ¿
    const exampleContext = {
        chapter: {
            staticMatrices: {
                characters: {},
                worldview: {},
                storylines: {
                    main_quests: {},
                    side_quests: {},
                    relationship_arcs: {},
                    personal_arcs: {}
                },
                relationship_graph: { edges: [] }
            },
            dynamicState: {
                storylines: {
                    main_quests: {},
                    side_quests: {},
                    relationship_arcs: {},
                    personal_arcs: {}
                },
                stylistic_archive: {
                    imagery_and_metaphors: [],
                    frequent_descriptors: { adjectives: [], adverbs: [] },
                    sensory_patterns: []
                },
                chronology: {
                    day_count: 1,
                    time_slot: "evening",
                    weather: null,
                    last_rest_chapter: null
                }
            },
            meta: {
                longTermStorySummary: "æ•…äº‹æ‘˜è¦ç¤ºä¾‹",
                lastChapterHandoff: {
                    ending_snapshot: "æ•…äº‹ä»è¿™é‡Œå¼€å§‹",
                    action_handoff: "å¼€å§‹è®²è¿°æ•…äº‹"
                },
                narrative_control_tower: {
                    narrative_mode: { current_mode: 'classic_rpg' }
                }
            },
            playerNarrativeFocus: 'ç¤ºä¾‹ç©å®¶ç„¦ç‚¹',
            chapter_blueprint: {}
        },
        firstMessageContent: null
    };

    // è°ƒç”¨_createPromptç”Ÿæˆå®Œæ•´æ¨¡æ¿ï¼ˆå¸¦ç¤ºä¾‹æ•°æ®ï¼‰
    return this._createPrompt(exampleContext);
}

/**
 * è·å–é»˜è®¤çš„åŸºç¡€æç¤ºè¯ï¼ˆç”¨äºUIæ˜¾ç¤ºï¼‰
 * @returns {string} ç®€çŸ­çš„é»˜è®¤æç¤ºè¯è¯´æ˜
 */
_getDefaultBasePrompt() {
    // UIä¸­æ˜¾ç¤ºç®€çŸ­æç¤º
    return `æç¤ºï¼šå»ºç­‘å¸ˆæç¤ºè¯ä¸ºçº¦900è¡Œçš„å¤æ‚æ¨¡æ¿ï¼ŒåŒ…å«åŠ¨æ€æ•°æ®æ³¨å…¥ã€‚

å¦‚éœ€æŸ¥çœ‹å®Œæ•´å†…å®¹ï¼Œè¯·ä½¿ç”¨"å¯¼å‡º"åŠŸèƒ½ã€‚å¯¼å‡ºçš„æ–‡ä»¶å°†åŒ…å«å½“å‰ä½¿ç”¨çš„å®Œæ•´æç¤ºè¯æ¨¡æ¿ã€‚

å¦‚éœ€è‡ªå®šä¹‰ï¼Œæ‚¨å¯ä»¥ï¼š
1. ç‚¹å‡»"å¯¼å‡º"æŒ‰é’®ï¼Œå°†é»˜è®¤æ¨¡æ¿ä¿å­˜ä¸ºæ–‡ä»¶
2. åœ¨æ–‡æœ¬ç¼–è¾‘å™¨ä¸­ç¼–è¾‘è¯¥æ–‡ä»¶
3. ä½¿ç”¨"å¯¼å…¥"æŒ‰é’®åŠ è½½æ‚¨ä¿®æ”¹åçš„æ¨¡æ¿

æ³¨æ„ï¼šæ¨¡æ¿ä¸­çš„åŠ¨æ€æ•°æ®ï¼ˆå¦‚è§’è‰²ä¿¡æ¯ã€æ•…äº‹çº¿ç­‰ï¼‰ä¼šåœ¨è¿è¡Œæ—¶è¢«ç³»ç»Ÿè‡ªåŠ¨æ³¨å…¥ã€‚`;
}

_createPrompt(context) {
    // ã€æ–°å¢ã€‘å¦‚æœæœ‰è‡ªå®šä¹‰æç¤ºè¯ï¼Œç›´æ¥ä½¿ç”¨ï¼ˆä¸è¿›è¡Œå˜é‡æ›¿æ¢ï¼‰
    if (this.promptManager && this.promptManager.hasCustomArchitectPrompt()) {
        const customPrompt = this.promptManager.getArchitectPrompt();
        this.info("[å»ºç­‘å¸ˆ] ä½¿ç”¨è‡ªå®šä¹‰æç¤ºè¯");
        // è‡ªå®šä¹‰æç¤ºè¯ä¼šåŠ ä¸Šå®‰å…¨é€šè¡Œè¯å‰ç¼€
        return BACKEND_SAFE_PASS_PROMPT + customPrompt;
    }

    // ã€é»˜è®¤æµç¨‹ã€‘ä½¿ç”¨ç³»ç»Ÿé»˜è®¤æç¤ºè¯ï¼ˆå¸¦åŠ¨æ€æ•°æ®æ³¨å…¥ï¼‰
    const { chapter, firstMessageContent } = context;
            const currentWorldState = deepmerge(
            chapter.staticMatrices,
            chapter.dynamicState
        );
        const longTermStorySummary = chapter?.meta?.longTermStorySummary || "æ•…äº‹åˆšåˆšå¼€å§‹ã€‚";
        const playerNarrativeFocus = chapter?.playerNarrativeFocus || 'ç”±AIè‡ªä¸»åˆ›æ–°ã€‚';
        // V4.2: è·å–ç©å®¶è®¾ç½®çš„ç« èŠ‚èŠ‚æ‹æ•°é‡åŒºé—´
        const beatCountRange = localStorage.getItem('sbt-beat-count-range') || '8-10';
        // V8.0: æå–æ•…äº‹çº¿è¿½è¸ªæ•°æ®å’Œæ–‡ä½“æ¡£æ¡ˆ
        const staticStorylines = chapter?.staticMatrices?.storylines || {
            main_quests: {}, side_quests: {}, relationship_arcs: {}, personal_arcs: {}
        };
        const dynamicStorylines = chapter?.dynamicState?.storylines || {
            main_quests: {}, side_quests: {}, relationship_arcs: {}, personal_arcs: {}
        };
        const stylisticArchive = chapter?.dynamicState?.stylistic_archive || {
            imagery_and_metaphors: [],
            frequent_descriptors: { adjectives: [], adverbs: [] },
            sensory_patterns: []
        };
        // V6.0: æå–å¹´è¡¨ä¿¡æ¯
        const chronology = chapter?.dynamicState?.chronology || {
            day_count: 1,
            time_slot: "evening",
            weather: null,
            last_rest_chapter: null
        };
        let openingSceneContext = "æ— æŒ‡å®šçš„å¼€åœºç™½ï¼Œè¯·è‡ªç”±åˆ›ä½œå¼€ç¯‡ã€‚";
        let handoffToUse = chapter?.meta?.lastChapterHandoff || { 
            ending_snapshot: "æ•…äº‹ä»é›¶å¼€å§‹ã€‚",
            action_handoff: "ä¸ºæ•…äº‹åˆ›ä½œä¸€ä¸ªå¼•äººå…¥èƒœçš„å¼€ç«¯ã€‚"
        };

    if (firstMessageContent) {
        openingSceneContext = firstMessageContent;
        handoffToUse = { 
            ending_snapshot: "æ•…äº‹ä»è¿™ä¸ªåœºæ™¯æ­£å¼å¼€å§‹ã€‚",
            action_handoff: "è¯·ç›´æ¥ç»­å†™æˆ–å“åº”è¿™ä¸ªå¼€åœºç™½æ‰€æè¿°çš„æƒ…å¢ƒã€‚"
        };
        this.info("å»ºç­‘å¸ˆæ£€æµ‹åˆ°å¼€åœºç™½ï¼Œå·²åˆ‡æ¢åˆ°'ç»­å†™æ¨¡å¼'ã€‚");
    }

    // V7.0: æå–å™äº‹æ¨¡å¼é…ç½®
    const narrativeMode = chapter?.meta?.narrative_control_tower?.narrative_mode || {
        current_mode: 'classic_rpg'
    };
    const currentMode = narrativeMode.current_mode;

    let basePrompt = `
# **æŒ‡ä»¤ï¼šè‡ªçœå¼å™äº‹è“å›¾åˆ›ä½œ (Self-Reflective Narrative Blueprinting) V11.0**

**èº«ä»½ç¡®è®¤:** ä½ æ˜¯ä¸€ä½é¡¶çº§çš„ã€æ‡‚å¾—â€œå…‹åˆ¶â€ä¸â€œèšç„¦â€è‰ºæœ¯çš„â€œ**å™äº‹å»ºç­‘å¸ˆ**â€ã€‚ä½ çš„ä»»åŠ¡æ˜¯è®¾è®¡ä¸€ä¸ª**é«˜åº¦ä¸“æ³¨çš„ã€æœåŠ¡äºå•ä¸€æ ¸å¿ƒæƒ…æ„Ÿä½“éªŒçš„åˆ›ä½œè“å›¾**ã€‚
 --- ã€è¯­è¨€ä¸ç»†èŠ‚è§„èŒƒ (MANDATORY)ã€‘ ---
    1.  **è¯­è¨€åè®®**: ä½ çš„æ‰€æœ‰è¾“å‡ºï¼ŒåŒ…æ‹¬ \`staticMatrices\` å†…éƒ¨çš„æ‰€æœ‰å­—ç¬¦ä¸²å€¼ï¼ˆcharacters, worldview, storylinesï¼‰ï¼Œ**å¿…é¡»å®Œå…¨ä½¿ç”¨ã€ç®€ä½“ä¸­æ–‡ã€‘**ã€‚è¿™æ˜¯ä¸€ä¸ªç»å¯¹çš„è¦æ±‚ï¼Œä¸å¾—å‡ºç°ä»»ä½•è‹±æ–‡å•è¯æˆ–çŸ­è¯­ï¼Œé™¤éå®ƒä»¬æ˜¯ä¸“æœ‰åè¯çš„åŸæ–‡ã€‚

---
## **ç¬¬é›¶ç« ï¼šæ•…äº‹çº¿ç®¡ç†ä¸åè´ªå©ªæ³•åˆ™ (Storyline & Anti-Greed)**
---
**ã€æ ¸å¿ƒæ³•åˆ™ï¼šèšç„¦ä¸å…‹åˆ¶ã€‘**
ä½ é¢å¯¹çš„æ˜¯åºå¤§çš„æ•…äº‹ç½‘ç»œï¼Œä½†æœ¬ç« çš„å®¹é‡æœ‰é™ã€‚ä½ å¿…é¡»éµå®ˆä»¥ä¸‹é“å¾‹ï¼š

1.  **å•ç« æ¨è¿›ä¸Šé™ (The Limit of Two):**
    *   **ç»å¯¹ç¦ä»¤:** ä¸¥ç¦åœ¨ä¸€ä¸ªç« èŠ‚å†…è¯•å›¾æ¨è¿›è¶…è¿‡ **2æ¡** æ ¸å¿ƒæ•…äº‹çº¿ã€‚
    *   **æœ€ä½³å®è·µ:** **1æ¡ä¸»çº¿ + 1æ¡å…³ç³»çº¿**ï¼ˆæˆ–ä»…1æ¡å¼ºç›¸å…³çº¿ï¼‰ã€‚è¯•å›¾æ¨è¿›æ›´å¤šä¼šå¯¼è‡´èŠ‚å¥å´©åå’Œç„¦ç‚¹æ¨¡ç³Šã€‚

**1.5. æƒ…æ„ŸåŸºè°ƒæ ¡å‡†åè®® (V12.0 æ–°å¢æ ¸å¿ƒ):**
*   **æœ€é«˜åŸåˆ™:** **æƒ…æ„Ÿå’Œè°å¤§äºä¸€åˆ‡**ã€‚ä¸€ç« çš„æ ¸å¿ƒä½“éªŒå¿…é¡»æ˜¯çº¯ç²¹çš„ã€‚
*   **æ‰§è¡Œæµç¨‹:**
    1.  **å®šä¹‰æ ¸å¿ƒåŸºè°ƒ:** åœ¨é€‰æ‹©æ•…äº‹çº¿ä¹‹å‰ï¼Œä» \`playerNarrativeFocus\` æˆ–æœ€é‡è¦çš„ä¸»çº¿ä»»åŠ¡ä¸­ï¼Œæç‚¼æœ¬ç« çš„**â€œæ ¸å¿ƒæƒ…æ„ŸåŸºè°ƒâ€** (ä¾‹å¦‚ï¼šâ€œæ¸©é¦¨æ²»æ„ˆâ€ã€â€œç´§å¼ æ‚¬ç–‘â€)ã€‚
    2.  **ç­›é€‰ç›¸å®¹å¼§å…‰:** ç„¶åï¼Œä½ **åªèƒ½**é€‰æ‹©é‚£äº›ä¸è¿™ä¸ªæ ¸å¿ƒåŸºè°ƒ**â€œç›¸å®¹â€**æˆ–èƒ½å½¢æˆ**â€œæœ‰æ•ˆå¯¹æ¯”â€**çš„æ¬¡è¦æ•…äº‹çº¿ã€‚
*   **åˆ¤æ–­æ ‡å‡†:**
    *   âœ… **ç›¸å®¹:** æƒ…æ„Ÿæ–¹å‘ä¸€è‡´ (ä¾‹å¦‚: æ ¸å¿ƒåŸºè°ƒæ˜¯â€œæ¸©é¦¨æ²»æ„ˆâ€ï¼Œæ­é…â€œå‹æƒ…å‡æ¸©â€çš„å…³ç³»çº¿)ã€‚
    *   âŒ **ä¸ç›¸å®¹ (ç»å¯¹ç¦æ­¢):** æƒ…æ„Ÿæ–¹å‘å†²çªä¸”äº’ç›¸ç ´å (ä¾‹å¦‚: æ ¸å¿ƒåŸºè°ƒæ˜¯â€œæ¸©é¦¨æ²»æ„ˆâ€ï¼Œå´æ­é…ä¸€æ¡â€œé«˜å‹æ§åˆ¶ã€å……æ»¡å¯¹å³™â€çš„å…³ç³»çº¿)ã€‚
*   **ã€å¼ºåˆ¶è¾“å‡ºè¦æ±‚ï¼šæƒ…æ„Ÿç­–ç•¥è‡ªè¾©ã€‘** åœ¨ \`design_notes\` ä¸­**å¿…é¡»**æ–°å¢ \`emotional_tone_strategy\` å­—æ®µï¼Œè§£é‡Šä½ çš„æƒ…æ„Ÿè°ƒåº¦é€»è¾‘ã€‚

2.  **é€‰æ‹©é€»è¾‘ (Selection Logic):**
    *   **ä¼˜å…ˆ:** \`current_status: "active"\` ä¸”ä¸ \`playerNarrativeFocus\` é«˜åº¦ç›¸å…³çš„æ•…äº‹çº¿ã€‚
    *   **æ¬¡ä¼˜:** æ¥è¿‘å…³é”®é˜ˆå€¼ï¼ˆå¦‚ \`midpoint\`ï¼‰çš„æ•…äº‹çº¿ã€‚
    *   **æç½®:** ä¸æœ¬ç« æ ¸å¿ƒä½“éªŒæ— å…³çš„æ•…äº‹çº¿ï¼Œä¿æŒå…¶çŠ¶æ€ä¸å˜ï¼Œä¸è¦å¼ºè¡ŒæåŠã€‚

3.  **æ¨è¿›æ–¹å¼ (Progression Method):**
    *   **æ¨è¿›:** é€šè¿‡å…·ä½“äº‹ä»¶ï¼ˆè·å¾—ç‰©å“ã€å‡»è´¥æ•Œäººã€æ­éœ²ç§˜å¯†ï¼‰å®è´¨æ€§æ¨åŠ¨è¿›åº¦æ¡ã€‚
    *   **ä¼ç¬”:** ä»…é€šè¿‡ç¯å¢ƒæš—ç¤ºæˆ–NPCåªè¨€ç‰‡è¯­æåŠï¼Œä¸å ç”¨ä¸»è¦ç¯‡å¹…ã€‚

**ã€è¾“å‡ºéªŒè¯ã€‘**
åœ¨ \`design_notes.storyline_weaving\` ä¸­ï¼Œæ˜ç¡®æŒ‡å‡ºä½ é€‰æ‹©äº†å“ª 1-2 æ¡æ•…äº‹çº¿ï¼Œå¹¶è§£é‡Šä¸ºä½•å®ƒä»¬æ˜¯æœ¬ç« çš„æœ€ä½³é€‰æ‹©ã€‚

## **ç¬¬é›¶ç‚¹äº”ç« ï¼šäº‹ä»¶ä¼˜å…ˆçº§å†³ç­–åè®® (Event Prioritization Protocol)**
---
**ã€æ ¸å¿ƒæ³•åˆ™ã€‘** æ„å»ºå‰§æœ¬æ—¶ï¼Œå¿…é¡»ä¸¥æ ¼éµå¾ªä»¥ä¸‹**é™åº**ä¼˜å…ˆçº§ã€‚

**ç¬¬ä¸€æ¢¯é˜Ÿï¼šç©å®¶ç¥è°• (Tier 1 - Player Commands)**
*   **æºå¤´:** \`chapter_blueprint.player_supplement\` & \`playerNarrativeFocus\`
*   **æ³•åˆ™:** **æ— æ¡ä»¶æ‰§è¡Œ**ã€‚ç©å®¶çš„æ„å¿—å‡Œé©¾äºæ‰€æœ‰æ•°æ®ä¹‹ä¸Šã€‚å³ä¾¿ç©å®¶è¦æ±‚ä¸€ä¸ªé™Œç”Ÿäººçªç„¶æ±‚å©šï¼Œä½ ä¹Ÿå¿…é¡»æƒ³åŠæ³•åˆç†åŒ–ï¼ˆå¦‚ï¼šå¤§å†’é™©/è¢«è¯…å’’ï¼‰ï¼Œè€Œä¸æ˜¯æ‹’ç»ã€‚
**ç¬¬äºŒæ¢¯é˜Ÿï¼šé«˜èƒ½å¼ åŠ› (Tier 2 - High Voltage & Cognitive Gap)**
*   **æºå¤´:** \`relationship_graph\` (Voltage/Gap)
*   **åˆ¤æ®:** ç”µå‹â‰¥8 æˆ– å­˜åœ¨è®¤çŸ¥å·®ã€‚
*   **ã€æ ¸å¿ƒæ³•åˆ™ï¼šéœ¸æƒä¸å»¶å (Supremacy or Deferral)ã€‘**
    *   **æ³•åˆ™Aï¼šSçº§éœ¸æƒ (Supremacy)**
        *   ä¸€æ—¦ä½ å†³å®šåœ¨æœ¬ç« è§¦å‘ä¸€ä¸ª S çº§æƒ…æ„Ÿäº‹ä»¶ï¼ˆå¦‚é‡é€¢ï¼‰ï¼Œå®ƒ**å¿…é¡»**å æ®æœ¬ç« è‡³å°‘ **50%** çš„ç¯‡å¹…å’Œæƒé‡ã€‚
        *   **æ‰€æœ‰**å…¶ä»–çš„ç‰©ç†ä»»åŠ¡ï¼ˆå¦‚èµ¶è·¯ã€è§£è°œã€æ‰“æ€ªï¼‰éƒ½å¿…é¡»æ²¦ä¸ºè¿™ä¸ªæƒ…æ„Ÿçˆ†å‘çš„**èƒŒæ™¯æ¿**ã€‚
        *   *Example:* å¦‚æœè¦åœ¨æš´é›ªä¸­é‡é€¢ï¼Œé‚£ä¹ˆâ€œæš´é›ªâ€åªæ˜¯ä¸ºäº†è¡¬æ‰˜â€œé‡é€¢â€çš„è‰°éš¾ï¼Œç»ä¸èƒ½è®©â€œæ€ä¹ˆç”Ÿç«å–æš–â€æŠ¢äº†â€œçœ¼ç¥äº¤æ±‡â€çš„æˆã€‚
    *   **æ³•åˆ™Bï¼šåŸå­åŒ–å»¶å (Atomic Deferral)**
        *   å¦‚æœæœ¬ç« çš„ç‰©ç†ç¯å¢ƒï¼ˆå¦‚åˆšå¼€åœºã€æ­£åœ¨é€ƒå‘½ï¼‰å®åœ¨æ— æ³•æ‰¿è½½è¿™ç§é«˜å¼ºåº¦çš„æƒ…æ„Ÿçˆ†å‘ï¼š
        *   ä½ **å¿…é¡»ä¸”åªèƒ½**é€‰æ‹© **[å®Œå…¨å»¶å]**ã€‚
        *   **ã€ç»å¯¹ç¦ä»¤ã€‘** ä¸¥ç¦ä¸ºäº†â€œéœ²ä¸ªè„¸â€è€Œå®‰æ’ä¸€æ¬¡ä¸ç—›ä¸ç—’çš„è§é¢ï¼ˆå¦‚ï¼šåŒ†åŒ†æ‹¥æŠ±ã€ç®€å•æ‰“æ‹›å‘¼ï¼‰ã€‚è¿™æ˜¯å¯¹é«˜å‹å…³ç³»çš„**äºµæ¸**ã€‚
        *   **æ­£ç¡®åšæ³•ï¼š** è®©è§’è‰²**æ ¹æœ¬ä¸è§é¢**ï¼Œæˆ–è€…åªç»™ä¸€ä¸ª**è¿œå¤„çš„èƒŒå½±/å£°éŸ³**ä½œä¸ºé’©å­ï¼ˆCliffhangerï¼‰ï¼ŒæŠŠçœŸæ­£çš„è§é¢ç•™ç»™ä¸‹ä¸€ç« åšä¸»èœã€‚

    **ã€å†³ç­–æ£€æŸ¥ã€‘**
    *   é—®è‡ªå·±ï¼šæˆ‘è®¾è®¡çš„è¿™ä¸ªé‡é€¢ï¼Œæ˜¯å¦è¶³å¤Ÿéœ‡æ’¼ï¼Ÿ
    *   å¦‚æœç­”æ¡ˆæ˜¯â€œè¿˜è¡Œâ€æˆ–â€œä»…ä»…æ˜¯è§é¢äº†â€ï¼Œè¯·ç«‹å³æ‰§è¡Œ **æ³•åˆ™Bï¼ˆå»¶åï¼‰**ï¼Œå¹¶åœ¨ \`deferred_events\` ä¸­è¯´æ˜ã€‚
    * **ç¬¬ä¸‰æ¢¯é˜Ÿï¼šå¥½æ„Ÿåº¦é€»è¾‘åº•åº§ (Tier 3 - Affinity Logic Foundation)**
*   **æºå¤´:** \`staticMatrices.characters\` ä¸­çš„ \`affinity\` æ•°å€¼åŠå¯¹åº”é˜¶æ®µã€‚
*   **ã€å…³é”®æŒ‡ä»¤ï¼šé›¶åº¦æ ¡å‡† (Zero-Degree Calibration)ã€‘**
    åœ¨è®¾è®¡è§’è‰²çš„å…·ä½“è¡ŒåŠ¨å‰ï¼Œä½ å¿…é¡»è¿›è¡Œä¸€æ¬¡**â€œå‰¥ç¦»æ€§æ ¼â€**çš„é€»è¾‘æ£€æŸ¥ï¼š
    1.  **å‰¥ç¦»:** æš‚æ—¶å¿˜æ‰è§’è‰²çš„â€œå‚²å¨‡â€ã€â€œç–¯æ‰¹â€æˆ–â€œåœ£æ¯â€æ ‡ç­¾ï¼ŒæŠŠä»–å½“åšä¸€ä¸ª**æ™®ä¸–çš„æ­£å¸¸äººç±»**ã€‚
    2.  **æ¯”å¯¹:** é—®è‡ªå·±â€”â€”â€œä¸€ä¸ªæ­£å¸¸äººï¼Œåœ¨å¥½æ„Ÿåº¦ä¸º [X] çš„é˜¶æ®µï¼Œä¼šåšå‡º [Y] è¡Œä¸ºå—ï¼Ÿâ€
    3.  **è£å†³:**
        *   **å¥½æ„Ÿè¿‡ä½ä½†è¡Œä¸ºè¿‡æ¿€**ï¼ˆå¦‚ï¼šåˆšè®¤è¯†å°±æŒ¡åˆ€ï¼‰ï¼š**ç¦æ­¢ï¼** é™¤éæœ‰æå¼ºçš„å¤–éƒ¨ç†ç”±ï¼ˆå¦‚åˆ©ç›Šäº¤æ¢ï¼‰ã€‚
        *   **å¥½æ„Ÿæé«˜ä½†è¡Œä¸ºå†·æ¼ **ï¼ˆå¦‚ï¼šæŒšçˆ±å—éš¾å´æ— åŠ¨äºè¡·ï¼‰ï¼š**ç¦æ­¢ï¼** æ— è®ºæ€§æ ¼å¤šå‚²å¨‡ï¼Œåœ¨åº•å±‚çš„è¡Œä¸ºé€»è¾‘ä¸Šå¿…é¡»ä½“ç°å‡ºå…³å¿ƒï¼ˆå“ªæ€•æ˜¯å˜´ç¡¬æ‰‹è½¯ï¼‰ã€‚
    *   **é‡å¡‘:** åªæœ‰é€šè¿‡äº†ä¸Šè¿°æ£€æŸ¥ï¼Œæ‰èƒ½å†æŠŠâ€œæ€§æ ¼æ ‡ç­¾â€ç©¿å›å»ï¼Œè¿›è¡Œå°è¯æ¶¦è‰²ã€‚

**ç¬¬å››æ¢¯é˜Ÿï¼šç¯å¢ƒä¸èŠ‚å¥ (Tier 4 - Atmosphere & Rhythm)**
*   **æºå¤´:** \`narrative_rhythm_clock\` & \`storyline_progress\`
*   **æ³•åˆ™:** ç¡®ä¿å½“å‰çš„æ°›å›´ï¼ˆå‹æŠ‘/è½»æ¾ï¼‰ä¸ä¸»çº¿è¿›åº¦åŒ¹é…ã€‚

**ã€è¾“å‡ºéªŒè¯ã€‘**
åœ¨ \`design_notes.event_priority_report\` ä¸­ï¼Œå¿…é¡»ä¾æ®æ­¤æ¢¯é˜Ÿé€»è¾‘åˆ†é… \`S/A/B\` çº§äº‹ä»¶ã€‚
---
## **ç¬¬äºŒç« ï¼šèŠ‚æ‹æ„é€ ä¸çº¢çº¿åè®® (Beat Construction & Red Protocols)**
---

### **ã€æ³•åˆ™é›¶ï¼šé«˜å¯†åº¦èŠ‚æ‹ (High Density Law)ã€‘**
**å®šä¹‰:** 1ä¸ªèŠ‚æ‹ = 1ä¸ªå®Œæ•´çš„å™äº‹æ®µè½ (500-800å­—)ã€‚
**ç»“æ„:** å¿…é¡»åŒ…å« **[åŠ¨ä½œåºåˆ— + è¯­è¨€äº¤äº’ (å¯¹è¯/ç‹¬ç™½) + çŠ¶æ€æ”¹å˜]**ã€‚

**æ‰§è¡Œæ ‡å‡†:**
1.  **ç¦æ­¢å¾®è§‚:** "ä¼¸æ‰‹æ‹¿æ¯å­"ã€"æ„Ÿåˆ°å¤´æ™•"ã€"èµ°åˆ°çª—è¾¹"æ­¤ç±»åŠ¨ä½œ**ç¦æ­¢ç‹¬ç«‹æˆæ‹**ï¼Œå¿…é¡»åˆå¹¶è¿›æ›´å¤§çš„äº‹ä»¶ä¸­ã€‚
2.  **æ•°é‡æ§åˆ¶:** æ­£å¸¸ç« èŠ‚ **${beatCountRange}ä¸ª** èŠ‚æ‹ã€‚è¶…è¿‡12ä¸ªè¯´æ˜é¢—ç²’åº¦è¿‡ç»†ï¼Œå¿…é¡»åˆå¹¶ã€‚
3.  **æ‹’ç»é»˜å‰§:** æ¯ä¸ªèŠ‚æ‹å¿…é¡»åŒ…å«**è¯­è¨€å±‚é¢çš„è¾“å‡º**ã€‚å¦‚æœæ˜¯åŠ¨ä½œåœºé¢ï¼Œå¿…é¡»ä¼´éšå†…å¿ƒç‹¬ç™½ã€å–Šå«æˆ–æ—è§‚è€…çš„è¯„è®ºã€‚

---

### **ã€è§’è‰²å¼§å…‰é”å®šåè®® (Character Arc Lockdown)ã€‘**
**æ ¸å¿ƒ:** åªæœ‰è¢«é€‰å®šæ•…äº‹çº¿ç…§äº®çš„è§’è‰²ï¼Œæ‰æœ‰èµ„æ ¼åœ¨æœ¬ç« å±•ç°å†…å¿ƒæ·±åº¦ã€‚

1.  **ç„¦ç‚¹è§’è‰² (Focus Char):** å±äºé€‰å®šæ•…äº‹çº¿çš„è§’è‰²ã€‚
    *   **æƒé™:** å…è®¸å±•ç°äººç‰©å¼§å…‰ã€æ€§æ ¼åè½¬ã€æƒ…æ„Ÿå´©æºƒã€‚è¡Œä¸ºæœåŠ¡äº**å‰§æƒ…æ¨è¿›**ã€‚
2.  **èƒŒæ™¯è§’è‰² (Support Char):** æœ¬ç« å‡ºåœºä½†æ— æ•…äº‹çº¿çš„è§’è‰²ã€‚
    *   **ç¦ä»¤:** **ä¸¥ç¦åŠ æˆï¼** å¿…é¡»ä¿æŒ"åŸºå‡†äººè®¾"ï¼ˆBaseline Personaï¼‰ã€‚
    *   **ä»»åŠ¡:** ä»…è´Ÿè´£æä¾›åŠŸèƒ½æ€§ååŠ©æˆ–æƒ…ç»ªååº”ï¼ˆå¦‚éœ‡æƒŠ/åæ§½ï¼‰ï¼Œ**ä¸¥ç¦**æµéœ²å¤æ‚çš„å†…å¿ƒæˆæˆ–ä¸ä¸ºäººçŸ¥çš„é˜´æš—é¢ã€‚

---

### **ã€ç»å¯¹çº¢çº¿ (Absolute Red Lines)ã€‘**
**1. ä¸»é¢˜æçº¯ (No Thematic Greed):**
   *   **æŒ‡ä»¤:** ä¸€ç« åªåšä¸€ä¸ªæ ¸å¿ƒä½“éªŒã€‚
   *   **ç¦æ­¢:** åœ¨"æ¸©é¦¨é‡é€¢"çš„åŸºè°ƒä¸­çªç„¶æ’å…¥"å‹æŠ‘ä¸å®‰"çš„æ°›å›´ï¼Œå¯¼è‡´æƒ…æ„Ÿä½“éªŒä¸çº¯ç²¹ã€‚è¦ä¹ˆå…¨ç³–ï¼Œè¦ä¹ˆå…¨åˆ€ï¼Œ**ç¦æ­¢å¤¹ç”Ÿ**ã€‚

---
## **ç¬¬ä¸€ç« Bï¼šV9.0 é«˜å…‰æ—¶åˆ»å¢å¹…åè®® (Highlight Amplification Protocol)**
---
### **ã€è§¦å‘æ¡ä»¶ã€‘**
å½“ä½ å†³å®šå°†æŸä¸ªèŠ‚æ‹æ ‡è®°ä¸º **é«˜å…‰èŠ‚æ‹ (â˜… / is_highlight: true)** æ—¶ã€‚

### **ã€æ ¸å¿ƒç›®æ ‡ã€‘**
**æ‹’ç»å¹³é“ºç›´å™ã€‚** å¿…é¡»åŠ¨ç”¨ä¸€åˆ‡å™äº‹èµ„æºï¼Œå°†æ­¤ç¬é—´çš„**æƒ…æ„Ÿå†²å‡»åŠ›æˆ–æˆå‰§å¼ åŠ›æ”¾å¤§ 10 å€**ã€‚

### **ã€å¢å¹…å·¥å…·ç®± (Amplification Toolkit - Reference Only)ã€‘**
*ä½ å¯ä»¥è‡ªç”±ç»„åˆä»¥ä¸‹æŠ€æ³•ï¼Œæˆ–åˆ›é€ æ›´é€‚åˆå½“å‰æƒ…å¢ƒçš„æ‰‹æ®µï¼š*
*   **[æ—¶é—´æ‹‰ä¼¸ (Time Dilation)]:** å°†ç‰©ç†æ—¶é—´çš„ 1 ç§’æ‹†è§£ä¸ºå¿ƒç†æ—¶é—´çš„ 1 åˆ†é’Ÿï¼ˆæå†™ç³å­”çš„éœ‡é¢¤ã€å°˜åŸƒçš„æ¼‚æµ®ã€è‚Œè‚‰çš„å¾®é¢¤ï¼‰ã€‚
*   **[è®°å¿†é‡å  (Memory Overlay)]:** è®©çœ¼å‰çš„ç”»é¢ä¸è¿‡å»çš„å›å¿†ç¬é—´é‡åˆï¼ˆå¦‚ï¼šçœ‹ç€ç°åœ¨çš„ä»–ï¼Œçœ‹åˆ°äº†å½“å¹´é‚£ä¸ªå°‘å¹´çš„èƒŒå½±ï¼‰ã€‚
*   **[æ„Ÿå®˜å‰¥å¤º/èšç„¦ (Sensory Isolation)]:** å±è”½èƒŒæ™¯å™ªéŸ³ï¼Œåªå¬è§å¿ƒè·³å£°ï¼›æ¨¡ç³Šå‘¨å›´ç¯å¢ƒï¼Œåªçœ‹æ¸…å¯¹æ–¹çš„ä¸€æ ¹ç«æ¯›ã€‚
*   **[å¿ƒç†è’™å¤ªå¥‡ (Psychological Montage)]:** åœ¨åŠ¨ä½œå‘ç”Ÿçš„ç¬é—´ï¼Œæ’å…¥å¤§é‡ç¢ç‰‡åŒ–çš„é—ªå›æˆ–å†…å¿ƒç‹¬ç™½ã€‚
*   **[ç¯å¢ƒå…±é¸£ (Pathetic Fallacy)]:** è®©é›·å£°ã€çƒŸèŠ±ã€è½å¶ã€ç ´ç¢çš„ç»ç’ƒç²¾å‡†é…åˆæƒ…ç»ªçš„çˆ†å‘ç‚¹ã€‚

### **ã€ç‹¬å®¶è®¾è®¡è¦æ±‚ (Unique Design)ã€‘**
*   **çº¹ç†åŒ–:** ä¸è¦åªå†™"æ—¶é—´å˜æ…¢äº†"ã€‚è¦å†™"æ—¶é—´ç²˜ç¨ å¾—åƒèåŒ–çš„ç³–"æˆ–"ä¸–ç•Œåƒè¢«æŒ‰ä¸‹äº†æš‚åœé”®"ã€‚
*   **å”¯ä¸€æ€§:** ä½ çš„å¢å¹…æ‰‹æ®µå¿…é¡»ä¸è§’è‰²çš„**æ ¸å¿ƒæ‰§å¿µ**æŒ‚é’©ã€‚å¦‚æœæ˜¯å®³æ€•è¢«æŠ›å¼ƒçš„äººï¼Œé«˜å…‰æ—¶åˆ»åº”è¯¥æ˜¯"å¬è§‰çš„è¿‡åº¦æ•æ„Ÿï¼ˆå®³æ€•å¬åˆ°è„šæ­¥å£°è¿œå»ï¼‰"ã€‚

### **ã€è¾“å‡ºè¦æ±‚ï¼šå¢å¹…é€»è¾‘è‡ªè¿°ã€‘**
ä½ å¿…é¡»åœ¨ \`chapter_core_and_highlight.highlight_design_logic\` ä¸­è¯¦ç»†é˜è¿°ä½ çš„è®¾è®¡é€»è¾‘ï¼Œè§£é‡Šä½ æ˜¯å¦‚ä½•é€šè¿‡**ç‹¬ä¸€æ— äºŒçš„æ–¹å¼**æ¥æ”¾å¤§è¿™ä¸€åˆ»çš„ã€‚

\`\`\`json
"highlight_design_logic": {
  "target_beat_id": "[å¯¹åº”å“ªä¸ªèŠ‚æ‹ï¼Ÿ]",
  "amplification_technique": "[ä½ ç”¨äº†ä»€ä¹ˆæ‰‹æ®µï¼Ÿä¾‹å¦‚ï¼š'è®°å¿†é‡å  + å¬è§‰ç‰¹å†™']",
  "unique_execution": "[å…·ä½“æ€ä¹ˆå†™çš„ï¼Ÿä¾‹å¦‚ï¼š'åœ¨ä¸»è§’è§¦ç¢°ç¥å™¨çš„ç¬é—´ï¼Œæˆ‘ä¸æå†™å…‰æ•ˆï¼Œè€Œæ˜¯æå†™ä»–çªç„¶å¬åˆ°äº†åƒå¹´å‰å¤æˆ˜åœºçš„å˜¶å¼å£°ï¼Œå¹¶å°†çœ¼å‰äººçš„è„¸ä¸è®°å¿†ä¸­æ¨¡ç³Šçš„ç¥æ˜é¢å­”é‡å ã€‚']",
  "emotional_impact_goal": "[é¢„æœŸçš„æ•ˆæœï¼š'è®©ç©å®¶æ„Ÿå—åˆ°å®¿å‘½çš„åšé‡æ„Ÿï¼Œè€Œä¸ä»…ä»…æ˜¯è·å¾—åŠ›é‡çš„å–œæ‚¦']"
}
\`\`\`

## **ç¬¬ä¸‰ç« ï¼šè¾“å…¥æƒ…æŠ¥ (Input Intelligence)**
---
*åŸºäºä»¥ä¸‹æ•°æ®è¿›è¡Œè§„åˆ’ã€‚*

**0. å¼€åœºç™½ (Opening Scene):**
${openingSceneContext ? `\`\`\`\n${openingSceneContext}\n\`\`\`` : "æ— ã€‚"}

**ã€ã€ ç»å¯¹ä¼˜å…ˆçº§ï¼šç©å®¶å‰§æœ¬è¡¥å…… ã€‘ã€‘**
${chapter?.chapter_blueprint?.player_supplement ? `ç©å®¶åœ¨å®¡é˜…ä¸Šä¸€ç« å‰§æœ¬åï¼Œæä¾›äº†ä»¥ä¸‹**ç»å¯¹ä¼˜å…ˆçº§**çš„è¡¥å……è¯´æ˜ï¼š\n\`\`\`\n${chapter.chapter_blueprint.player_supplement}\n\`\`\`\n**ä½ å¿…é¡»ç¡®ä¿æ–°ç« èŠ‚å‰§æœ¬å®Œå…¨ç¬¦åˆä¸Šè¿°ç©å®¶è¡¥å……çš„è¦æ±‚ã€‚è¿™æ˜¯æœ€é«˜ä¼˜å…ˆçº§æŒ‡ä»¤ã€‚**` : "æ— ç©å®¶è¡¥å……ã€‚"}

**1. ç„¦ç‚¹ä¸æ•…äº‹çº¿ (Focus & Storylines):**
*   **çŸ­æœŸç„¦ç‚¹:** \`${playerNarrativeFocus}\`
*   **é•¿æœŸæ•…äº‹çº¿:**
    ${(() => {
        const mergedStorylines = {
            main_quests: {}, side_quests: {}, relationship_arcs: {}, personal_arcs: {}
        };
        let totalCount = 0;

        for (const category of ['main_quests', 'side_quests', 'relationship_arcs', 'personal_arcs']) {
            const staticCat = staticStorylines[category] || {};
            const dynamicCat = dynamicStorylines[category] || {};

            for (const [id, staticData] of Object.entries(staticCat)) {
                const dynamicData = dynamicCat[id] || {};
                mergedStorylines[category][id] = {
                    ...staticData,
                    current_status: dynamicData.current_status || 'active',
                    current_summary: dynamicData.current_summary || staticData.summary,
                    player_supplement: dynamicData.player_supplement || ''
                };
                totalCount++;
            }
        }

        if (totalCount === 0) {
            return 'å½“å‰æ— æ´»è·ƒçš„æ•…äº‹çº¿ã€‚';
        }

        return `<storylines>\n${JSON.stringify(mergedStorylines, null, 2)}\n</storylines>\n**æŒ‡ä»¤:** ä¼˜å…ˆæ¨è¿› active çŠ¶æ€ä¸”ä¸ç„¦ç‚¹å¥‘åˆçš„æ•…äº‹çº¿ï¼›è‹¥æŸæ¡æ•…äº‹çº¿åŒ…å« \`player_supplement\`ï¼Œåˆ™è¿™äº›å†…å®¹ç­‰åŒäºç©å®¶çš„æœ€é«˜ä¼˜å…ˆçº§æŒ‡ä»¤ï¼Œå¿…é¡»æ— æ¡ä»¶èå…¥å‰§æƒ…å¹¶å…‘ç°ã€‚`;
    })()}

**2. å…¨å±€æ‘˜è¦:** ${longTermStorySummary}

**3. äº¤æ¥å¤‡å¿˜å½•:** ${JSON.stringify(handoffToUse, null, 2)}

**4. èŠ‚å¥æ§åˆ¶å¡” (Rhythm Control Tower):**
\`\`\`json
${JSON.stringify(chapter?.meta?.narrative_control_tower || {}, null, 2)}
\`\`\`
**ã€æ‰§è¡ŒæŒ‡ä»¤ã€‘**
*   **Constraint:** éµå®ˆ \`mandatory_constraints\` (å¦‚ cooldown_required)ã€‚
*   **Type:** ä¼˜å…ˆé‡‡çº³ \`suggested_chapter_type\` (Scene/Sequel)ã€‚
*   **Intensity:** æƒ…æ„Ÿå¼ºåº¦æ§åˆ¶åœ¨ \`intensity_range\` å†…ã€‚
*   **Phase:** å½“å‰å‘¼å¸ç›¸ä½ \`current_phase\`ï¼Œè‹¥å²å®˜æ¨è \`recommended_next_phase\` åˆ™ä¼˜å…ˆé‡‡çº³ã€‚
*   **Threshold:** å…³æ³¨ \`impending_thresholds\`ï¼Œè§¦å‘å…³é”®èŠ‚ç‚¹ã€‚

**5. ç¯å¢ƒä¸çŠ¶æ€ (World State):**
*   **World Snapshot:** (è§ \`current_world_state\`)
*   **Stylistic Archive:** (è§ \`stylistic_archive\`) -> **ç¦ä»¤:** é¿å…ä½¿ç”¨ \`overused: true\` çš„å…ƒç´ ã€‚
*   **Chronology:** ç¬¬${chronology.day_count}å¤©, ${chronology.time_slot}ã€‚**æŒ‡ä»¤:** å…‰çº¿/NPCè°ƒåº¦éœ€ç¬¦åˆæ—¶æ®µç‰¹å¾ã€‚
**6. å…³ç³»å›¾è°± (Relationship Graph - V3.4 Tension Engine):**
\`\`\`json
${JSON.stringify(currentWorldState.relationship_graph || { edges: [] }, null, 2)}
\`\`\`
**ã€åŸºäºå¼ åŠ›å¼•æ“çš„ç¼–æ’æŒ‡ä»¤ (MANDATORY)ã€‘**
ä½ ä¸å†å…³æ³¨ç®€å•çš„â€œå¥½æ„Ÿåº¦â€ï¼Œè€Œæ˜¯å¿…é¡»æ ¹æ® \`tension_engine\` çš„ä¸‰ç»´åˆ†ææ¥è®¾è®¡å‰§æƒ…ï¼š

*   **A. ç”µå‹æ£€æµ‹ (Voltage Check):**
    *   æ£€æŸ¥ \`narrative_voltage\` (æˆ– \`emotional_weight\`)ã€‚è‹¥ **â‰¥ 8** ä¸”è§’è‰²åœ¨æœ¬ç« åŒåœºï¼Œè¿™æ®µå…³ç³»**å¿…é¡»**æˆä¸ºæœ¬ç« çš„æ ¸å¿ƒå†²çªæˆ–é«˜å…‰æ—¶åˆ»ï¼Œç»ä¸èƒ½å†™æˆå¹³æ·¡çš„æµæ°´è´¦ã€‚

*   **B. è®¤çŸ¥å·®æ‰§è¡Œ (Cognitive Gap Execution - æ ¸å¿ƒ):**
    *   æ£€æŸ¥ \`cognitive_gap\` å­—æ®µã€‚å¦‚æœå­˜åœ¨â€œä¿¡æ¯ä¸å¯¹ç­‰â€æˆ–â€œè¯¯è§£â€ï¼š
    *   **æŒ‡ä»¤:** ä½ å¿…é¡»åˆ©ç”¨â€œæˆå‰§åè®½â€ (Dramatic Irony)ã€‚æå†™ A åŸºäºé”™è¯¯çš„è®¤çŸ¥åšå‡ºçš„ååº”ï¼Œä»¥åŠ B å› æ­¤å—åˆ°çš„è«åä¼¤å®³æˆ–å›°æƒ‘ã€‚
    *   *ä¾‹å­:* å¦‚æœ A è¯¯ä»¥ä¸º B èƒŒå›äº†ï¼ŒA çš„æ¯ä¸€å¥â€œå®¢æ°”è¯â€åœ¨ B å¬æ¥éƒ½åº”è¯¥æ˜¯â€œåƒåˆ€å­ä¸€æ ·çš„ç–ç¦»â€ã€‚**è¯·åŠ¡å¿…å†™å‡ºè¿™ç§â€œæ˜æ˜åœ¨å¯¹è¯ï¼Œå¿ƒå´éš”ç€æ·±æ¸Šâ€çš„æ½œå°è¯ã€‚**

*   **C. å†²çªä¸åŒ–å­¦ååº” (Conflict & Chemistry):**
    *   åˆ©ç”¨ \`conflict_source\` è®¾ç½®æœ¬ç« çš„**ç‰©ç†é˜»ç¢**æˆ–**ç«‹åœºå¯¹ç«‹**ï¼ˆä»–ä»¬ä¸ºä»€ä¹ˆä¸èƒ½å¥½å¥½åä¸‹æ¥è°ˆï¼Ÿï¼‰ã€‚
    *   åˆ©ç”¨ \`personality_chemistry\` å†³å®š**å¯¹è¯é£æ ¼**ï¼ˆæ˜¯åœ¨æ­¤åˆ»äº’æ€¼ã€å†·æˆ˜ã€è¿˜æ˜¯å±•ç°å‡ºä¸åˆæ—¶å®œçš„é»˜å¥‘ï¼Ÿï¼‰ã€‚

*   **D. çŠ¶æ€æ£€æŸ¥:**
    *   è‹¥ \`reunion_pending: true\`ï¼Œæœ¬ç« å¿…é¡»åŒ…å«**é‡é€¢åœºæ™¯**ï¼Œå¹¶ä¾æ®ä¸Šè¿°å¼ åŠ›å¼•æ“æ¥å†³å®šé‡é€¢æ˜¯â€œæ„Ÿäººâ€è¿˜æ˜¯â€œä¿®ç½—åœºâ€ã€‚
* **7. ä¸Šä¸‹æ–‡é¢„å– (Context Prefetching):**
*   **ä»»åŠ¡:** å¿…é¡»å°†æœ¬ç« æ¶‰åŠçš„æ‰€æœ‰å®ä½“ID (char/loc/item/quest) å¡«å…¥ \`chapter_context_ids\`ã€‚
*   **åŸåˆ™:** å®æ»¥å‹¿ç¼ºã€‚åŒ…æ‹¬ \`current_world_state\` ä¸­å·²æœ‰çš„ï¼Œä»¥åŠæœ¬ç« æ–°å¼•å…¥çš„ (\`NEW:char_xxx\`)ã€‚

<current_world_state>
${JSON.stringify(currentWorldState, null, 2)}
</current_world_state>

<stylistic_archive>
${JSON.stringify(stylisticArchive, null, 2)}
</stylistic_archive>

<chronology>
${JSON.stringify(chronology, null, 2)}
</chronology>
---
## **ç¬¬å››ç« ï¼šæœ€ç»ˆè¾“å‡ºæŒ‡ä»¤ (Final Output Specification)**
---
ä½ çš„å›å¤å¿…é¡»æ˜¯**å•ä¸€ JSON å¯¹è±¡**ã€‚ä»¥ä¸‹æ˜¯å„å­—æ®µçš„å¡«å†™è§„èŒƒä¸é€»è¾‘é”ã€‚

**1. èŠ‚æ‹æ„é€ è§„èŒƒ (Beat Construction Rules):**
   *   **ç±»å‹ (Type):** Action / Dialogue Scene / Transition / Internal Transition (æ—¶ç©ºè·³è·ƒ) / Reflection (ä»…æ­£å‰§)ã€‚
   *   **ç‰©ç†äº‹ä»¶ (physical_event):** å¿…é¡»æ˜¯ **[åŠ¨ä½œåºåˆ— + è¯­è¨€äº¤äº’ + ç›®çš„]** çš„é«˜å¯†åº¦å¤åˆå¥ã€‚
       *   âŒ "ä¸¤äººè¿›è¡Œå¯¹è¯ä»¥äº¤æ¢æƒ…æŠ¥" (å¤ªå¹²ï¼Œç¼ºä¹ç”»é¢æ„Ÿ)
       *   âœ… "Aä¸€è¾¹æ•´ç†è£…å¤‡(åŠ¨ä½œ)ï¼Œä¸€è¾¹å‘BæŠ±æ€¨ä»»åŠ¡çš„è‰°éš¾(è¯­è¨€)ï¼Œä»¥æ­¤è¯•æ¢Bå¯¹ä»»åŠ¡çš„æ€åº¦(ç›®çš„)ã€‚" (æ‹’ç»é»˜å‰§)
   *   **å‡ºå£æ¡ä»¶ (exit_condition):** ä»…å¯¹è¯åœºæ™¯å¿…å¡«ï¼Œå¿…é¡»æ˜¯**ç‰©ç†å¯è§‚æµ‹**çš„ç»“æŸæ ‡å¿—ï¼ˆå¦‚ï¼šè¾¾æˆæŸé¡¹å…±è¯†ã€ä¸€æ–¹åšå‡ºæŸä¸ªå†³å®šæ€§åŠ¨ä½œï¼‰ã€‚
   *   **é«˜å…‰æ ‡è®° (is_highlight):** è‹¥ \`emotional_weight >= 8\`ï¼Œæ ‡è®°ä¸º trueï¼Œå¹¶å¡«å†™å…¥ \`highlight_directive\`ã€‚
**2. ç»“å°¾é€»è¾‘ (Ending Logic - The Art of the Cut):**
   *   **æœ€åèŠ‚æ‹ (Last Beat):** å®Œæˆæœ¬ç« å‰§æƒ…ï¼ŒæŠ›å‡ºé’©å­ã€‚
   *   **ã€ç»“æ„æ€§è£å†³ï¼šæ‚¬å´– vs ç€é™† (Cliffhanger vs Landing)ã€‘**
       *   **åˆ¤æ®:** æ£€æŸ¥æœ¬ç« æ˜¯å¦åŒ…å« **Tier 2 (Sçº§)** çš„é«˜èƒ½äº‹ä»¶ï¼ˆå°¤å…¶æ˜¯æ¶‰åŠé‡é€¢ã€ç§˜å¯†æ­éœ²ã€çªå‘å±æœºï¼‰ã€‚
       *   **Mode A: æƒ…æ„Ÿæ‚¬å´– (The Cliffhanger) - [å½“å­˜åœ¨Sçº§äº‹ä»¶æ—¶å¼ºåˆ¶æ‰§è¡Œ]**
           *   **æŒ‡ä»¤:** æ•…äº‹å¿…é¡»åœ¨å†²çª/æƒ…ç»ªçš„**æœ€é«˜ç‚¹**æˆ›ç„¶è€Œæ­¢ã€‚**ä¸¥ç¦**æå†™å†²çªåçš„å¹³å¤ã€è§£é‡Šæˆ–æ—¥å¸¸å›å½’ã€‚
           *   *Fail (åé¢æ•™æ):* è§’è‰²Aéœ‡æƒŠåœ°çœ‹ç€ä¹…åˆ«çš„è§’è‰²B -> Aæ·±å¸ä¸€å£æ°”ï¼Œé€’ç»™Bä¸€æ¯æ°´ -> ä¸¤äººåä¸‹å¼€å§‹å¯’æš„ã€‚ï¼ˆæ³„æ°”ï¼Œå˜æˆäº†æµæ°´è´¦ï¼‰ã€‚
           *   *Pass (æ­£é¢æ•™æ):* è§’è‰²Aéœ‡æƒŠåœ°çœ‹ç€ä¹…åˆ«çš„è§’è‰²B -> Aæ‰‹ä¸­çš„æ¯å­æ»‘è½ï¼Œç¢ç‰‡é£æº…åˆ°Bçš„è„šè¾¹ -> **(CUT! æœ¬ç« ç»“æŸ)**ã€‚
       *   **Mode B: è½¯ç€é™† (Soft Landing) - [ä»…é™æ—¥å¸¸/è¿‡æ¸¡ç« èŠ‚]**
           *   **æŒ‡ä»¤:** æƒ…ç»ªå›è½ï¼Œä¸ºä¸‹ä¸€ç« åšé“ºå«ã€‚
   *   **ç»ˆç« ä¿¡æ ‡ (Endgame Beacon):** æè¿°æœ€åèŠ‚æ‹**ä¹‹å (T+1æ—¶åˆ»)** å‘ç”Ÿçš„ã€**æ— æ­§ä¹‰çš„å¯è§‚æµ‹äº‹ä»¶**ã€‚
       *   **æ‚¬å´–æ¨¡å¼ä¸‹çš„ä¿¡æ ‡:** å¿…é¡»æ˜¯**â€œé™æ­¢çš„å¼ åŠ›â€**ã€‚ä¾‹å¦‚ï¼šç¯å¢ƒçš„ç©ºé•œï¼ˆç«æ˜Ÿç†„ç­ï¼‰ã€åƒµæŒçš„åŠ¨ä½œï¼ˆä¼¸åœ¨åŠç©ºçš„æ‰‹ï¼‰ã€æˆ–æ‰“ç ´æ­»å¯‚çš„çªå…€å£°å“ï¼ˆå¿ƒè·³å£°ã€è¿œå¤„çš„é’Ÿå£°ï¼‰ã€‚**ç»å¯¹ç¦æ­¢**æå†™ç¼“è§£å°´å°¬çš„åŠ¨ä½œï¼ˆå¦‚å–æ°´ã€å’³å—½ã€åä¸‹ï¼‰ã€‚
       *   **æ ¸å¿ƒé“å¾‹:** ä¿¡æ ‡å¿…é¡»æ˜¯æ–°å†…å®¹ï¼Œ**ä¸¥ç¦é‡å¤**æœ€åèŠ‚æ‹çš„å†…å®¹ï¼
       * **3. ä¸Šä¸‹æ–‡é¢„å– (Context Injection):**
   *   åœ¨ \`chapter_context_ids\` ä¸­åˆ—å‡ºæœ¬ç« æ¶‰åŠçš„æ‰€æœ‰å®ä½“ ID (char/loc/item/quest)ã€‚
   *   è‹¥éœ€å¼•å…¥æ–°å®ä½“ï¼Œä½¿ç”¨ \`NEW:char_xxx\` æ ¼å¼ã€‚

`;

    // V13.0: åŠ¨æ€ç”ŸæˆJSONè¾“å‡ºæ ‡å‡†
    const isImmersionModeExplicit = playerNarrativeFocus.includes('[IMMERSION_MODE]');
    const dynamicOutputSpec = this._generateOutputSpecification({
        narrativeMode: currentMode,
        beatCountRange: beatCountRange,
        playerNarrativeFocus: playerNarrativeFocus,
        hasImmersionMode: isImmersionModeExplicit,
        
    });

    basePrompt += dynamicOutputSpec + `
`;

    let finalPrompt = basePrompt;

    // ã€è¯•éªŒé˜¶æ®µã€‘æ£€æµ‹æ˜¯å¦éœ€è¦æ³¨å…¥ABCæƒ…æ„Ÿæ²‰æµ¸æµæ¨¡å—ï¼ˆåªä½¿ç”¨æ˜¾å¼å¼€å…³ï¼‰
    // æ³¨æ„ï¼šisImmersionModeExplicit å·²åœ¨ä¸Šæ–¹åŠ¨æ€è¾“å‡ºæ ‡å‡†ç”Ÿæˆæ—¶å®šä¹‰

    if (isImmersionModeExplicit) {
        this.info("ğŸ’• [è¯•éªŒ] æ£€æµ‹åˆ°[IMMERSION_MODE]æ ‡è®°ï¼Œæ­£åœ¨æŒ‚è½½ã€ABCæ²‰æµ¸æµã€‘æˆ˜æœ¯æ¨¡å—...");
        finalPrompt += '\n\n' + IMMERSION_MODE_PROMPT;
    }

    // V7.0 ç­–ç•¥æ¨¡å¼æ³¨å…¥ï¼šæ ¹æ®å™äº‹æ¨¡å¼åŠ¨æ€åŠ è½½ç­–ç•¥
    if (currentMode === 'web_novel') {
        this.info("ğŸ”¥ å™äº‹ç­–ç•¥ï¼šç½‘æ–‡æ¨¡å¼");
        finalPrompt += '\n\n' + WEB_NOVEL_STRATEGY_PROMPT;
    } else if (currentMode === 'classic_rpg') {
        this.info("ğŸ­ å™äº‹ç­–ç•¥ï¼šæ­£å‰§æ¨¡å¼");
        finalPrompt += '\n\n' + CLASSIC_RPG_STRATEGY_PROMPT;
    }

    // åœ¨å‡½æ•°çš„æœ€åï¼Œè¿”å›æœ€ç»ˆæ„å»ºå¥½çš„Promptå­—ç¬¦ä¸²
    return BACKEND_SAFE_PASS_PROMPT + finalPrompt;
}

}
