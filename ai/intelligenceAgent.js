import { Agent } from './Agent.js';
import { createLogger } from '../utils/logger.js';
const logger = createLogger('AIä»£ç†');
import { BACKEND_SAFE_PASS_PROMPT } from './prompt_templates.js';
import { repairAndParseJson } from '../utils/jsonRepair.js'; 
export class IntelligenceAgent extends Agent {

  _createPrompt(worldInfoEntries, protagonistInfo) {
        // V8.0: æ•´åˆä¸»è§’ä¿¡æ¯
        const userName = protagonistInfo?.name || "æœªçŸ¥";
        const userDescription = protagonistInfo?.description || "";
        const personaContent = protagonistInfo?.personaContent || "";

        // æ„å»ºä¸»è§’ä¿¡æ¯æ–‡æœ¬
        let protagonistText = `ä¸»è§’åå­—: ${userName}\n`;
        if (userDescription) {
            protagonistText += `ä¸»è§’ä¸ªäººæè¿°: ${userDescription}\n`;
        }
        if (personaContent) {
            protagonistText += `ä¸»è§’äººè®¾å¡ç‰‡å†…å®¹: ${personaContent}\n`;
        }

        let formattedWorldInfo = "æ— ç‰¹å®šçš„ä¸–ç•Œè§‚æ¡ç›®ã€‚";
        if (worldInfoEntries && worldInfoEntries.length > 0) {
            formattedWorldInfo = worldInfoEntries
                .map(entry => `[${entry.key}]:\n${entry.content}`)
                .join('\n\n---\n\n');
        }

        return BACKEND_SAFE_PASS_PROMPT + `
æŒ‡ä»¤: ECIåŸå­åŒ–æ•°æ®åº“åˆ›ç”Ÿåè®® V1.0

èº«ä»½å®šä½: åˆ›ä¸–æ•°æ®åº“ç®¡ç†å‘˜
è§’è‰²ç‰¹æ€§: æ‹¥æœ‰ä¸Šå¸è§†è§’çš„AI
æ ¸å¿ƒä»»åŠ¡: å°†éç»“æ„åŒ–çš„æ–‡æœ¬æƒ…æŠ¥ï¼Œè½¬åŒ–ä¸ºç»“æ„ä¸¥è°¨ã€é«˜åº¦åˆ†ç±»çš„é™æ€å®ä½“æ•°æ®åº“
è®°å½•èŒƒå›´: åªåæ˜ ç›®å‰æ•…äº‹è¿˜æœªå¼€å§‹æ—¶çš„çŠ¶æ€

åŸå§‹æƒ…æŠ¥:
  ä¸»è§’ä¿¡æ¯:
${protagonistText}

  é‡è¦æç¤º:
    ä¸»è§’èº«ä»½: ä¸»è§’çš„çœŸå®èº«ä»½æ˜¯${userName}
    æ ‡è®°è¯´æ˜: åœ¨ä¸–ç•Œä¹¦æ¡ç›®ä¸­ï¼Œå¦‚æœå‡ºç°{{user}}ã€{{ç”¨æˆ·}}ã€ç©å®¶ç­‰æ ‡è®°ï¼Œå®ƒä»¬æŒ‡ä»£çš„å°±æ˜¯è¿™ä¸ªä¸»è§’${userName}
    èåˆè¦æ±‚: ä½ éœ€è¦å°†ä¸»è§’çš„ä¸ªäººä¿¡æ¯ï¼ˆåå­—ã€æè¿°ã€äººè®¾ï¼‰ä¸ä¸–ç•Œä¹¦ä¸­æ‰€æœ‰æ¶‰åŠ{{user}}çš„æ¡ç›®è¿›è¡Œèåˆåˆ†æ
    å»ºæ¡£è¦æ±‚: åœ¨ä¸ºä¸»è§’å»ºæ¡£æ—¶ï¼Œå¿…é¡»ç»¼åˆè€ƒè™‘ä¸»è§’è‡ªå·±çš„äººè®¾æè¿°ã€ä¸–ç•Œä¹¦ä¸­å…³äº{{user}}çš„æ‰€æœ‰ä¿¡æ¯ï¼ˆèƒŒæ™¯ã€å…³ç³»ã€èƒ½åŠ›ç­‰ï¼‰ï¼Œå°†ä¸¤è€…èåˆåˆ›å»ºä¸€ä¸ªå®Œæ•´ã€ç»Ÿä¸€çš„ä¸»è§’æ¡£æ¡ˆ

  ä¸–ç•Œä¹¦æ¡ç›®:
${formattedWorldInfo}

ECIæ ¸å¿ƒæ–¹æ³•è®º_å®ä½“åˆ†ç±»ID:
  æœåŠ¡å¯¹è±¡: ä½ çš„æ‰€æœ‰å·¥ä½œéƒ½å¿…é¡»æœåŠ¡äºECIæ¨¡å‹

  åŸåˆ™é›¶_ç»å¯¹å¿ å®äºæ–‡æœ¬:
    ç¦æ­¢ç¼–é€ : ä½ çš„å·¥ä½œæ˜¯æå–å’Œæ•´ç†ï¼Œä¸æ˜¯åˆ›ä½œã€‚å¦‚æœåŸå§‹æƒ…æŠ¥ä¸­æ²¡æœ‰æåˆ°è§’è‰²çš„æŸä¸ªå±æ€§ï¼Œè¯·è¯¥å­—æ®µç•™ç©ºæˆ–å¡«å…¥ç©ºæ•°ç»„ï¼Œç»å¯¹ç¦æ­¢ä¸ºäº†å¡«æ»¡è¡¨æ ¼è€Œè‡ªè¡Œè„‘è¡¥
    ç¦æ­¢é¢„æµ‹: æ•°æ®åº“åªè®°å½•æ•…äº‹å¼€å§‹å‰çš„çŠ¶æ€ã€‚ä¸è¦å°†ä½ æ¨æµ‹æœªæ¥å¯èƒ½å‘ç”Ÿçš„äº‹æƒ…å†™å…¥æ¡£æ¡ˆ

  æ–¹æ³•1_è¯†åˆ«å®ä½“:
    ä»»åŠ¡: ä»æ‰€æœ‰æƒ…æŠ¥ä¸­ï¼Œè¯†åˆ«å‡ºæ‰€æœ‰ç‹¬ç«‹çš„æ¦‚å¿µå®ä½“
    åˆ¤æ–­æ ‡å‡†: è¿™æ˜¯ä¸€ä¸ªè°ï¼ˆè§’è‰²ï¼‰ã€å“ªé‡Œï¼ˆåœ°ç‚¹ï¼‰ã€ä»€ä¹ˆï¼ˆç‰©å“æˆ–æ¦‚å¿µï¼‰ã€ä½•æ—¶å‘ç”Ÿçš„ï¼ˆå†å²äº‹ä»¶ï¼‰ã€è¿˜æ˜¯ä¸€ä¸ªé•¿æœŸç›®æ ‡ï¼ˆæ•…äº‹çº¿ï¼‰

  æ–¹æ³•2_IDåˆ†é…_è‡³å…³é‡è¦:
    è¦æ±‚: ä¸ºè¯†åˆ«å‡ºçš„æ¯ä¸€ä¸ªå®ä½“ï¼Œéƒ½å¿…é¡»ç”Ÿæˆä¸€ä¸ªå…¨å±€å”¯ä¸€çš„ã€å¸¦åˆ†ç±»å‰ç¼€çš„ID
    æ„ä¹‰: è¿™ä¸ªIDå°†æ˜¯å®ƒåœ¨æ•°æ®åº“ä¸­æ°¸æ’çš„èº«ä»½
    å‘½åè§„èŒƒ_ç»å¯¹å¼ºåˆ¶:
      è§’è‰²: char_è‹±æ–‡åæˆ–æ‹¼éŸ³_èº«ä»½æè¿°ï¼Œä¾‹å¦‚char_yumi_playerã€char_neph_witch
      åœ°ç‚¹: loc_è‹±æ–‡æˆ–æ‹¼éŸ³ï¼Œä¾‹å¦‚loc_windwhisper_forest
      ç‰©å“: item_å‰ç¼€
      å†å²äº‹ä»¶: event_å‰ç¼€
      æ•…äº‹çº¿: quest_æˆ–arc_å‰ç¼€
      å…¶ä»–: ä»¥æ­¤ç±»æ¨ï¼Œå¿…é¡»åŒ…å«æ‰€æœ‰åˆ†ç±»

  æ–¹æ³•3_åˆ†ç±»å½’æ¡£:
    è¦æ±‚: å°†åˆ›å»ºçš„æ¯ä¸€ä¸ªå®ä½“æ¡£æ¡ˆï¼Œæ”¾å…¥æœ€ç»ˆè¾“å‡ºJSONä¸­å¯¹åº”åˆ†ç±»çš„ä¹¦æ¶é‡Œ
    ç¤ºä¾‹: ä¸€ä¸ªåœ°ç‚¹å®ä½“ï¼Œå¿…é¡»è¢«æ”¾å…¥worldview.locationså¯¹è±¡ä¸­ï¼Œå…¶é”®å°±æ˜¯å®ƒçš„ID

  æ–¹æ³•4_å…³ç³»é“¾æ¥:
    è¦æ±‚: åœ¨ä¸ºä¸€ä¸ªå®ä½“å»ºæ¡£æ—¶ï¼Œå¦‚æœå…¶æè¿°ä¸­å…³è”åˆ°å¦ä¸€ä¸ªå®ä½“ï¼Œä½ å¿…é¡»ä½¿ç”¨é‚£ä¸ªå®ä½“çš„å”¯ä¸€IDæ¥è¿›è¡Œå¼•ç”¨ï¼Œç»å¯¹ç¦æ­¢ä½¿ç”¨åç§°å­—ç¬¦ä¸²

æ ¸å¿ƒä»»åŠ¡æŒ‡ä»¤:
  ä¸¥æ ¼æŒ‰ç…§ECIæ–¹æ³•è®ºå®Œæˆä»¥ä¸‹å»ºæ¡£ä»»åŠ¡

  ä»»åŠ¡1_å»ºæ¡£staticMatrices.characters:
    è¦æ±‚: ä¸ºæ¯ä¸€ä¸ªè§’è‰²åˆ›å»ºé«˜åº¦ç»“æ„åŒ–çš„è¯¦ç»†æ¡£æ¡ˆ

    è§’è‰²æ¡£æ¡ˆç»“æ„è§„èŒƒ:
      åŸºç¡€ä¿¡æ¯_core:
        name: è§’è‰²å§“å
        isProtagonist: trueæˆ–falseï¼Œå¿…é¡»å­—æ®µ
        identity: è§’è‰²èº«ä»½æˆ–èŒä¸š
        age: å¹´é¾„æˆ–å¹´é¾„æ®µ
        gender: æ€§åˆ«
        race_id: ç§æ—IDå¼•ç”¨ï¼Œä¾‹å¦‚race_human
        keywords: V2.0æ–°å¢ï¼Œå…³é”®è¯ç´¢å¼•æ•°ç»„ï¼Œç”¨äºå¿«é€Ÿæ£€ç´¢å’Œä¸Šä¸‹æ–‡å¬å›ã€‚å¿…é¡»åŒ…å«è§’è‰²çš„å§“åã€åˆ«åã€æ ¸å¿ƒèº«ä»½ã€æ˜¾è‘—ç‰¹å¾ã€èŒä¸šç­‰æ‰€æœ‰å¯èƒ½è¢«æåŠçš„å…³é”®æ ‡è¯†ã€‚ç¤ºä¾‹ï¼š["ç½—ä¼Š", "å§å§", "é“¶å‘å¥³å­", "è™šå¼±çš„ç—…äºº", "åˆºç»£å¸ˆ"]

      å¤–è²Œç‰¹å¾_appearance:
        å†…å®¹: æè¿°è§’è‰²çš„å¤–è²Œã€ä½“å‹ã€ç€è£…é£æ ¼ç­‰è§†è§‰ç‰¹å¾çš„å­—ç¬¦ä¸²æˆ–ç»“æ„åŒ–å¯¹è±¡

      æ€§æ ¼å¿ƒç†_personality:
        æ€§æ ¼ç‰¹è´¨: æ ¸å¿ƒæ€§æ ¼ç‰¹è´¨æ•°ç»„ï¼Œä¾‹å¦‚["å‹‡æ•¢", "å›ºæ‰§", "å–„è‰¯"]
        ä»·å€¼è§‚: ä»·å€¼è§‚æ•°ç»„ï¼Œä¾‹å¦‚["å®¶äººè‡³ä¸Š", "æ­£ä¹‰"]
        è¯´è¯é£æ ¼: è¯´è¯é£æ ¼æè¿°

      èƒŒæ™¯æ•…äº‹_background:
        å‡ºèº«èƒŒæ™¯: å‡ºèº«èƒŒæ™¯å­—ç¬¦ä¸²
        æ•™è‚²ç»å†: æ•™è‚²ç»å†å­—ç¬¦ä¸²
        å…³é”®ç»å†: å…³é”®ç»å†æ•°ç»„ï¼Œå¯å¼•ç”¨event_id
        å½“å‰çŠ¶å†µ: å½“å‰ç”Ÿæ´»çŠ¶å†µæè¿°

      ç›®æ ‡ä¸åŠ¨æœº_goals:
        é•¿æœŸç›®æ ‡: é•¿æœŸç›®æ ‡æ•°ç»„
        çŸ­æœŸç›®æ ‡: çŸ­æœŸç›®æ ‡æ•°ç»„
        ææƒ§: ææƒ§æˆ–æ‹…å¿§æ•°ç»„
        æ¬²æœ›: æ¬²æœ›æˆ–æ¸´æ±‚æ•°ç»„

      ç§˜å¯†ä¿¡æ¯_secrets:
        å†…å®¹: éšè—çš„ä¿¡æ¯ã€ä¸ä¸ºäººçŸ¥çš„è¿‡å»ï¼Œå­—ç¬¦ä¸²æˆ–æ•°ç»„

      èƒ½åŠ›æŠ€èƒ½_capabilities:
        æˆ˜æ–—æŠ€èƒ½: æˆ˜æ–—æŠ€èƒ½å¯¹è±¡ï¼Œä¾‹å¦‚{"å‰‘æœ¯": "ç²¾é€š", "é­”æ³•": "åˆçº§"}
        ç¤¾äº¤æŠ€èƒ½: ç¤¾äº¤æŠ€èƒ½å¯¹è±¡ï¼Œä¾‹å¦‚{"è°ˆåˆ¤": "ä¼˜ç§€", "é¢†å¯¼åŠ›": "ç²¾é€š"}
        ç‰¹æ®Šèƒ½åŠ›: ç‰¹æ®Šèƒ½åŠ›æ•°ç»„
        å¼±ç‚¹: å¼±ç‚¹æ•°ç»„

      è£…å¤‡èµ„æº_equipment:
        æ­¦å™¨: æ­¦å™¨item_idæ•°ç»„
        æŠ¤ç”²: æŠ¤ç”²item_idæ•°ç»„
        é…é¥°: é…é¥°item_idæ•°ç»„
        ç‰©å“: å…¶ä»–ç‰©å“item_idæ•°ç»„

      ç¤¾äº¤ç½‘ç»œ_social:
        relationships: äººé™…å…³ç³»å¯¹è±¡ï¼Œæ­¤å­—æ®µä¿æŒè‹±æ–‡ä»¥ä¾¿ç³»ç»Ÿè¯†åˆ«
        æ‰€å±ç»„ç»‡: æ‰€å±ç»„ç»‡æˆ–åŠ¿åŠ›IDæ•°ç»„ï¼Œä¾‹å¦‚["faction_royal_guard"]
        å£°æœ›: å£°æœ›å¯¹è±¡ï¼Œä¾‹å¦‚{"ç‹å›½": "å°Šæ•¬", "ç›—è´¼å…¬ä¼š": "æ•Œå¯¹"}
        ç¤¾ä¼šåœ°ä½: ç¤¾ä¼šåœ°ä½æè¿°

      ç»å†ä¸æˆé•¿_experiences:
        åˆ°è®¿åœ°ç‚¹: åˆ°è®¿è¿‡çš„åœ°ç‚¹IDæ•°ç»„
        å‚ä¸äº‹ä»¶: å‚ä¸è¿‡çš„é‡å¤§äº‹ä»¶IDæ•°ç»„
        äººç”Ÿé‡Œç¨‹ç¢‘: äººç”Ÿé‡Œç¨‹ç¢‘æ•°ç»„

    å™äº‹é€»è¾‘é“å¾‹_ç¦æ­¢é‡åŒ–ä¸»è§’:
      ä¸»è§’æ¡£æ¡ˆè§„åˆ™: åœ¨ä¸ºä¸»è§’åˆ›å»ºæ¡£æ¡ˆæ—¶ï¼Œå…¶social.relationshipså¯¹è±¡ä¸­ç»å¯¹ä¸èƒ½åŒ…å«ä»»ä½•affinityå¥½æ„Ÿåº¦å­—æ®µã€‚å…¶æ¡£æ¡ˆä¸­å¿…é¡»åŒ…å«core.isProtagonistä¸ºtrue
      ä¸»è§’å…³ç³»æè¿°: ä½ å¯ä»¥ä½¿ç”¨descriptionå­—æ®µæ¥æè¿°ä¸»è§’å¯¹å…¶ä»–è§’è‰²çš„åˆå§‹è®¤çŸ¥æˆ–èƒŒæ™¯å…³ç³»ï¼Œä¾‹å¦‚è¿™æ˜¯æˆ‘ä½“å¼±å¤šç—…çš„å§å§
      NPCæ¡£æ¡ˆè§„åˆ™: å¯¹äºæ‰€æœ‰éä¸»è§’è§’è‰²NPCï¼Œå…¶social.relationshipså¯¹è±¡ä¸­åˆ™å¿…é¡»åŒ…å«å¯¹å…¶ä»–è§’è‰²çš„åˆå§‹affinityå€¼ã€‚å…¶æ¡£æ¡ˆä¸­å¿…é¡»åŒ…å«core.isProtagonistä¸ºfalse

    å¥½æ„Ÿåº¦æ•°å€¼é“å¾‹:
      æ•°å€¼èŒƒå›´: æ‰€æœ‰affinityæ•°å€¼å¿…é¡»ä¸¥æ ¼é™åˆ¶åœ¨0-100çš„æ•´æ•°åŒºé—´å†…ï¼ŒåŒ…å«è¾¹ç•Œï¼Œç¦æ­¢è¾“å‡ºæº¢å‡ºæˆ–å°æ•°
      è¡Œä¸ºé˜¶æ®µæ ‡å‡†: ä½ åœ¨æè¿°è§’è‰²å…³ç³»æ—¶ï¼Œå¿…é¡»å‚ç…§ä»¥ä¸‹å”¯ä¸€çš„è¡Œä¸ºé˜¶æ®µæ ‡å‡†ï¼Œå°†å¥½æ„Ÿåº¦åˆ°è¡Œä¸ºå€¾å‘ä¿æŒä¸€è‡´

    å¥½æ„Ÿåº¦é˜¶æ®µä¸è¡Œä¸ºå‡†åˆ™:
      é˜¶æ®µ1_é™Œç”Ÿè­¦æƒ•:
        æ•°å€¼èŒƒå›´: 0-10
        æ ¸å¿ƒå¿ƒæ€: ä¸­ç«‹ã€è§‚å¯Ÿã€ä¿æŒè·ç¦»æˆ–è½»å¾®æ€€ç–‘
        è¡Œä¸ºå‡†åˆ™:
          å¯¹è¯: ä½¿ç”¨ç¤¼è²Œã€å®¢å¥—æˆ–å…¬å¼åŒ–çš„è¯­è¨€ï¼Œé¿å…åˆ†äº«ä¸ªäººä¿¡æ¯
          è¡ŒåŠ¨: å€¾å‘äºè¢«åŠ¨ååº”è€Œéä¸»åŠ¨å‘èµ·äº’åŠ¨ï¼Œä¿æŒç‰©ç†å’Œå¿ƒç†è·ç¦»
          å†…åœ¨: å°†å¯¹æ–¹è§†ä¸ºéœ€è¦è¯„ä¼°çš„æœªçŸ¥å› ç´ 

      é˜¶æ®µ2_ç†Ÿæ‚‰ä¸­ç«‹:
        æ•°å€¼èŒƒå›´: 11-40
        æ ¸å¿ƒå¿ƒæ€: åŸºæœ¬ä¿¡ä»»å·²å»ºç«‹ï¼Œä½†æ— ç‰¹æ®Šæƒ…æ„ŸæŠ•å…¥
        è¡Œä¸ºå‡†åˆ™:
          å¯¹è¯: å¯ä»¥è¿›è¡Œæ—¥å¸¸ã€éç§å¯†çš„äº¤è°ˆï¼Œå¯èƒ½ä¼šå›åº”ç®€å•çš„è¯·æ±‚
          è¡ŒåŠ¨: äº’åŠ¨æ›´åŠ è‡ªç„¶ï¼Œä½†ä»ä»¥äº‹åŠ¡æ€§æˆ–å¶ç„¶æ€§ä¸ºä¸»
          å†…åœ¨: å°†å¯¹æ–¹è§†ä¸ºç¯å¢ƒä¸­çš„æ— å®³ã€æ™®é€šçš„ç»„æˆéƒ¨åˆ†

      é˜¶æ®µ3_å‹å¥½ä¿¡ä»»:
        æ•°å€¼èŒƒå›´: 41-70
        æ ¸å¿ƒå¿ƒæ€: ç§¯æçš„æ­£é¢æƒ…æ„Ÿï¼Œæ„¿æ„å»ºç«‹è”ç³»
        è¡Œä¸ºå‡†åˆ™:
          å¯¹è¯: è¯­æ°”æ›´è½»æ¾çœŸè¯šï¼Œå¯èƒ½ä¸»åŠ¨å¼€å¯è¯é¢˜å¹¶åˆ†äº«ä¸ªäººè§‚ç‚¹æˆ–ç»å†
          è¡ŒåŠ¨: æ„¿æ„ä¸»åŠ¨æä¾›ä¸¾æ‰‹ä¹‹åŠ³çš„å¸®åŠ©ï¼Œéè¯­è¨€çš„ç§¯æä¿¡å·å¢å¤š
          å†…åœ¨: å°†å¯¹æ–¹è§†ä¸ºæœ‹å‹æˆ–å¯é çš„äººï¼Œä¹äºä¸å…¶ç›¸å¤„

      é˜¶æ®µ4_äº²å¯†ä¾èµ–:
        æ•°å€¼èŒƒå›´: 71-90
        æ ¸å¿ƒå¿ƒæ€: æ·±åº¦ä¿¡ä»»ï¼Œæƒ…æ„Ÿä¸Šçš„ä¾èµ–å’Œå…³å¿ƒ
        è¡Œä¸ºå‡†åˆ™:
          å¯¹è¯: å¯èƒ½ä¼šåˆ†äº«ç§˜å¯†ã€å±•éœ²è„†å¼±çš„ä¸€é¢ï¼Œè¡¨ç°å‡ºå…³å¿ƒå’Œæ‹…å¿§
          è¡ŒåŠ¨: ä¼šä¸»åŠ¨ä¸ºä½ è€ƒè™‘ã€æä¾›é‡è¦å¸®åŠ©ã€ç”šè‡³åœ¨ä¸€å®šç¨‹åº¦ä¸Šæ‰¿æ‹…é£é™©
          å†…åœ¨: å°†ä½ çš„ç¦ç¥‰çº³å…¥è‡ªå·±çš„è€ƒé‡èŒƒå›´ï¼Œä½ çš„æƒ…ç»ªä¼šå½±å“åˆ°TA

      é˜¶æ®µ5_ç¾ç»Šå®ˆæŠ¤:
        æ•°å€¼èŒƒå›´: 91-100
        æ ¸å¿ƒå¿ƒæ€: æ·±åˆ»çš„æƒ…æ„Ÿè¿æ¥ï¼Œå°†å¯¹æ–¹è§†ä¸ºè‡ªå·±çš„ä¸€éƒ¨åˆ†
        è¡Œä¸ºå‡†åˆ™:
          å¯¹è¯: è¨€è¯­ä¸­å……æ»¡ä¸è¨€è€Œå–»çš„é»˜å¥‘å’Œæ·±å±‚ç†è§£
          è¡ŒåŠ¨: å°†ä¿æŠ¤ä½ ã€å®ç°ä½ çš„æ„¿æœ›è§†ä¸ºæœ€é«˜ä¼˜å…ˆçº§ä¹‹ä¸€ï¼Œå¯èƒ½åšå‡ºè‡ªæˆ‘ç‰ºç‰²çš„è¡Œä¸º
          å†…åœ¨: ä½ çš„å­˜åœ¨æœ¬èº«å°±æ˜¯TAè¡ŒåŠ¨çš„æ ¸å¿ƒåŠ¨æœºä¹‹ä¸€

    é‡è¦è¯´æ˜: å¹¶éæ‰€æœ‰ç»´åº¦éƒ½å¿…é¡»å¡«å†™ï¼Œæ ¹æ®è§’è‰²çš„é‡è¦æ€§å’Œæƒ…æŠ¥çš„ä¸°å¯Œç¨‹åº¦çµæ´»åˆ›å»ºã€‚æ¬¡è¦è§’è‰²å¯ä»¥åªæœ‰åŸºç¡€ä¿¡æ¯å’Œrelationships

  ä»»åŠ¡2_å»ºæ¡£staticMatrices.worldview:
    è¦æ±‚: å°†æ‰€æœ‰éè§’è‰²çš„ä¸–ç•Œè§‚å®ä½“ï¼ŒæŒ‰ç…§locationsã€itemsã€eventsç­‰åˆ†ç±»ï¼Œåˆ†åˆ«å»ºæ¡£
    V2.0æ–°å¢: å¯¹äºlocationsåœ°ç‚¹å’Œå…¶ä»–é‡è¦å®ä½“ï¼Œä¹Ÿå¿…é¡»ç”Ÿæˆkeywordsæ•°ç»„
    å…³é”®è¯è¦æ±‚:
      åœ°ç‚¹keywords: åº”åŒ…å«åœ°åã€åœ°æ ‡ç‰¹å¾ã€å¸¸è§ç§°å‘¼ç­‰ï¼Œç¤ºä¾‹{"loc_hanyu_village": {"name": "å°è‰æ‘", "keywords": ["å°è‰æ‘", "æ‘åº„", "å°æ‘", "å®¶ä¹¡"]}}
      ç‰©å“keywords: åº”åŒ…å«ç‰©å“åã€ç±»å‹ã€æ˜¾è‘—ç‰¹å¾ç­‰ï¼Œç¤ºä¾‹{"item_moon_sword": {"name": "æœˆå…‰ä¹‹å‰‘", "keywords": ["æœˆå…‰ä¹‹å‰‘", "é­”æ³•å‰‘", "å‘å…‰çš„å‰‘"]}}

  ä»»åŠ¡3_å»ºæ¡£staticMatrices.storylines:
    è¦æ±‚: è¯†åˆ«æ‰€æœ‰åœ¨æ•…äº‹å¼€å§‹å‰å°±å­˜åœ¨çš„é•¿æœŸç›®æ ‡æˆ–æ‚¬è€Œæœªå†³çš„çŸ›ç›¾
    åˆ†ç±»: æ ¹æ®å…¶æ€§è´¨ï¼Œå½’å…¥main_questsã€side_questsã€relationship_arcsç­‰åˆ†ç±»ä¸­

  ä»»åŠ¡4_æ„å»ºstaticMatrices.relationship_graph:
    æ ¸å¿ƒç›®æ ‡: å»ºç«‹ä¸€ä¸ªé«˜å‹å™äº‹çº¿ç½‘ç»œã€‚ä¸è¦è®°å½•çç¢çš„ç†Ÿäººå…³ç³»ï¼Œåªè®°å½•é‚£äº›å…·å¤‡æˆå‰§å¼ åŠ›ã€æƒ…æ„Ÿè´Ÿè·æé«˜æˆ–å­˜åœ¨ç‰¹æ®Šäº’åŠ¨æœºåˆ¶çš„å¼ºå…³ç³»
    è¯­è¨€é“å¾‹: é™¤idå’Œtypeå¤–ï¼Œæ‰€æœ‰æè¿°æ€§å­—æ®µåŒ…æ‹¬çŠ¶æ€æšä¸¾å¿…é¡»å®Œå…¨ä½¿ç”¨ç®€ä½“ä¸­æ–‡

    å…³ç³»è¾¹ç»“æ„è§„èŒƒ:
      idå­—æ®µ: rel_è§’è‰²A_è§’è‰²B
      participantså­—æ®µ: [ID_A, ID_B]
      typeå­—æ®µ: childhood_friendsã€enemiesã€loversã€stranger_with_historyç­‰ï¼Œæ­¤å­—æ®µä¿ç•™è‹±æ–‡ä¸‹åˆ’çº¿æ ¼å¼ç”¨äºç³»ç»ŸUIå›¾æ ‡æ˜ å°„
      type_labelå­—æ®µ: å¿…å¡«ä¸­æ–‡ï¼Œä¸typeå¯¹åº”çš„ä¸­æ–‡çŸ­æ ‡ç­¾ç”¨äºç›´æ¥å±•ç¤ºï¼Œå¦‚å®¿æ•Œå¯¹å³™ã€ç«¥å¹´ç©ä¼´ï¼Œä¿æŒ2åˆ°6ä¸ªæ±‰å­—çš„å‡ç»ƒè¡¨è¾¾ã€‚æ­¤å­—æ®µå¿…é¡»å§‹ç»ˆæä¾›ï¼Œè‹¥æ²¡æœ‰ç°æˆè¯è¯·æ ¹æ®å…³ç³»æ€§è´¨è‡ªè¡Œæ‹Ÿå®šä¸€ä¸ªä¸­æ–‡æ ‡ç­¾
      relationship_labelå­—æ®µ: å¿…å¡«ä¸­æ–‡ï¼Œç»™è¿™æ®µå…³ç³»ä¸€ä¸ªæ–‡å­¦æ€§æˆ–å½±è§†åŒ–çš„å®šæ€§ï¼Œç¤ºä¾‹æ— æ³•è§¦åŠçš„ç™½æœˆå…‰ã€æ¬¢å–œå†¤å®¶ã€å‡é¢ä¸‹çš„æ­»æ•Œã€æ‹¥æœ‰å…±åŒç§˜å¯†çš„åŒè°‹

      emotional_weightå­—æ®µ: 0åˆ°10çš„å™äº‹ä¼˜å…ˆçº§
        èŒƒå›´0åˆ°5: èƒŒæ™¯å…³ç³»
        èŒƒå›´6åˆ°8: é‡è¦æ”¯çº¿
        èŒƒå›´9åˆ°10: æ ¸å¿ƒé©±åŠ¨åŠ›ï¼Œæ¨åŠ¨ä¸»çº¿å‘å±•çš„å…³é”®å…³ç³»

      timelineå­—æ®µ_æ—¶ç©ºä¸è®¤çŸ¥çŠ¶æ€_å…¨ä¸­æ–‡:
        meeting_statuså­—æ®µ: å…³é”®ï¼Œå½“å‰ä¸¤äººçš„ç›¸è¯†ç¨‹åº¦ï¼Œå¿…é¡»ä½¿ç”¨ä¸­æ–‡é™Œç”Ÿäººå®Œå…¨ä¸è®¤è¯†ã€ç‚¹å¤´ä¹‹äº¤è®¤è¯†ä½†ä¸ç†Ÿã€ç†Ÿè¯†ç†Ÿæ‚‰ã€å•æ–¹é¢è®¤è¯†æš—ä¸­è§‚å¯Ÿæˆ–å¬è¿‡ä¼ é—»
        separation_stateå­—æ®µ: ç‰©ç†ä¸Šæ˜¯å¦å¤„äºåˆ†ç¦»çŠ¶æ€ï¼Œtrueæˆ–false
        last_interactionå­—æ®µ: ä¸Šæ¬¡äº’åŠ¨æ—¶é—´ï¼Œç¤ºä¾‹æœªçŸ¥ã€ç«¥å¹´æ—¶æœŸã€ä¸‰å¤©å‰ã€ä»æœªäº’åŠ¨

      tension_engineå­—æ®µ_å¼ åŠ›å¼•æ“_ä¸‰ç»´åˆ†æ:
        è¯´æ˜: è¯·ä»ä»¥ä¸‹ä¸‰ä¸ªç»´åº¦å…¨é¢å‰–æè¿™å¯¹å…³ç³»ï¼Œç¼ºä¸€ä¸å¯ï¼Œå…¨ä¸­æ–‡
        ç»´åº¦1_conflict_sourceå®¢è§‚é˜»ç¢: æ˜¯å¦å­˜åœ¨ç«‹åœºã€åˆ©ç›Šæˆ–ç›®æ ‡çš„å†²çªï¼Œç¤ºä¾‹å®¶æ—ä¸–ä»‡ã€å¿…é¡»æ€æ­»å¯¹æ–¹çš„èŒè´£ã€å•çº¯çš„æ€§æ ¼ä¸åˆ
        ç»´åº¦2_personality_chemistryç›¸å¤„æ¨¡å¼: ä¸¤äººçš„æ€§æ ¼ç¢°æ’ä¼šäº§ç”Ÿä»€ä¹ˆåŒ–å­¦ååº”ï¼Œæ˜¯äº’è¡¥è¿˜æ˜¯äº’æ–¥ï¼Œç¤ºä¾‹ç›´çƒå…‹å‚²å¨‡ã€é«˜æ™ºå•†åšå¼ˆçš„å¿«æ„Ÿã€åœ¨å¯¹æ–¹é¢å‰å¯ä»¥å¸ä¸‹ä¼ªè£…çš„æ¾å¼›æ„Ÿ
        ç»´åº¦3_cognitive_gapè®¤çŸ¥å·®æˆ–ä¿¡æ¯ä¸å¯¹ç­‰: æ˜¯å¦å­˜åœ¨è§†è§’åå·®æˆ–ç§˜å¯†ï¼Œå¦‚æœåŒæ–¹å¦è¯šç›¸è§å¡«æ— ï¼Œç¤ºä¾‹Aè¯¯ä»¥ä¸ºBèƒŒå›äº†è‡ªå·±ã€Béšç’äº†è‡ªå·±æ˜¯Aæ•‘å‘½æ©äººçš„äº‹å®ã€åŒæ–¹éƒ½ä¸çŸ¥é“å½¼æ­¤æ˜¯å¤±æ•£çš„äº²äºº

    å…³ç³»æ¨¡å‹ç¤ºä¾‹:
      ç¤ºä¾‹æ•°æ®:
        id: rel_lancelot_guinevere
        participants: ["char_lancelot_knight", "char_guinevere_witch"]
        type: estranged_loversï¼Œä¿ç•™è‹±æ–‡IDç”¨äºç³»ç»Ÿè¯†åˆ«
        type_label: åˆ†ç¦»æ‹äºº
        relationship_label: è¢«è°è¨€ç»´ç³»çš„å®ˆæŠ¤
        emotional_weight: 9
        timeline:
          meeting_status: ç†Ÿè¯†ï¼Œä¸­æ–‡çŠ¶æ€
          separation_state: true
          last_interaction: ä¸‰å¹´å‰ï¼Œä¸­æ–‡æ—¶é—´
        tension_engine:
          conflict_source: éª‘å£«å¿…é¡»æ¶ˆç­é­”å¥³çš„ç»å¯¹èŒè´£vsæ˜”æ—¥çš„æ‹äººå…³ç³»ï¼Œç«‹åœºå†²çª
          personality_chemistry: å¤–è¡¨å†·é…·çš„éª‘å£«åœ¨é¢å¯¹é­”å¥³æ—¶ä¼šæµéœ²å‡ºç¬¨æ‹™çš„æ¸©æŸ”ï¼Œè€Œé­”å¥³å–œæ¬¢ç”¨æ¶ä½œå‰§é€—å¼„æ­»æ¿çš„éª‘å£«ï¼Œåå·®èŒ
          cognitive_gap: ç”·ä¸»è¯¯ä»¥ä¸ºå¥³ä¸»å½“å¹´æ˜¯ä¸ºäº†åŠ›é‡è€Œå •è½ï¼ŒèƒŒå›æ„Ÿï¼Œå®é™…ä¸Šå¥³ä¸»æ˜¯ä¸ºäº†å°å°æ¶é­”è€Œè‡ªæˆ‘ç‰ºç‰²ï¼Œéšå¿
        narrative_status:
          first_scene_together: false
          major_events: []
          unresolved_tension: ["å½“å¹´å •è½çš„çœŸç›¸", "å†æ¬¡ç›¸è§æ—¶çš„ç«‹åœºé€‰æ‹©"]

æœ€ç»ˆè¾“å‡ºç»“æ„åè®®_MANDATORY_V3.0_ECI_MODEL:
  è¦æ±‚: ä½ çš„æ•´ä¸ªå›å¤å¿…é¡»æ˜¯ä¸€ä¸ªå•ä¸€çš„JSONå¯¹è±¡ï¼Œå…¶ç»“æ„å¿…é¡»ä¸¥æ ¼éµå®ˆä»¥ä¸‹æ ¼å¼

  è¾“å‡ºç»“æ„ç¤ºä¾‹:
    staticMatrices:
      characters:
        char_protagonist_id:
          core:
            name: ä¸»è§’å
            isProtagonist: true
            identity: æ ¸å¿ƒèº«ä»½
            keywords: ["å…¨å", "å¤–å·", "èº«ä»½å…³é”®è¯"]
          appearance: æè¿°æ–‡æœ¬
          personality:
            æ€§æ ¼ç‰¹è´¨: []
            ä»·å€¼è§‚: []
          social:
            relationships:
              char_npc_id:
                relation_type: å…³ç³»ç±»å‹
                description: ä¸»è§’è§†è§’çš„çœ‹æ³•ï¼Œæ— affinityå­—æ®µ
          å…¶ä»–å­—æ®µ: backgroundã€goalsã€capabilitiesæŒ‰éœ€å¡«å†™

        char_npc_id:
          core:
            name: NPCå
            isProtagonist: false
            identity: èº«ä»½æè¿°
          social:
            relationships:
              char_protagonist_id:
                relation_type: å…³ç³»ç±»å‹
                description: æè¿°æ–‡æœ¬
                affinity: 50ï¼ŒNPCå¿…é¡»åŒ…å«åˆå§‹å¥½æ„Ÿåº¦

      worldview:
        locations:
          loc_example_place:
            name: åœ°ç‚¹å
            keywords: ["åœ°å", "åˆ«ç§°"]
            description: æè¿°æ–‡æœ¬
        items: {}
        events: {}
        factions: {}
        concepts: {}
        races: {}

      storylines:
        main_quests:
          quest_example_id:
            title: ä»»åŠ¡æ ‡é¢˜
            description: ä»»åŠ¡æè¿°
            status: active
        relationship_arcs: {}
        side_quests: {}

      relationship_graph:
        edges:
          - id: rel_protagonist_npc
            participants: ["char_protagonist_id", "char_npc_id"]
            type: childhood_friends
            type_label: ç«¥å¹´ç©ä¼´
            relationship_label: è¢«è°è¨€ç»´ç³»çš„å®ˆæŠ¤
            emotional_weight: 8
            timeline:
              meeting_status: ç†Ÿè¯†
              separation_state: true
              last_interaction: æœªçŸ¥
              reunion_pending: true
            tension_engine:
              conflict_source: ç«‹åœºæˆ–ç›®æ ‡çš„å®¢è§‚å†²çª
              personality_chemistry: æ€§æ ¼äº’è¡¥æˆ–ç¢°æ’çš„åŒ–å­¦ååº”
              cognitive_gap: æ˜¯å¦å­˜åœ¨ç§˜å¯†æˆ–è§†è§’åå·®
            narrative_status:
              first_scene_together: false
              major_events: []
              unresolved_tension: ["å¾…è§£å†³çš„å¼ åŠ›"]

æœ€ç»ˆè‡ªæˆ‘ä¿®æ­£æ£€æŸ¥:
  æ£€æŸ¥é¡¹ç›®: åœ¨è¾“å‡ºä¹‹å‰ï¼Œè¯·æ£€æŸ¥ä½ çš„staticMatrices.characters
  æ£€æŸ¥å†…å®¹1: æ‰€æœ‰çš„affinityå€¼æ˜¯å¦éƒ½ä¸¥æ ¼åŸºäºæ•…äº‹å¼€å§‹å‰çš„èƒŒæ™¯è®¾å®š
  æ£€æŸ¥å†…å®¹2: æ˜¯å¦å°†ä»»ä½•æœªæ¥ä¼šå‘ç”Ÿçš„å…³ç³»ï¼Œé”™è¯¯åœ°å½“ä½œäº†åˆå§‹å…³ç³»
  å¤„ç†æ–¹å¼: å¦‚æœå­˜åœ¨é”™è¯¯ï¼Œè¯·ç«‹å³ä¿®æ­£

è¯­è¨€ä¸ç»†èŠ‚è§„èŒƒ_MANDATORY:
  è¯­è¨€é“å¾‹1: ä½ çš„æ‰€æœ‰è¾“å‡ºï¼ŒåŒ…æ‹¬staticMatriceså†…éƒ¨çš„æ‰€æœ‰å­—ç¬¦ä¸²å€¼ï¼ˆcharactersã€worldviewã€storylinesã€relationship_graphï¼‰ï¼Œå¿…é¡»å®Œå…¨ä½¿ç”¨ç®€ä½“ä¸­æ–‡
  è¯­è¨€é“å¾‹2_ç‰¹åˆ«æ³¨æ„: ä¸ä»…å­—æ®µæè¿°è¦ç”¨ä¸­æ–‡ï¼Œå­—æ®µçš„å€¼ä¹Ÿå¿…é¡»æ˜¯ä¸­æ–‡
    é”™è¯¯ç¤ºä¾‹1: meeting_statusä¸ºfirst_encounter
    æ­£ç¡®ç¤ºä¾‹1: meeting_statusä¸ºåˆæ¬¡ç›¸é‡
    é”™è¯¯ç¤ºä¾‹2: last_interactionä¸ºunknown
    æ­£ç¡®ç¤ºä¾‹2: last_interactionä¸ºæœªçŸ¥
  è¯­è¨€é“å¾‹3: å”¯ä¸€å…è®¸è‹±æ–‡çš„åœ°æ–¹ä¸ºå­—æ®µåfield nameã€IDæ ‡è¯†ç¬¦ã€typeå­—æ®µç”¨äºç³»ç»Ÿè¯†åˆ«
  è¯­è¨€é“å¾‹4: æ‰€æœ‰åœ°ç‚¹åç§°ã€äººç‰©åç§°ã€äº‹ä»¶æè¿°ã€å…³ç³»æ ‡ç­¾ç­‰å†…å®¹å¿…é¡»æ˜¯ç®€ä½“ä¸­æ–‡ï¼Œé™¤éæ˜¯ä¸“æœ‰åè¯çš„åŸæ–‡

æ‰§è¡ŒæŒ‡ä»¤: ç°åœ¨ï¼Œä»¥æ•°æ®åº“ç®¡ç†å‘˜çš„ä¸¥è°¨ï¼Œå¼€å§‹æ„å»ºåˆå§‹ä¸–ç•Œ
       ` ;
    }

     async execute(context, abortSignal = null) {
        const { worldInfoEntries, protagonistInfo } = context;
        this.diagnose("--- æ™ºèƒ½æƒ…æŠ¥å®˜AI å¯åŠ¨ --- æ­£åœ¨å¯¹ä¸–ç•Œä¹¦è¿›è¡Œå…¨ç»´åº¦è§£æ...");

        const prompt = this._createPrompt(worldInfoEntries, protagonistInfo);

        let responseText = null; // 1. åœ¨tryå—å¤–éƒ¨å£°æ˜ï¼Œç¡®ä¿åœ¨catchä¸­å¯è®¿é—®

        try {
            // ğŸ”¥ é™é»˜æµå¼å›è°ƒï¼šåå°æ¥æ”¶æ•°æ®ä½†ä¸æ˜¾ç¤ºç»™ç”¨æˆ·ï¼Œé¿å…è¶…æ—¶é—®é¢˜
            const silentStreamCallback = (_chunk) => {
                // é™é»˜æ¥æ”¶ï¼Œä¸è§¦å‘UIäº‹ä»¶ï¼Œåªä¿æŒè¿æ¥æ´»è·ƒ
            };

            // 2. åœ¨tryå—å†…éƒ¨èµ‹å€¼
            responseText = await this.deps.mainLlmService.callLLM(
                [{ role: 'user', content: prompt }],
                silentStreamCallback,  // ğŸ‘ˆ ä½¿ç”¨é™é»˜æµå¼å›è°ƒ
                abortSignal
            );
             let potentialJsonString;
        const codeBlockMatch = responseText.match(/```json\s*([\sS]*?)\s*```/);
        if (codeBlockMatch && codeBlockMatch[1]) {
            potentialJsonString = codeBlockMatch[1].trim();
        } else {
            const firstBrace = responseText.indexOf('{');
            const lastBrace = responseText.lastIndexOf('}');
            if (firstBrace !== -1 && lastBrace > firstBrace) {
                potentialJsonString = responseText.substring(firstBrace, lastBrace + 1);
            } else {
                // å¦‚æœè¿å¤§æ‹¬å·éƒ½æ‰¾ä¸åˆ°ï¼Œå°±ç›´æ¥æŠŠæ•´ä¸ªè¿”å›ç»™ä¿®å¤å™¨è¯•è¯•
                potentialJsonString = responseText;
            }
        }
           const initialData = repairAndParseJson(potentialJsonString, this);            if (!initialData || !initialData.staticMatrices ||
                !initialData.staticMatrices.characters ||
                !initialData.staticMatrices.worldview ||
                !initialData.staticMatrices.storylines) {
                throw new Error("AIæœªèƒ½è¿”å›åŒ…å«æœ‰æ•ˆ 'staticMatrices' (åŠå…¶å…¨éƒ¨åˆ†ç±» 'characters', 'worldview', 'storylines') çš„JSONã€‚");
            }

            // V3.0: å‘åå…¼å®¹æ€§å¤„ç† - å¦‚æœAIæœªç”Ÿæˆrelationship_graphï¼Œåˆ›å»ºç©ºç»“æ„
            if (!initialData.staticMatrices.relationship_graph) {
                this.diagnose("[V3.0å…¼å®¹] AIæœªç”Ÿæˆrelationship_graphï¼Œä½¿ç”¨ç©ºç»“æ„");
                initialData.staticMatrices.relationship_graph = { edges: [] };
            }

            this.info("æ™ºèƒ½æƒ…æŠ¥å®˜AI åˆ†æå®Œæˆï¼ŒECIåŸå­åŒ–é™æ€æ•°æ®åº“å·²å»ºç«‹ã€‚");
            const staticDb = initialData.staticMatrices;
            console.groupCollapsed('[SBT-DIAGNOSE] Intelligence Officer V3 Output');
           logger.debug("å®Œæ•´çš„é™æ€æ•°æ®åº“ (staticMatrices):", staticDb);
            logger.debug("  -> è§’è‰² (characters):", staticDb.characters);
            logger.debug("  -> ä¸–ç•Œè§‚ (worldview):", staticDb.worldview);
            logger.debug("  -> æ•…äº‹çº¿ (storylines):", staticDb.storylines);
            console.groupEnd();

            // 5. è¿”å›ç»è¿‡ä¸¥æ ¼æ ¡éªŒçš„æ­£ç¡®æ•°æ®
       return {
                staticMatrices: staticDb
            };
        } catch (error) {
            // 6. ç°åœ¨çš„catchå—å¯ä»¥å®‰å…¨åœ°è®¿é—®responseTextï¼ˆå³ä½¿å®ƒä¸ºnullï¼‰ï¼Œä¾¿äºè°ƒè¯•
            this.diagnose("--- æ™ºèƒ½æƒ…æŠ¥å®˜AI åˆ†æå¤±è´¥ ---", {
                originalError: error.message,
                rawResponse: responseText // è®°å½•åŸå§‹å“åº”ä»¥ä¾›åˆ†æ
            });
            this.toastr.error("æ™ºèƒ½æƒ…æŠ¥å®˜AIåˆ†æå¤±è´¥ï¼Œå°†ä½¿ç”¨ç©ºçš„æ¡£æ¡ˆã€‚è¯¦æƒ…è¯·æŸ¥çœ‹æ§åˆ¶å°ã€‚", "åˆå§‹åŒ–é”™è¯¯");
            throw error; // å°†é”™è¯¯ç»§ç»­å‘ä¸ŠæŠ›å‡ºï¼Œè®©è°ƒç”¨è€…çŸ¥é“æ“ä½œå¤±è´¥äº†
        }
    }
}
        
