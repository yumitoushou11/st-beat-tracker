# 前端可视功能指北（SBT 叙事流引擎）

> 适用范围：本说明基于当前仓库代码（2026-02-11），聚焦前端可视内容与可操作功能。

## 依据文件
- UI 结构：drawer-component.html
- UI 逻辑：ui/uiManager.js、ui/renderers.js
- 详情面板：ui/renderers/*
- 设置与模型：ui/settings/settingsUI.js
- 前端控制台：ui/ConsoleManager.js
- 弹窗组件：ui/SbtPopupConfirm.js、ui/simpleConfirm.js
- 创世纪世界书筛选：genesis-worldbook/*
- 引擎状态常量：src/constants.js
- 引擎总览参考：docs/storybeat-engine.md

## 程序总览（从入口到 UI）
- 插件入口：manifest.json 注册 index.js，SillyTavern APP_READY 后启动。
- 核心引擎：StoryBeatEngine.js 处理创世纪、章节转换、提示词注入、状态写回。
- UI 外壳：drawer-component.html + style.css，提供顶栏抽屉与各面板布局。
- UI 交互：ui/uiManager.js 绑定按钮、切换、编辑、保存等事件。
- 数据渲染：ui/renderers.js 将 Chapter 状态渲染为故事摘要、蓝图、档案卡片。
- 详情编辑：ui/renderers/characterModal.js、worldviewModal.js、storylineModal.js、relationshipModal.js。
- 创世纪资料源：genesis-worldbook/* 负责世界书筛选 UI 与数据管理。

## UI 入口与全局区域
- 顶栏指南针按钮：点击打开/关闭“叙事流引擎 - 控制室”抽屉。
- 控制室头部：显示引擎名称、章节锚点、引擎状态。
- 章节锚点：显示当前章节起始楼层索引，提示不要删除该楼层之后的消息。
- 引擎状态指示：图标 + 文本状态，状态来自 src/constants.js：
  - 空闲
  - 创世纪...
  - 同步状态...
  - 导演决策中...
  - 后台分析中...
  - 记忆固化中...
  - 规划新章节...
  - 章节转换中...
- 静态档案预编辑模式横幅：当 UI 进入静态缓存模式时显示，提示编辑将写入静态缓存。
- 标签导航：创作工坊、世界档案、叙事罗盘、控制台、设置。

---

# 一、创作工坊（Monitor Panel）

## 1) 回合裁判分析过程
- 面板默认隐藏，开启“显示回合裁判分析”后显示流式输出。
- 内容区：原始 JSON 流文本；底部状态条显示执行状态。
- 交互：折叠按钮可收起面板。

## 2) 故事摘要（可折叠）
- 故事梗概：长期剧情摘要，可点击编辑按钮直接修改。
- 章节衔接点：包含“结束快照”“下章起点”，可分别编辑。
- 编辑方式：弹出 prompt 输入后保存，并触发 UI 刷新。

## 3) 当前小章剧本（可折叠）
- 章节概览卡：标题、情感弧光、核心冲突、玩家补充（最高优先级）。
- 情节节拍列表：节拍类型、物理事件、环境状态、状态变更、退出条件等。
- 高光时刻设计：类型、目标节拍、设计意图。
- 终章信标：多条信标，支持直接编辑。
- 编辑方式：内容可编辑区域失焦即保存。
- 重roll 按钮：重新生成章节剧本（有蓝图时显示）。

## 4) 建筑师的设计笔记（可折叠）
- 主题块：玩家意志执行、基调锚定、多巴胺工程、沉浸流、逻辑与时空、事件优先级、结构与收尾、自我审查。
- 作用：展示建筑师对本章的策略与约束依据。

## 5) 叙事操作
- 创世纪开场白（可选）：手动输入开场白文本。
- 世界书筛选器：
  - 自动读取（角色绑定）/ 手动选择（精确控制）。
  - 手动模式下：
    - 世界书列表（刷新、搜索、勾选）。
    - 条目列表（刷新、搜索、全选/全不选、计数徽章）。
- 操作按钮：
  - 开始新的叙事篇章：启动创世纪流程。
  - 立即进行章节转换：强制结束当前章节并规划下一章（满足条件时显示）。

备注：
- 世界书筛选器由 genesis-worldbook/* 提供完整交互逻辑。
- “创世纪开场白”输入目前未在引擎流程中发现读取逻辑，若需生效请接入 Genesis 流程。

---

# 二、世界档案（Archive Panel）

## 1) 角色档案馆
- 角色卡片：头像图标、姓名、身份、年龄/性别、主角标识、隐藏标识。
- 操作：
  - 点击卡片打开详情。
  - 眼睛按钮切换“隐藏/显示”（隐藏后不被 AI 使用）。
  - 新建角色按钮。

### 角色详情（内嵌展开面板）
- 基本信息：名称、身份、年龄、性别、主角标识。
- 详细字段：外貌、性格、背景、目标、能力、装备、经历、秘密、归属与声望。
- 关系网络：
  - 主角视角：显示其他角色对主角的好感度与最新推理。
  - 非主角：显示该角色对他人的好感与推理。
- 编辑/保存/删除：支持新增与编辑模式。

## 2) 关系图谱
- 统计信息：关系总数、物理分离数量、待熟识数量。
- 关系卡片：参与者、关系标签、关系类型、时间线状态。
- 详情面板：
  - 情感权重（可输入或可视条）。
  - 时间线（相识程度、空间状态、最后互动）。
  - 张力引擎（冲突源、性格化学、认知差）。
  - 未解张力标签、重大事件列表。
- 操作：新建关系、编辑、保存、删除。

## 3) 世界观图书馆
- 分类折叠区：地点、物品、势力、概念、历史事件、种族。
- 列表项：名称、摘要/描述、隐藏标识。
- 操作：
  - 新建条目。
  - 编辑条目（详情面板）。
  - 隐藏/显示条目。

### 世界观详情（内嵌展开面板）
- 名称与详细描述（可编辑）。
- 编辑/保存/删除。

## 4) 故事线索引
- 分类折叠区：主线任务、支线任务、关系弧光、个人弧光。
- 故事线卡片：标题、状态、摘要、进度条、阶段、增量、本章推进、历史记录。
- 操作：新建、编辑、删除、隐藏/显示。

### 故事线详情（内嵌展开面板）
- 状态：进行中/已完成/已暂停/已失败。
- 初始摘要、当前进展、玩家意见补充（最高优先级）。
- 触发条件、涉及角色标签。
- 进展历史（可新增与编辑）。

---

# 三、叙事罗盘（Compass Panel）

## 引擎控制
- 启用叙事流引擎：总开关。
- 章节转换时询问焦点：控制是否弹出焦点选择弹窗。
- 开启回合裁判模式：启用/禁用回合裁判引导。
- 显示回合裁判分析：在创作工坊展示流式分析。
- 开启调试模式：控制控制台日志输出等级。
- 启用实体召回（测试）：让回合裁判输出实体 ID。
- 章节节拍数量区间：设置章节节拍数量范围。

## 高级操作
- 重新分析世界书：清除静态设定缓存并重分析（有确认弹窗）。

---

# 四、控制台（Console Panel）
- 过滤器：全部 / INFO / WARN / ERROR。
- 启用控制台：开启后记录日志。
- 清空：清空当前日志。
- 导出：导出为本地文本文件。
- 日志展示：时间戳、类型图标、消息、截断提示。

---

# 五、设置（Settings Panel）

## 核心大脑 AI（后台规划）
- API 提供商：SillyTavern 代理 / 直接调用 / SillyTavern 预设。
- 预设选择器（预设模式时显示）。
- API URL、API Key（可显示/隐藏）。
- 模型选择：刷新模型列表，或手动输入。
- 测试连接：测试核心大脑 API。

## 回合裁判 AI（快速响应）
- 结构与核心大脑一致：提供商、预设、URL、Key、模型、测试连接。

## 保存设置
- 保存并应用所有设置。
- 自动保存：输入框失焦/变更后自动保存。

## 提示词管理
- 建筑师提示词：查看、编辑、保存、导出、导入、恢复默认。
- 回合执导提示词：查看、编辑、保存、导出、导入、恢复默认。

## 数据库管理
- 静态缓存列表：按角色分组展示实体数量。
- 展开详情：显示角色/地点/物品/势力/概念/事件/种族的标签列表。
- 动态锚点：按聊天文件列出锚点，支持逐条删除。
- 操作按钮：刷新列表、导出当前角色、导入当前角色、清空全部数据。

---

# 六、弹窗与通知

## 叙事焦点弹窗（SbtPopupConfirm）
- 标题：“导演，请指示”
- 内容：输入下一章焦点、可选择“跳过（由 AI 决定）”“自由章模式”“ABC 沉浸流”。

## 史诗焦点弹窗
- 标题：“史诗的开端：定义你的传奇”
- 内容：输入故事核心主题或最终走向。

## 简单确认弹窗（simpleConfirm）
- 用于删除、清空等高风险操作。

## Toast 提示
- 各操作成功/失败提示（toastr）。
- 长流程期间出现“停止分析”按钮的 toast（世界书重分析/章节转换）。

---

# 七、待确认与潜在改进点

- 创世纪开场白输入目前未发现读取逻辑，建议补齐接入点。
- 叙事策略模式（正剧/网文）UI 已在 HTML 注释中移除，若需恢复请重启相关 UI 与绑定逻辑。

---

# 附：关键文件速查
- UI 结构：drawer-component.html
- UI 交互：ui/uiManager.js
- 主要渲染：ui/renderers.js
- 详情面板：ui/renderers/*.js
- 世界书筛选：genesis-worldbook/genesisSourceBindings.js
- 设置管理：ui/settings/settingsUI.js
- 前端控制台：ui/ConsoleManager.js
- 引擎常量：src/constants.js
