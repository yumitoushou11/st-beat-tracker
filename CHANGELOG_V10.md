# 回合裁判 V10.0 更新说明

## 更新时间
2025-12-07

## 核心改进

### 1. 新增：基调纠正系统 (Tone Correction System)

#### 功能描述
回合裁判现在能够检测剧情基调偏离，并向前台AI发出纠正指令。

#### 检测类型

##### 1.1 玩家抵触型偏离
- **检测场景**：剧本预期玩家应该【原谅/接受/同意】，但玩家实际表现出【抵触/拒绝/冷淡】
- **纠正策略**：提供两种方案供前台AI选择
  - 方案A：让NPC以更低姿态、更脆弱的方式再次请求
  - 方案B：让前台AI通过玩家的非语言信号（肢体语言）暗示态度松动

##### 1.2 NPC基调型偏离
- **检测场景**：剧本预期NPC应该表现【脆弱/温柔/试探】，但AI实际呈现为【威胁/强势/命令】
- **纠正策略**：明确指出基调错误，要求前台AI重新演绎该节拍

**示例**：
```
节拍5要求："青烛表现脆弱的占有欲（恳求、害怕失去）"
实际呈现："青烛显现龙形、堵住出口、宣告领地"
纠正指令："下回合必须重新演绎，改为伸手恳求、眼神哀伤、声音颤抖"
```

##### 1.3 情节跳跃型偏离
- **检测场景**：当前节拍尚未完整呈现（仅完成30%），但AI已经开始描写下一节拍
- **纠正策略**：强制回退到当前节拍，继续填充剩余内容

---

### 2. 强化：严格顺序验证 (Sequential Validation Protocol)

#### 核心原则
节拍推进必须像楼梯一样逐级攀登，**绝对禁止跳跃**。

#### 实现机制

##### 步骤1：回溯历史验证
- **不仅看最新对话**，必须回溯整个消息历史
- 从第0个节拍开始，逐个验证每个节拍是否在历史消息中**完整呈现**

##### 步骤2：识别"伪完成"陷阱
以下情况均视为节拍【未完成】，不得推进到下一节拍：
- ❌ AI仅仅"提到"了该事件，但没有展开描写
- ❌ AI刚刚开始描写该节拍的开场（核心互动还未发生）
- ❌ 玩家尚未对该节拍做出回应（Dialogue Scene类型必需）
- ❌ 该节拍的情感基调严重偏离

##### 步骤3：保守推进原则
- 找到**第一个未完成**或**正在进行中**的节拍
- 如果某个节拍刚开了个头（描写不足50%），保持在该节拍
- **有疑问时，倾向于"保持当前"而非"推进到下一节拍"**

---

## 技术实现

### 新增输出字段

```json
{
  "status": "CONTINUE",
  "current_beat_idx": 5,
  "narrative_hold": "严格禁止后续内容...",
  "tone_correction": "检测到基调偏离：...\n纠正方案A：...\n纠正方案B：...",
  "beat_completion_analysis": "节拍5已完成75%，核心情感尚未到位",
  "realtime_context_ids": []
}
```

#### 字段说明

| 字段 | 类型 | 说明 |
|------|------|------|
| `tone_correction` | string \| null | 基调纠正指令，null表示无需纠正 |
| `beat_completion_analysis` | string | 当前节拍的完成度分析 |

### 提示词注入层级

```
第0层（最高优先级）：⚠️ 基调纠正指令
第1层：🚫 剧透封锁禁令
第2层：硬编码执导规则
第3层：召回档案
第4层：关系指南
```

---

## 使用场景示例

### 场景1：你提供的案例

**剧本设定**：
- 节拍5："青烛情感爆发，表达脆弱的占有欲，向主角恳求和解"
- 节拍6："主角心软，主动拥抱青烛"

**实际执行**：
- AI输出：青烛显现龙形、堵住出口、命令式宣告"不该有第三个存在"
- 玩家回复："不需要"（冷淡拒绝）

**V10.0 纠正流程**：

1. **回合裁判检测**：
   ```json
   {
     "current_beat_idx": 5,
     "tone_correction": "检测到基调偏离：节拍5要求青烛表现'脆弱的占有欲'，但实际呈现为'威胁的占有欲'。\n强制纠正：下回合必须重新演绎节拍5，青烛应改为：伸手恳求、眼神哀伤、声音颤抖地说'别离开我'，而非显现龙形。\n同时检测到玩家抵触，提供方案A：让青烛以更低姿态再次请求；方案B：通过玩家的非语言信号暗示态度松动。"
   }
   ```

2. **前台AI收到纠正**：
   - 看到最高优先级的基调纠正指令
   - 选择方案A，重新演绎节拍5
   - 输出：青烛收起龙形，眼神中满是恐慌，声音颤抖地伸出手..."别离开我..."

3. **节拍推进控制**：
   - 即使玩家说"不需要"，回合裁判也会保持在节拍5
   - 直到情感基调正确且玩家态度松动后，才推进到节拍6

---

## 版本对比

| 功能 | V9.0 | V10.0 |
|------|------|-------|
| GPS定位 | ✅ | ✅ |
| 剧透封锁 | ✅ | ✅ |
| 基调检测 | ❌ | ✅ |
| 玩家抵触处理 | ❌ | ✅ |
| 严格顺序验证 | ⚠️ 弱检查 | ✅ 强验证 |
| 伪完成识别 | ❌ | ✅ |

---

## 注意事项

1. **基调纠正的触发条件**：
   - 仅在检测到明显偏离时触发
   - 不会对每个回合都产生纠正
   - null 值表示无需纠正

2. **与玩家自由的平衡**：
   - 方案B允许前台AI通过非语言信号"替玩家"松动态度
   - 但不会强制改变玩家的台词
   - 保持玩家控制权

3. **性能影响**：
   - 新增的检查逻辑由裁判AI执行
   - 不会增加前台AI的响应时间
   - 仅在检测到偏离时产生额外的警告日志

---

## 后续计划

### 可能的增强方向
1. 情感强度量化：为每个节拍标注情感强度（1-10），更精确地检测偏离
2. 历史偏离记录：追踪AI的偏离模式，动态调整纠正策略
3. 玩家偏好学习：记录玩家的接受阈值，个性化纠正方案

---

## 开发者
- **更新者**: Claude (Anthropic)
- **讨论参与**: yumi
- **测试环境**: SillyTavern + st-beat-tracker 扩展
